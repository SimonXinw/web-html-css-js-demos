<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>é‡‘ä»·æ•°æ®å›¾è¡¨ - æŠ˜çº¿å›¾ä¸æŸ±å½¢å›¾</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          "Helvetica Neue", Arial, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
        color: #333;
      }

      .container {
        max-width: 1400px;
        margin: 0 auto;
        background: #fff;
        border-radius: 20px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        overflow: hidden;
      }

      .header {
        background: linear-gradient(135deg, #4096ff 0%, #1677ff 100%);
        color: #fff;
        padding: 30px;
        text-align: center;
      }

      .header h1 {
        font-size: 2.5em;
        margin-bottom: 10px;
        font-weight: 600;
      }

      .header p {
        font-size: 1.1em;
        opacity: 0.8;
      }

      .main-content {
        display: grid;
        grid-template-columns: 350px 1fr;
        gap: 0;
        min-height: 700px;
      }

      .control-panel {
        padding: 30px;
        background: #f8f9fa;
        border-right: 1px solid #e9ecef;
      }

      .chart-container {
        padding: 30px;
        background: #fff;
      }

      .form-group {
        margin-bottom: 20px;
      }

      .form-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        color: #555;
        font-size: 14px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .form-group input,
      .form-group select {
        width: 100%;
        padding: 12px;
        border: 2px solid #e9ecef;
        border-radius: 8px;
        font-size: 14px;
        transition: all 0.3s ease;
        background: #fff;
      }

      .form-group input:focus,
      .form-group select:focus {
        outline: none;
        border-color: #dc143c;
        box-shadow: 0 0 0 3px rgba(220, 20, 60, 0.1);
      }

      .btn-primary {
        width: 100%;
        padding: 12px;
        background: linear-gradient(135deg, #4096ff  0%, #1677ff 100%);
        color: #fff;
        border: none;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 15px;
      }

      .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 16px rgba(220, 20, 60, 0.3);
      }

      .btn-primary:disabled {
        background: #ccc;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
      }

      .loading {
        display: none;
        text-align: center;
        padding: 15px;
        background: #fff3cd;
        border-radius: 8px;
        margin-bottom: 15px;
      }

      .loading.show {
        display: block;
      }

      .spinner {
        width: 30px;
        height: 30px;
        border: 3px solid #f3f3f3;
        border-top: 3px solid #dc143c;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto 10px;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }

        100% {
          transform: rotate(360deg);
        }
      }

      .chart-wrapper {
        width: 100%;
        height: 600px;
        border: 1px solid #e9ecef;
        border-radius: 10px;
        background: #fff;
      }

      .error {
        background: #ffebee;
        color: #c62828;
        padding: 12px;
        border-radius: 8px;
        border-left: 4px solid #f44336;
        margin-bottom: 15px;
        display: none;
        font-size: 14px;
      }

      .error.show {
        display: block;
      }

      .success {
        background: #e8f5e8;
        color: #2e7d32;
        padding: 12px;
        border-radius: 8px;
        border-left: 4px solid #4caf50;
        margin-bottom: 15px;
        display: none;
        font-size: 14px;
      }

      .success.show {
        display: block;
      }

      .chart-controls {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
        flex-wrap: wrap;
      }

      .chart-btn {
        padding: 8px 16px;
        background: #fff;
        border: 2px solid #e9ecef;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 12px;
        font-weight: 500;
      }

      .chart-btn.active {
        background: #dc143c;
        border-color: #dc143c;
        color: #fff;
      }

      .chart-btn:hover {
        border-color: #dc143c;
      }

      .stats-panel {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        gap: 15px;
        margin-bottom: 20px;
        padding: 20px;
        background: #f8f9fa;
        border-radius: 10px;
      }

      .stat-item {
        text-align: center;
        padding: 15px;
        background: #fff;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      .stat-value {
        font-size: 1.5em;
        font-weight: bold;
        color: #dc143c;
        margin-bottom: 5px;
      }

      .stat-label {
        font-size: 0.9em;
        color: #666;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .stat-item:nth-child(1) .stat-value {
        color: #333; /* å½“å‰ä»·æ ¼ - é»‘è‰² */
      }

      .stat-item:nth-child(2) .stat-value {
        color: #dc3545; /* æœ€é«˜ä»· - çº¢è‰² */
      }

      .stat-item:nth-child(3) .stat-value {
        color: #28a745; /* æœ€ä½ä»· - ç»¿è‰² */
      }

      .stat-item:nth-child(4) .stat-value {
        color: #333; /* å¹³å‡ä»· - é»‘è‰² */
      }

      /* å“åº”å¼è®¾è®¡ */
      @media (max-width: 1200px) {
        .main-content {
          grid-template-columns: 300px 1fr;
        }
      }

      @media (max-width: 768px) {
        body {
          padding: 10px;
        }

        .container {
          border-radius: 10px;
        }

        .header {
          padding: 20px;
        }

        .header h1 {
          font-size: 2em;
        }

        .main-content {
          grid-template-columns: 1fr;
        }

        .control-panel {
          border-right: none;
          border-bottom: 1px solid #e9ecef;
          padding: 20px;
        }

        .chart-container {
          padding: 20px;
        }

        .chart-wrapper {
          height: 400px;
        }

        .stats-panel {
          grid-template-columns: repeat(2, 1fr);
          gap: 10px;
          padding: 15px;
        }
      }

      @media (max-width: 480px) {
        .header h1 {
          font-size: 1.5em;
        }

        .control-panel,
        .chart-container {
          padding: 15px;
        }

        .chart-wrapper {
          height: 300px;
        }

        .stats-panel {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>

  <body>
    <div class="container">
      <div class="header">
        <h1>ğŸ“ˆ é‡‘ä»·æ•°æ®å›¾è¡¨åˆ†æ</h1>
        <p>å®æ—¶é‡‘ä»·èµ°åŠ¿ - åŸºäºæ—¶é—´åºåˆ—çš„æŠ˜çº¿å›¾å±•ç¤º</p>
      </div>

      <div class="main-content">
        <div class="control-panel">
          <form id="goldPriceForm">
            <div class="form-group">
              <label for="supabaseUrl">Supabase URL</label>
              <input
                type="url"
                id="supabaseUrl"
                value="https://lvsyycnybkwbrvvmshfb.supabase.co"
                placeholder="https://ä½ çš„é¡¹ç›®.supabase.co"
                required
              />
            </div>

            <div class="form-group">
              <label for="apiKey">API å¯†é’¥</label>
              <input
                type="text"
                id="apiKey"
                value="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx2c3l5Y255Ymt3YnJ2dm1zaGZiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcyNTU5NjMsImV4cCI6MjA3MjgzMTk2M30.Ot7-h6nbAhIkUOGoqAv8diUBW6-Llhh8MtA6bJMXbeA"
                placeholder="anon key"
                required
              />
            </div>

            <div class="form-group">
              <label for="tableName">æ•°æ®è¡¨å</label>
              <input
                type="text"
                id="tableName"
                value="gold_price"
                placeholder="gold_price"
                required
              />
            </div>

            <div class="form-group">
              <label for="limitRows">æ•°æ®è¡Œæ•°</label>
              <select id="limitRows">
                <option value="100">100</option>
                <option value="200">200</option>
                <option value="500">500</option>
                <option value="1000">1000</option>
                <option value="10000" selected>10000</option>
              </select>
            </div>

            <div class="form-group">
              <label for="orderBy">æ’åºå­—æ®µ</label>
              <select id="orderBy">
                <option value="created_at" selected>
                  created_at (åˆ›å»ºæ—¶é—´)
                </option>
                <option value="id">id (IDæ’åº)</option>
                <option value="time_period">time_period (æ—¶é—´å‘¨æœŸ)</option>
              </select>
            </div>

            <button type="submit" class="btn-primary" id="submitBtn">
              ğŸ”„ è·å–é‡‘ä»·æ•°æ®
            </button>
          </form>

          <div class="loading" id="loading">
            <div class="spinner"></div>
            <p>æ­£åœ¨è·å–é‡‘ä»·æ•°æ®...</p>
          </div>

          <div class="error" id="errorMsg"></div>
          <div class="success" id="successMsg"></div>

          <div class="chart-controls">
            <button class="chart-btn active" data-type="line">æŠ˜çº¿å›¾</button>
            <button class="chart-btn" data-type="area">é¢ç§¯å›¾</button>
            <button class="chart-btn" data-type="smooth">å¹³æ»‘æ›²çº¿</button>
          </div>

          <button
            type="button"
            class="btn-primary"
            onclick="loadDemoData()"
            style="margin-top: 10px"
          >
            ğŸ¯ åŠ è½½æ¼”ç¤ºæ•°æ®
          </button>
        </div>

        <div class="chart-container">
          <div class="stats-panel" id="statsPanel">
            <div class="stat-item">
              <div class="stat-value" id="currentPrice">--</div>
              <div class="stat-label">å½“å‰ä»·æ ¼</div>
            </div>
            <div class="stat-item">
              <div class="stat-value" id="highPrice">--</div>
              <div class="stat-label">æœ€é«˜ä»·</div>
            </div>
            <div class="stat-item">
              <div class="stat-value" id="lowPrice">--</div>
              <div class="stat-label">æœ€ä½ä»·</div>
            </div>
            <div class="stat-item">
              <div class="stat-value" id="avgPrice">--</div>
              <div class="stat-label">å¹³å‡ä»·</div>
            </div>
          </div>

          <div class="chart-wrapper" id="chartContainer"></div>
        </div>
      </div>
    </div>

    <script>
      // Supabase å®¢æˆ·ç«¯ç±» (å¤ç”¨åŸæœ‰é€»è¾‘)
      class SupabaseClient {
        constructor(url, apiKey) {
          this.url = url.replace(/\/$/, "");
          this.apiKey = apiKey;
          this.baseHeaders = {
            apikey: apiKey,
            Authorization: `Bearer ${apiKey}`,
            "Content-Type": "application/json",
          };
        }

        buildQueryUrl(tableName, options = {}) {
          const { limit, select, orderBy } = options;
          let url = `${this.url}/rest/v1/${tableName}`;
          const params = new URLSearchParams();

          if (select && select.trim()) {
            params.append("select", select.trim());
          }

          if (limit) {
            params.append("limit", limit);
          }

          if (orderBy && orderBy.trim()) {
            params.append("order", `${orderBy.trim()}`); // æ”¹ä¸ºå‡åºä»¥æ­£ç¡®æ˜¾ç¤ºæ—¶é—´åºåˆ—
          }

          const queryString = params.toString();
          return queryString ? `${url}?${queryString}` : url;
        }

        async fetchData(tableName, options = {}) {
          const url = this.buildQueryUrl(tableName, options);

          try {
            const response = await fetch(url, {
              method: "GET",
              headers: this.baseHeaders,
            });

            if (!response.ok) {
              const errorText = await response.text();
              throw new Error(`HTTP ${response.status}: ${errorText}`);
            }

            const data = await response.json();
            return {
              success: true,
              data,
              url,
              count: Array.isArray(data) ? data.length : 1,
            };
          } catch (error) {
            return {
              success: false,
              error: error.message,
              url,
            };
          }
        }
      }

      // é‡‘ä»·å›¾è¡¨æ§åˆ¶å™¨
      class GoldPriceChart {
        constructor() {
          this.chart = null;
          this.currentData = null;
          this.currentChartType = "line";

          this.form = document.getElementById("goldPriceForm");
          this.submitBtn = document.getElementById("submitBtn");
          this.loading = document.getElementById("loading");
          this.errorMsg = document.getElementById("errorMsg");
          this.successMsg = document.getElementById("successMsg");
          this.chartContainer = document.getElementById("chartContainer");

          this.initChart();
          this.bindEvents();

          // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨è¯·æ±‚æ•°æ®
          this.autoLoadData();
        }

        initChart() {
          this.chart = echarts.init(this.chartContainer);
          this.setDefaultOption();
        }

        setDefaultOption() {
          const option = {
            title: {
              text: "ç­‰å¾…æ•°æ®åŠ è½½...",
              left: "center",
              top: "middle",
              textStyle: {
                fontSize: 18,
                color: "#999",
              },
            },
            backgroundColor: "#fff",
          };
          this.chart.setOption(option);
        }

        bindEvents() {
          this.form.addEventListener("submit", this.handleSubmit.bind(this));

          // å›¾è¡¨ç±»å‹åˆ‡æ¢
          document.querySelectorAll(".chart-btn").forEach((btn) => {
            btn.addEventListener("click", (e) => {
              document
                .querySelectorAll(".chart-btn")
                .forEach((b) => b.classList.remove("active"));
              e.target.classList.add("active");
              this.currentChartType = e.target.dataset.type;
              if (this.currentData) {
                this.renderChart(this.currentData);
              }
            });
          });

          // å“åº”å¼å¤„ç†
          window.addEventListener("resize", () => {
            if (this.chart) {
              this.chart.resize();
            }
          });
        }

        async handleSubmit(e) {
          e.preventDefault();

          const config = {
            url: document.getElementById("supabaseUrl").value.trim(),
            apiKey: document.getElementById("apiKey").value.trim(),
            tableName: document.getElementById("tableName").value.trim(),
            limit: document.getElementById("limitRows").value,
            orderBy: document.getElementById("orderBy").value.trim(),
          };

          if (!this.validateConfig(config)) {
            return;
          }

          await this.fetchGoldPriceData(config);
        }

        validateConfig(config) {
          this.hideMessages();

          if (!config.url || !config.apiKey || !config.tableName) {
            this.showError("è¯·å¡«å†™æ‰€æœ‰å¿…å¡«å­—æ®µ");
            return false;
          }

          try {
            new URL(config.url);
          } catch {
            this.showError("è¯·è¾“å…¥æœ‰æ•ˆçš„ Supabase URL");
            return false;
          }

          if (config.apiKey.length < 50) {
            this.showError("API å¯†é’¥æ ¼å¼ä¸æ­£ç¡®");
            return false;
          }

          return true;
        }

        async fetchGoldPriceData(config) {
          this.setLoading(true);
          this.hideMessages();

          try {
            const client = new SupabaseClient(config.url, config.apiKey);

            const result = await client.fetchData(config.tableName, {
              limit: config.limit,
              orderBy: `${config.orderBy}.desc`,
            });

            if (result.success) {
              this.showSuccess(`æˆåŠŸè·å– ${result.count} æ¡é‡‘ä»·æ•°æ®`);

              this.currentData = result.data;

              this.renderChart(result.data);

              this.updateStats(result.data);
            } else {
              this.showError(`æ•°æ®è·å–å¤±è´¥: ${result.error}`);

              this.setDefaultOption();
            }
          } catch (error) {
            this.showError(`è¯·æ±‚å¼‚å¸¸: ${error.message}`);

            this.setDefaultOption();
          } finally {
            this.setLoading(false);
          }
        }

        renderChart(data) {
          if (!data || data.length === 0) {
            this.setDefaultOption();
            return;
          }

          const processedData = this.processChartData(data);
          const option = this.generateChartOption(processedData);
          this.chart.setOption(option, true);
        }

        processChartData(data) {
          // å¤„ç†æ•°æ®ï¼Œæ ¹æ®å®é™…è¡¨ç»“æ„æ˜ å°„å­—æ®µ
          return data
            .map((item) => {
              // ä½¿ç”¨æ–°çš„å­—æ®µåï¼šxau_price, sh_price, ny_price
              const xauPrice = parseFloat(item.xau_price) || 0; // ä¼¦æ•¦ç°è´§é‡‘ä»·
              const shPrice = parseFloat(item.sh_price) || 0; // æ²ªé‡‘ç°è´§ä»·æ ¼
              const nyPrice = parseFloat(item.ny_price) || 0; // çº½çº¦æœŸè´§é‡‘ä»·

              // ä½¿ç”¨ created_at ä½œä¸ºæ—¶é—´è½´
              const dateValue = item.created_at || new Date().toISOString();

              return {
                date: this.formatDateTime(dateValue), // ä¿ç•™æ—¶é—´ä¿¡æ¯
                xauPrice: xauPrice, // ä¼¦æ•¦ç°è´§é‡‘ä»·
                shPrice: shPrice, // æ²ªé‡‘ç°è´§ä»·æ ¼  
                nyPrice: nyPrice, // çº½çº¦æœŸè´§é‡‘ä»·
                currency: item.currency || "USD", // é»˜è®¤USD
                source: item.source || "ä¸œæ–¹è´¢å¯Œ", // é»˜è®¤ä¸œæ–¹è´¢å¯Œ
                id: item.id,
                originalData: item, // ä¿ç•™åŸå§‹æ•°æ®ç”¨äºè°ƒè¯•
              };
            })
            .sort((a, b) => new Date(a.date) - new Date(b.date)); // æŒ‰æ—¶é—´æ’åº
        }

        formatDate(dateStr) {
          try {
            const date = new Date(dateStr);
            return date.toISOString().split("T")[0]; // YYYY-MM-DD æ ¼å¼
          } catch {
            return dateStr;
          }
        }

        formatDateTime(dateStr) {
          try {
            const date = new Date(dateStr);
            // è¿”å›æ›´è¯¦ç»†çš„æ—¶é—´æ ¼å¼ï¼Œç”¨äºæ—¶é—´åºåˆ—
            return date.toLocaleString("zh-CN", {
              year: "numeric",
              month: "2-digit",
              day: "2-digit",
              hour: "2-digit",
              minute: "2-digit",
            });
          } catch {
            return dateStr;
          }
        }

        generateChartOption(data) {
          const dates = data.map((item) => item.date);
          const xauPrices = data.map((item) => item.xauPrice);
          const shPrices = data.map((item) => item.shPrice);
          const nyPrices = data.map((item) => item.nyPrice);
          const currency = data[0]?.currency || "USD";

          // è·å–æ‰€æœ‰ä»·æ ¼ç”¨äºè®¡ç®—Yè½´èŒƒå›´
          const allPrices = [...xauPrices, ...shPrices, ...nyPrices].filter(p => p > 0);
          
          // åŠ¨æ€è®¡ç®—Yè½´èŒƒå›´
          const minPrice = Math.min(...allPrices);
          const maxPrice = Math.max(...allPrices);
          const yAxisMin = Math.max(0, minPrice - 50); // ç¡®ä¿ä¸å°äº0
          const yAxisMax = maxPrice + 50;

          console.log(
            `ä»·æ ¼èŒƒå›´: ${minPrice.toFixed(2)} - ${maxPrice.toFixed(2)}`
          );
          console.log(
            `Yè½´èŒƒå›´: ${yAxisMin.toFixed(2)} - ${yAxisMax.toFixed(2)}`
          );

          const baseOption = {
            backgroundColor: "#fff",
            title: {
              text: `å…¨çƒé‡‘ä»·èµ°åŠ¿å¯¹æ¯”å›¾ (${currency})`,
              left: "center",
              textStyle: {
                fontSize: 16,
                fontWeight: "bold",
                color: "#333",
              },
            },
            tooltip: {
              trigger: "axis",
              axisPointer: {
                type: "cross",
                crossStyle: {
                  color: "#999",
                },
              },
              formatter: function (params) {
                let result = `<strong>${params[0].axisValue}</strong><br/>`;
                
                // æ˜¾ç¤ºæ‰€æœ‰ç³»åˆ—çš„æ•°æ®
                params.forEach(param => {
                  if (param.value > 0) { // åªæ˜¾ç¤ºæœ‰æ•ˆä»·æ ¼
                    result += `${param.marker}${param.seriesName}: ${param.value} ${currency}<br/>`;
                  }
                });

                // æ˜¾ç¤ºæ•°æ®æ¥æºä¿¡æ¯
                const dataIndex = params[0].dataIndex;
                const originalData = data[dataIndex]?.originalData;
                if (originalData?.source) {
                  result += `<br/><span style="color: #666;">æ•°æ®æ¥æº: ${originalData.source}</span>`;
                }
                return result;
              },
            },
            legend: {
              data: ["çº½çº¦æœŸè´§é‡‘ä»·", "ä¼¦æ•¦ç°è´§é‡‘ä»·", "æ²ªé‡‘ç°è´§ä»·æ ¼"],
              top: 30,
            },
            xAxis: {
              type: "category",
              data: dates,
              axisPointer: {
                type: "line",
              },
              axisLabel: {
                rotate: 45,
                interval: Math.max(0, Math.floor(dates.length / 8)),
                fontSize: 11,
              },
            },
            yAxis: {
              type: "value",
              name: `é‡‘ä»· (${currency})`,
              min: yAxisMin, // åŠ¨æ€è®¡ç®—çš„æœ€å°å€¼
              max: yAxisMax, // åŠ¨æ€è®¡ç®—çš„æœ€å¤§å€¼
              axisLabel: {
                formatter: "{value}",
              },
              splitLine: {
                show: true,
                lineStyle: {
                  color: "#f0f0f0",
                },
              },
            },
            grid: {
              left: "10%",
              right: "5%",
              bottom: "15%",
              top: "15%",
            },
            dataZoom: [
              {
                type: "inside",
                start: 0,
                end: 100,
              },
              {
                start: 0,
                end: 100,
                height: 30,
                bottom: 30,
              },
            ],
          };

          // æ ¹æ®å›¾è¡¨ç±»å‹ç”Ÿæˆä¸åŒçš„ç³»åˆ—
          const series = [];
          
          // çº½çº¦æœŸè´§é‡‘ä»·ç³»åˆ—
          if (nyPrices.some(p => p > 0)) {
            series.push({
              name: "çº½çº¦æœŸè´§é‡‘ä»·",
              type: "line",
              data: nyPrices,
              smooth: this.currentChartType === "smooth",
              symbol: "circle",
              symbolSize: 4,
              lineStyle: {
                color: "#DC143C", // çº¢è‰²
                width: 2,
              },
              itemStyle: {
                color: "#DC143C",
                borderColor: "#fff",
                borderWidth: 1,
              },
              ...(this.currentChartType === "area" || this.currentChartType === "smooth" ? {
                areaStyle: {
                  color: {
                    type: "linear",
                    x: 0, y: 0, x2: 0, y2: 1,
                    colorStops: [
                      { offset: 0, color: "rgba(220, 20, 60, 0.3)" },
                      { offset: 1, color: "rgba(220, 20, 60, 0.05)" },
                    ],
                  },
                }
              } : {})
            });
          }
          
          // ä¼¦æ•¦ç°è´§é‡‘ä»·ç³»åˆ—
          if (xauPrices.some(p => p > 0)) {
            series.push({
              name: "ä¼¦æ•¦ç°è´§é‡‘ä»·",
              type: "line",
              data: xauPrices,
              smooth: this.currentChartType === "smooth",
              symbol: "circle",
              symbolSize: 4,
              lineStyle: {
                color: "#FFD700", // é‡‘è‰²
                width: 2,
              },
              itemStyle: {
                color: "#FFD700",
                borderColor: "#fff",
                borderWidth: 1,
              },
              ...(this.currentChartType === "area" || this.currentChartType === "smooth" ? {
                areaStyle: {
                  color: {
                    type: "linear",
                    x: 0, y: 0, x2: 0, y2: 1,
                    colorStops: [
                      { offset: 0, color: "rgba(255, 215, 0, 0.3)" },
                      { offset: 1, color: "rgba(255, 215, 0, 0.05)" },
                    ],
                  },
                }
              } : {})
            });
          }
          
          // æ²ªé‡‘ç°è´§ä»·æ ¼ç³»åˆ—
          if (shPrices.some(p => p > 0)) {
            series.push({
              name: "æ²ªé‡‘ç°è´§ä»·æ ¼",
              type: "line",
              data: shPrices,
              smooth: this.currentChartType === "smooth",
              symbol: "circle",
              symbolSize: 4,
              lineStyle: {
                color: "#1E90FF", // è“è‰²
                width: 2,
              },
              itemStyle: {
                color: "#1E90FF",
                borderColor: "#fff",
                borderWidth: 1,
              },
              ...(this.currentChartType === "area" || this.currentChartType === "smooth" ? {
                areaStyle: {
                  color: {
                    type: "linear",
                    x: 0, y: 0, x2: 0, y2: 1,
                    colorStops: [
                      { offset: 0, color: "rgba(30, 144, 255, 0.3)" },
                      { offset: 1, color: "rgba(30, 144, 255, 0.05)" },
                    ],
                  },
                }
              } : {})
            });
          }
          
          baseOption.series = series;

          return baseOption;
        }

        updateStats(data) {
          if (!data || data.length === 0) return;

          // è·å–ä¸‰ä¸ªä»·æ ¼æ•°ç»„
          const xauPrices = data.map((item) => parseFloat(item.xauPrice) || 0).filter(p => p > 0);
          const shPrices = data.map((item) => parseFloat(item.shPrice) || 0).filter(p => p > 0);
          const nyPrices = data.map((item) => parseFloat(item.nyPrice) || 0).filter(p => p > 0);
          const currency = data[0]?.currency || "USD";

          // è®¡ç®—å„è‡ªçš„ç»Ÿè®¡ä¿¡æ¯
          const stats = {
            ny: this.calculatePriceStats(nyPrices, "çº½çº¦æœŸè´§"),
            xau: this.calculatePriceStats(xauPrices, "ä¼¦æ•¦ç°è´§"),
            sh: this.calculatePriceStats(shPrices, "æ²ªé‡‘ç°è´§")
          };

          // æ›´æ–°æ˜¾ç¤º - æ˜¾ç¤ºæœ€æ–°çš„æœ‰æ•ˆä»·æ ¼
          const latestData = data[data.length - 1];
          
          document.getElementById("currentPrice").innerHTML = `
            <div style="font-size: 0.8em; margin-bottom: 5px;">
              NY: ${latestData.nyPrice || '--'}<br/>
              XAU: ${latestData.xauPrice || '--'}<br/>
              SH: ${latestData.shPrice || '--'}
            </div>
          `;
          
          // æ˜¾ç¤ºå…¨å±€æœ€é«˜ä»·
          const allPrices = [...xauPrices, ...shPrices, ...nyPrices];
          const globalHigh = allPrices.length > 0 ? Math.max(...allPrices) : 0;
          const globalLow = allPrices.length > 0 ? Math.min(...allPrices) : 0;
          const globalAvg = allPrices.length > 0 ? allPrices.reduce((sum, price) => sum + price, 0) / allPrices.length : 0;

          document.getElementById("highPrice").textContent = `${globalHigh.toFixed(2)} ${currency}`;
          document.getElementById("lowPrice").textContent = `${globalLow.toFixed(2)} ${currency}`;
          document.getElementById("avgPrice").textContent = `${globalAvg.toFixed(2)} ${currency}`;

          // åœ¨æ§åˆ¶å°è¾“å‡ºæ•°æ®æºä¿¡æ¯
          const sources = [...new Set(data.map((item) => item.source))];
          console.log(`æ•°æ®æ¥æº: ${sources.join(", ")}`);
          console.log(`æ•°æ®æ¡æ•°: ${data.length}`);
          console.log(`çº½çº¦æœŸè´§æœ‰æ•ˆæ•°æ®: ${nyPrices.length}æ¡`);
          console.log(`ä¼¦æ•¦ç°è´§æœ‰æ•ˆæ•°æ®: ${xauPrices.length}æ¡`);
          console.log(`æ²ªé‡‘ç°è´§æœ‰æ•ˆæ•°æ®: ${shPrices.length}æ¡`);
          console.log(`æ—¶é—´èŒƒå›´: ${data[0]?.date} è‡³ ${data[data.length - 1]?.date}`);
        }

        calculatePriceStats(prices, name) {
          if (prices.length === 0) return { current: 0, high: 0, low: 0, avg: 0 };
          
          return {
            current: prices[prices.length - 1],
            high: Math.max(...prices),
            low: Math.min(...prices),
            avg: prices.reduce((sum, price) => sum + price, 0) / prices.length
          };
        }

        setLoading(isLoading) {
          this.submitBtn.disabled = isLoading;
          this.loading.classList.toggle("show", isLoading);
          this.submitBtn.textContent = isLoading
            ? "ğŸ”„ è·å–æ•°æ®ä¸­..."
            : "ğŸ”„ è·å–é‡‘ä»·æ•°æ®";
        }

        showError(message) {
          this.errorMsg.textContent = message;
          this.errorMsg.classList.add("show");
          this.successMsg.classList.remove("show");
        }

        showSuccess(message) {
          this.successMsg.textContent = message;
          this.successMsg.classList.add("show");
          this.errorMsg.classList.remove("show");
        }

        hideMessages() {
          this.errorMsg.classList.remove("show");
          this.successMsg.classList.remove("show");
        }

        // è‡ªåŠ¨åŠ è½½æ•°æ®
        autoLoadData() {
          // å»¶è¿Ÿ500msæ‰§è¡Œï¼Œç¡®ä¿é¡µé¢å®Œå…¨åŠ è½½
          setTimeout(() => {
            const config = {
              url: document.getElementById("supabaseUrl").value.trim(),
              apiKey: document.getElementById("apiKey").value.trim(),
              tableName: document.getElementById("tableName").value.trim(),
              limit: document.getElementById("limitRows").value,
              orderBy: document.getElementById("orderBy").value.trim(),
            };

            // æ£€æŸ¥é…ç½®æ˜¯å¦å®Œæ•´
            if (config.url && config.apiKey && config.tableName) {
              console.log("é¡µé¢åŠ è½½å®Œæˆï¼Œè‡ªåŠ¨è¯·æ±‚é‡‘ä»·æ•°æ®...");
              this.fetchGoldPriceData(config);
            } else {
              console.log("é…ç½®ä¸å®Œæ•´ï¼Œè·³è¿‡è‡ªåŠ¨è¯·æ±‚");
              this.showError("è¯·æ£€æŸ¥Supabaseé…ç½®ä¿¡æ¯");
            }
          }, 500);
        }
      }

      // åˆå§‹åŒ–åº”ç”¨
      document.addEventListener("DOMContentLoaded", () => {
        new GoldPriceChart();
      });

      // æ·»åŠ ä¸€äº›æ¨¡æ‹Ÿæ•°æ®åŠŸèƒ½ï¼ˆç”¨äºæ¼”ç¤ºï¼‰
      window.loadDemoData = function () {
        const chart = window.goldPriceChart || new GoldPriceChart();

                  // ç”Ÿæˆ30å¤©çš„æ¨¡æ‹Ÿé‡‘ä»·æ•°æ®
          const demoData = [];
          const startDate = new Date();
          startDate.setDate(startDate.getDate() - 30);

          for (let i = 0; i < 30; i++) {
            const date = new Date(startDate);
            date.setDate(date.getDate() + i);

            const basePrice = 2000 + Math.sin(i / 5) * 100; // åŸºç¡€ä»·æ ¼æ³¢åŠ¨
            const randomFactor = (Math.random() - 0.5) * 50; // éšæœºæ³¢åŠ¨

            // ç”Ÿæˆä¸‰ä¸ªä¸åŒçš„ä»·æ ¼
            const nyPrice = Math.max(1800, basePrice + randomFactor);
            const xauPrice = Math.max(1800, nyPrice + (Math.random() - 0.5) * 30); // ä¼¦æ•¦ä»·æ ¼ç•¥æœ‰å·®å¼‚
            const shPrice = Math.max(400, (nyPrice / 7.2) + (Math.random() - 0.5) * 20); // æ²ªé‡‘ä»·æ ¼ï¼ˆäººæ°‘å¸ï¼‰

            demoData.push({
              id: i + 1,
              created_at: date.toISOString(),
              time_period: "realtime",
              price: null, // ä¿æŒå…¼å®¹æ€§
              source: "ä¸œæ–¹è´¢å¯Œ",
              currency: "USD",
              xau_price: xauPrice,
              sh_price: shPrice,
              ny_price: nyPrice
            });
          }

        chart.currentData = demoData;
        chart.renderChart(demoData);
        chart.updateStats(demoData);
        chart.showSuccess(`åŠ è½½äº† ${demoData.length} æ¡æ¼”ç¤ºæ•°æ®`);
      };
    </script>
  </body>
</html>
