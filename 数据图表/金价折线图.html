<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>金价数据图表 - 折线图与柱形图</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          "Helvetica Neue", Arial, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
        color: #333;
      }

      .container {
        max-width: 1400px;
        margin: 0 auto;
        background: #fff;
        border-radius: 20px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        overflow: hidden;
      }

      .header {
        background: linear-gradient(135deg, #4096ff 0%, #1677ff 100%);
        color: #fff;
        padding: 30px;
        text-align: center;
      }

      .header h1 {
        font-size: 2.5em;
        margin-bottom: 10px;
        font-weight: 600;
      }

      .header p {
        font-size: 1.1em;
        opacity: 0.8;
      }

      .main-content {
        display: grid;
        grid-template-columns: 350px 1fr;
        gap: 0;
        min-height: 700px;
      }

      .control-panel {
        padding: 30px;
        background: #f8f9fa;
        border-right: 1px solid #e9ecef;
      }

      .chart-container {
        padding: 30px;
        background: #fff;
      }

      .form-group {
        margin-bottom: 20px;
      }

      .form-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        color: #555;
        font-size: 14px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .form-group input,
      .form-group select {
        width: 100%;
        padding: 12px;
        border: 2px solid #e9ecef;
        border-radius: 8px;
        font-size: 14px;
        transition: all 0.3s ease;
        background: #fff;
      }

      .form-group input:focus,
      .form-group select:focus {
        outline: none;
        border-color: #dc143c;
        box-shadow: 0 0 0 3px rgba(220, 20, 60, 0.1);
      }

      .btn-primary {
        width: 100%;
        padding: 12px;
        background: linear-gradient(135deg, #4096ff  0%, #1677ff 100%);
        color: #fff;
        border: none;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 15px;
      }

      .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 16px rgba(220, 20, 60, 0.3);
      }

      .btn-primary:disabled {
        background: #ccc;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
      }

      .loading {
        display: none;
        text-align: center;
        padding: 15px;
        background: #fff3cd;
        border-radius: 8px;
        margin-bottom: 15px;
      }

      .loading.show {
        display: block;
      }

      .spinner {
        width: 30px;
        height: 30px;
        border: 3px solid #f3f3f3;
        border-top: 3px solid #dc143c;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto 10px;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }

        100% {
          transform: rotate(360deg);
        }
      }

      .chart-wrapper {
        width: 100%;
        height: 600px;
        border: 1px solid #e9ecef;
        border-radius: 10px;
        background: #fff;
      }

      .error {
        background: #ffebee;
        color: #c62828;
        padding: 12px;
        border-radius: 8px;
        border-left: 4px solid #f44336;
        margin-bottom: 15px;
        display: none;
        font-size: 14px;
      }

      .error.show {
        display: block;
      }

      .success {
        background: #e8f5e8;
        color: #2e7d32;
        padding: 12px;
        border-radius: 8px;
        border-left: 4px solid #4caf50;
        margin-bottom: 15px;
        display: none;
        font-size: 14px;
      }

      .success.show {
        display: block;
      }

      .chart-controls {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
        flex-wrap: wrap;
      }

      .chart-btn {
        padding: 8px 16px;
        background: #fff;
        border: 2px solid #e9ecef;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 12px;
        font-weight: 500;
      }

      .chart-btn.active {
        background: #dc143c;
        border-color: #dc143c;
        color: #fff;
      }

      .chart-btn:hover {
        border-color: #dc143c;
      }

      .stats-panel {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        gap: 15px;
        margin-bottom: 20px;
        padding: 20px;
        background: #f8f9fa;
        border-radius: 10px;
      }

      .stat-item {
        text-align: center;
        padding: 15px;
        background: #fff;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      .stat-value {
        font-size: 1.5em;
        font-weight: bold;
        color: #dc143c;
        margin-bottom: 5px;
      }

      .stat-label {
        font-size: 0.9em;
        color: #666;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .stat-item:nth-child(1) .stat-value {
        color: #333; /* 当前价格 - 黑色 */
      }

      .stat-item:nth-child(2) .stat-value {
        color: #dc3545; /* 最高价 - 红色 */
      }

      .stat-item:nth-child(3) .stat-value {
        color: #28a745; /* 最低价 - 绿色 */
      }

      .stat-item:nth-child(4) .stat-value {
        color: #333; /* 平均价 - 黑色 */
      }

      /* 响应式设计 */
      @media (max-width: 1200px) {
        .main-content {
          grid-template-columns: 300px 1fr;
        }
      }

      @media (max-width: 768px) {
        body {
          padding: 10px;
        }

        .container {
          border-radius: 10px;
        }

        .header {
          padding: 20px;
        }

        .header h1 {
          font-size: 2em;
        }

        .main-content {
          grid-template-columns: 1fr;
        }

        .control-panel {
          border-right: none;
          border-bottom: 1px solid #e9ecef;
          padding: 20px;
        }

        .chart-container {
          padding: 20px;
        }

        .chart-wrapper {
          height: 400px;
        }

        .stats-panel {
          grid-template-columns: repeat(2, 1fr);
          gap: 10px;
          padding: 15px;
        }
      }

      @media (max-width: 480px) {
        .header h1 {
          font-size: 1.5em;
        }

        .control-panel,
        .chart-container {
          padding: 15px;
        }

        .chart-wrapper {
          height: 300px;
        }

        .stats-panel {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>

  <body>
    <div class="container">
      <div class="header">
        <h1>📈 金价数据图表分析</h1>
        <p>实时金价走势 - 基于时间序列的折线图展示</p>
      </div>

      <div class="main-content">
        <div class="control-panel">
          <form id="goldPriceForm">
            <div class="form-group">
              <label for="supabaseUrl">Supabase URL</label>
              <input
                type="url"
                id="supabaseUrl"
                value="https://lvsyycnybkwbrvvmshfb.supabase.co"
                placeholder="https://你的项目.supabase.co"
                required
              />
            </div>

            <div class="form-group">
              <label for="apiKey">API 密钥</label>
              <input
                type="text"
                id="apiKey"
                value="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx2c3l5Y255Ymt3YnJ2dm1zaGZiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcyNTU5NjMsImV4cCI6MjA3MjgzMTk2M30.Ot7-h6nbAhIkUOGoqAv8diUBW6-Llhh8MtA6bJMXbeA"
                placeholder="anon key"
                required
              />
            </div>

            <div class="form-group">
              <label for="tableName">数据表名</label>
              <input
                type="text"
                id="tableName"
                value="gold_price"
                placeholder="gold_price"
                required
              />
            </div>

            <div class="form-group">
              <label for="limitRows">数据行数</label>
              <select id="limitRows">
                <option value="100">100</option>
                <option value="200">200</option>
                <option value="500">500</option>
                <option value="1000">1000</option>
                <option value="10000" selected>10000</option>
              </select>
            </div>

            <div class="form-group">
              <label for="orderBy">排序字段</label>
              <select id="orderBy">
                <option value="created_at" selected>
                  created_at (创建时间)
                </option>
                <option value="id">id (ID排序)</option>
                <option value="time_period">time_period (时间周期)</option>
              </select>
            </div>

            <button type="submit" class="btn-primary" id="submitBtn">
              🔄 获取金价数据
            </button>
          </form>

          <div class="loading" id="loading">
            <div class="spinner"></div>
            <p>正在获取金价数据...</p>
          </div>

          <div class="error" id="errorMsg"></div>
          <div class="success" id="successMsg"></div>

          <div class="chart-controls">
            <button class="chart-btn active" data-type="line">折线图</button>
            <button class="chart-btn" data-type="area">面积图</button>
            <button class="chart-btn" data-type="smooth">平滑曲线</button>
          </div>

          <button
            type="button"
            class="btn-primary"
            onclick="loadDemoData()"
            style="margin-top: 10px"
          >
            🎯 加载演示数据
          </button>
        </div>

        <div class="chart-container">
          <div class="stats-panel" id="statsPanel">
            <div class="stat-item">
              <div class="stat-value" id="currentPrice">--</div>
              <div class="stat-label">当前价格</div>
            </div>
            <div class="stat-item">
              <div class="stat-value" id="highPrice">--</div>
              <div class="stat-label">最高价</div>
            </div>
            <div class="stat-item">
              <div class="stat-value" id="lowPrice">--</div>
              <div class="stat-label">最低价</div>
            </div>
            <div class="stat-item">
              <div class="stat-value" id="avgPrice">--</div>
              <div class="stat-label">平均价</div>
            </div>
          </div>

          <div class="chart-wrapper" id="chartContainer"></div>
        </div>
      </div>
    </div>

    <script>
      // Supabase 客户端类 (复用原有逻辑)
      class SupabaseClient {
        constructor(url, apiKey) {
          this.url = url.replace(/\/$/, "");
          this.apiKey = apiKey;
          this.baseHeaders = {
            apikey: apiKey,
            Authorization: `Bearer ${apiKey}`,
            "Content-Type": "application/json",
          };
        }

        buildQueryUrl(tableName, options = {}) {
          const { limit, select, orderBy } = options;
          let url = `${this.url}/rest/v1/${tableName}`;
          const params = new URLSearchParams();

          if (select && select.trim()) {
            params.append("select", select.trim());
          }

          if (limit) {
            params.append("limit", limit);
          }

          if (orderBy && orderBy.trim()) {
            params.append("order", `${orderBy.trim()}`); // 改为升序以正确显示时间序列
          }

          const queryString = params.toString();
          return queryString ? `${url}?${queryString}` : url;
        }

        async fetchData(tableName, options = {}) {
          const url = this.buildQueryUrl(tableName, options);

          try {
            const response = await fetch(url, {
              method: "GET",
              headers: this.baseHeaders,
            });

            if (!response.ok) {
              const errorText = await response.text();
              throw new Error(`HTTP ${response.status}: ${errorText}`);
            }

            const data = await response.json();
            return {
              success: true,
              data,
              url,
              count: Array.isArray(data) ? data.length : 1,
            };
          } catch (error) {
            return {
              success: false,
              error: error.message,
              url,
            };
          }
        }
      }

      // 金价图表控制器
      class GoldPriceChart {
        constructor() {
          this.chart = null;
          this.currentData = null;
          this.currentChartType = "line";

          this.form = document.getElementById("goldPriceForm");
          this.submitBtn = document.getElementById("submitBtn");
          this.loading = document.getElementById("loading");
          this.errorMsg = document.getElementById("errorMsg");
          this.successMsg = document.getElementById("successMsg");
          this.chartContainer = document.getElementById("chartContainer");

          this.initChart();
          this.bindEvents();

          // 页面加载时自动请求数据
          this.autoLoadData();
        }

        initChart() {
          this.chart = echarts.init(this.chartContainer);
          this.setDefaultOption();
        }

        setDefaultOption() {
          const option = {
            title: {
              text: "等待数据加载...",
              left: "center",
              top: "middle",
              textStyle: {
                fontSize: 18,
                color: "#999",
              },
            },
            backgroundColor: "#fff",
          };
          this.chart.setOption(option);
        }

        bindEvents() {
          this.form.addEventListener("submit", this.handleSubmit.bind(this));

          // 图表类型切换
          document.querySelectorAll(".chart-btn").forEach((btn) => {
            btn.addEventListener("click", (e) => {
              document
                .querySelectorAll(".chart-btn")
                .forEach((b) => b.classList.remove("active"));
              e.target.classList.add("active");
              this.currentChartType = e.target.dataset.type;
              if (this.currentData) {
                this.renderChart(this.currentData);
              }
            });
          });

          // 响应式处理
          window.addEventListener("resize", () => {
            if (this.chart) {
              this.chart.resize();
            }
          });
        }

        async handleSubmit(e) {
          e.preventDefault();

          const config = {
            url: document.getElementById("supabaseUrl").value.trim(),
            apiKey: document.getElementById("apiKey").value.trim(),
            tableName: document.getElementById("tableName").value.trim(),
            limit: document.getElementById("limitRows").value,
            orderBy: document.getElementById("orderBy").value.trim(),
          };

          if (!this.validateConfig(config)) {
            return;
          }

          await this.fetchGoldPriceData(config);
        }

        validateConfig(config) {
          this.hideMessages();

          if (!config.url || !config.apiKey || !config.tableName) {
            this.showError("请填写所有必填字段");
            return false;
          }

          try {
            new URL(config.url);
          } catch {
            this.showError("请输入有效的 Supabase URL");
            return false;
          }

          if (config.apiKey.length < 50) {
            this.showError("API 密钥格式不正确");
            return false;
          }

          return true;
        }

        async fetchGoldPriceData(config) {
          this.setLoading(true);
          this.hideMessages();

          try {
            const client = new SupabaseClient(config.url, config.apiKey);

            const result = await client.fetchData(config.tableName, {
              limit: config.limit,
              orderBy: `${config.orderBy}.desc`,
            });

            if (result.success) {
              this.showSuccess(`成功获取 ${result.count} 条金价数据`);

              this.currentData = result.data;

              this.renderChart(result.data);

              this.updateStats(result.data);
            } else {
              this.showError(`数据获取失败: ${result.error}`);

              this.setDefaultOption();
            }
          } catch (error) {
            this.showError(`请求异常: ${error.message}`);

            this.setDefaultOption();
          } finally {
            this.setLoading(false);
          }
        }

        renderChart(data) {
          if (!data || data.length === 0) {
            this.setDefaultOption();
            return;
          }

          const processedData = this.processChartData(data);
          const option = this.generateChartOption(processedData);
          this.chart.setOption(option, true);
        }

        processChartData(data) {
          // 处理数据，根据实际表结构映射字段
          return data
            .map((item) => {
              // 使用新的字段名：xau_price, sh_price, ny_price
              const xauPrice = parseFloat(item.xau_price) || 0; // 伦敦现货金价
              const shPrice = parseFloat(item.sh_price) || 0; // 沪金现货价格
              const nyPrice = parseFloat(item.ny_price) || 0; // 纽约期货金价

              // 使用 created_at 作为时间轴
              const dateValue = item.created_at || new Date().toISOString();

              return {
                date: this.formatDateTime(dateValue), // 保留时间信息
                xauPrice: xauPrice, // 伦敦现货金价
                shPrice: shPrice, // 沪金现货价格  
                nyPrice: nyPrice, // 纽约期货金价
                currency: item.currency || "USD", // 默认USD
                source: item.source || "东方财富", // 默认东方财富
                id: item.id,
                originalData: item, // 保留原始数据用于调试
              };
            })
            .sort((a, b) => new Date(a.date) - new Date(b.date)); // 按时间排序
        }

        formatDate(dateStr) {
          try {
            const date = new Date(dateStr);
            return date.toISOString().split("T")[0]; // YYYY-MM-DD 格式
          } catch {
            return dateStr;
          }
        }

        formatDateTime(dateStr) {
          try {
            const date = new Date(dateStr);
            // 返回更详细的时间格式，用于时间序列
            return date.toLocaleString("zh-CN", {
              year: "numeric",
              month: "2-digit",
              day: "2-digit",
              hour: "2-digit",
              minute: "2-digit",
            });
          } catch {
            return dateStr;
          }
        }

        generateChartOption(data) {
          const dates = data.map((item) => item.date);
          const xauPrices = data.map((item) => item.xauPrice);
          const shPrices = data.map((item) => item.shPrice);
          const nyPrices = data.map((item) => item.nyPrice);
          const currency = data[0]?.currency || "USD";

          // 获取所有价格用于计算Y轴范围
          const allPrices = [...xauPrices, ...shPrices, ...nyPrices].filter(p => p > 0);
          
          // 动态计算Y轴范围
          const minPrice = Math.min(...allPrices);
          const maxPrice = Math.max(...allPrices);
          const yAxisMin = Math.max(0, minPrice - 50); // 确保不小于0
          const yAxisMax = maxPrice + 50;

          console.log(
            `价格范围: ${minPrice.toFixed(2)} - ${maxPrice.toFixed(2)}`
          );
          console.log(
            `Y轴范围: ${yAxisMin.toFixed(2)} - ${yAxisMax.toFixed(2)}`
          );

          const baseOption = {
            backgroundColor: "#fff",
            title: {
              text: `全球金价走势对比图 (${currency})`,
              left: "center",
              textStyle: {
                fontSize: 16,
                fontWeight: "bold",
                color: "#333",
              },
            },
            tooltip: {
              trigger: "axis",
              axisPointer: {
                type: "cross",
                crossStyle: {
                  color: "#999",
                },
              },
              formatter: function (params) {
                let result = `<strong>${params[0].axisValue}</strong><br/>`;
                
                // 显示所有系列的数据
                params.forEach(param => {
                  if (param.value > 0) { // 只显示有效价格
                    result += `${param.marker}${param.seriesName}: ${param.value} ${currency}<br/>`;
                  }
                });

                // 显示数据来源信息
                const dataIndex = params[0].dataIndex;
                const originalData = data[dataIndex]?.originalData;
                if (originalData?.source) {
                  result += `<br/><span style="color: #666;">数据来源: ${originalData.source}</span>`;
                }
                return result;
              },
            },
            legend: {
              data: ["纽约期货金价", "伦敦现货金价", "沪金现货价格"],
              top: 30,
            },
            xAxis: {
              type: "category",
              data: dates,
              axisPointer: {
                type: "line",
              },
              axisLabel: {
                rotate: 45,
                interval: Math.max(0, Math.floor(dates.length / 8)),
                fontSize: 11,
              },
            },
            yAxis: {
              type: "value",
              name: `金价 (${currency})`,
              min: yAxisMin, // 动态计算的最小值
              max: yAxisMax, // 动态计算的最大值
              axisLabel: {
                formatter: "{value}",
              },
              splitLine: {
                show: true,
                lineStyle: {
                  color: "#f0f0f0",
                },
              },
            },
            grid: {
              left: "10%",
              right: "5%",
              bottom: "15%",
              top: "15%",
            },
            dataZoom: [
              {
                type: "inside",
                start: 0,
                end: 100,
              },
              {
                start: 0,
                end: 100,
                height: 30,
                bottom: 30,
              },
            ],
          };

          // 根据图表类型生成不同的系列
          const series = [];
          
          // 纽约期货金价系列
          if (nyPrices.some(p => p > 0)) {
            series.push({
              name: "纽约期货金价",
              type: "line",
              data: nyPrices,
              smooth: this.currentChartType === "smooth",
              symbol: "circle",
              symbolSize: 4,
              lineStyle: {
                color: "#DC143C", // 红色
                width: 2,
              },
              itemStyle: {
                color: "#DC143C",
                borderColor: "#fff",
                borderWidth: 1,
              },
              ...(this.currentChartType === "area" || this.currentChartType === "smooth" ? {
                areaStyle: {
                  color: {
                    type: "linear",
                    x: 0, y: 0, x2: 0, y2: 1,
                    colorStops: [
                      { offset: 0, color: "rgba(220, 20, 60, 0.3)" },
                      { offset: 1, color: "rgba(220, 20, 60, 0.05)" },
                    ],
                  },
                }
              } : {})
            });
          }
          
          // 伦敦现货金价系列
          if (xauPrices.some(p => p > 0)) {
            series.push({
              name: "伦敦现货金价",
              type: "line",
              data: xauPrices,
              smooth: this.currentChartType === "smooth",
              symbol: "circle",
              symbolSize: 4,
              lineStyle: {
                color: "#FFD700", // 金色
                width: 2,
              },
              itemStyle: {
                color: "#FFD700",
                borderColor: "#fff",
                borderWidth: 1,
              },
              ...(this.currentChartType === "area" || this.currentChartType === "smooth" ? {
                areaStyle: {
                  color: {
                    type: "linear",
                    x: 0, y: 0, x2: 0, y2: 1,
                    colorStops: [
                      { offset: 0, color: "rgba(255, 215, 0, 0.3)" },
                      { offset: 1, color: "rgba(255, 215, 0, 0.05)" },
                    ],
                  },
                }
              } : {})
            });
          }
          
          // 沪金现货价格系列
          if (shPrices.some(p => p > 0)) {
            series.push({
              name: "沪金现货价格",
              type: "line",
              data: shPrices,
              smooth: this.currentChartType === "smooth",
              symbol: "circle",
              symbolSize: 4,
              lineStyle: {
                color: "#1E90FF", // 蓝色
                width: 2,
              },
              itemStyle: {
                color: "#1E90FF",
                borderColor: "#fff",
                borderWidth: 1,
              },
              ...(this.currentChartType === "area" || this.currentChartType === "smooth" ? {
                areaStyle: {
                  color: {
                    type: "linear",
                    x: 0, y: 0, x2: 0, y2: 1,
                    colorStops: [
                      { offset: 0, color: "rgba(30, 144, 255, 0.3)" },
                      { offset: 1, color: "rgba(30, 144, 255, 0.05)" },
                    ],
                  },
                }
              } : {})
            });
          }
          
          baseOption.series = series;

          return baseOption;
        }

        updateStats(data) {
          if (!data || data.length === 0) return;

          // 获取三个价格数组
          const xauPrices = data.map((item) => parseFloat(item.xauPrice) || 0).filter(p => p > 0);
          const shPrices = data.map((item) => parseFloat(item.shPrice) || 0).filter(p => p > 0);
          const nyPrices = data.map((item) => parseFloat(item.nyPrice) || 0).filter(p => p > 0);
          const currency = data[0]?.currency || "USD";

          // 计算各自的统计信息
          const stats = {
            ny: this.calculatePriceStats(nyPrices, "纽约期货"),
            xau: this.calculatePriceStats(xauPrices, "伦敦现货"),
            sh: this.calculatePriceStats(shPrices, "沪金现货")
          };

          // 更新显示 - 显示最新的有效价格
          const latestData = data[data.length - 1];
          
          document.getElementById("currentPrice").innerHTML = `
            <div style="font-size: 0.8em; margin-bottom: 5px;">
              NY: ${latestData.nyPrice || '--'}<br/>
              XAU: ${latestData.xauPrice || '--'}<br/>
              SH: ${latestData.shPrice || '--'}
            </div>
          `;
          
          // 显示全局最高价
          const allPrices = [...xauPrices, ...shPrices, ...nyPrices];
          const globalHigh = allPrices.length > 0 ? Math.max(...allPrices) : 0;
          const globalLow = allPrices.length > 0 ? Math.min(...allPrices) : 0;
          const globalAvg = allPrices.length > 0 ? allPrices.reduce((sum, price) => sum + price, 0) / allPrices.length : 0;

          document.getElementById("highPrice").textContent = `${globalHigh.toFixed(2)} ${currency}`;
          document.getElementById("lowPrice").textContent = `${globalLow.toFixed(2)} ${currency}`;
          document.getElementById("avgPrice").textContent = `${globalAvg.toFixed(2)} ${currency}`;

          // 在控制台输出数据源信息
          const sources = [...new Set(data.map((item) => item.source))];
          console.log(`数据来源: ${sources.join(", ")}`);
          console.log(`数据条数: ${data.length}`);
          console.log(`纽约期货有效数据: ${nyPrices.length}条`);
          console.log(`伦敦现货有效数据: ${xauPrices.length}条`);
          console.log(`沪金现货有效数据: ${shPrices.length}条`);
          console.log(`时间范围: ${data[0]?.date} 至 ${data[data.length - 1]?.date}`);
        }

        calculatePriceStats(prices, name) {
          if (prices.length === 0) return { current: 0, high: 0, low: 0, avg: 0 };
          
          return {
            current: prices[prices.length - 1],
            high: Math.max(...prices),
            low: Math.min(...prices),
            avg: prices.reduce((sum, price) => sum + price, 0) / prices.length
          };
        }

        setLoading(isLoading) {
          this.submitBtn.disabled = isLoading;
          this.loading.classList.toggle("show", isLoading);
          this.submitBtn.textContent = isLoading
            ? "🔄 获取数据中..."
            : "🔄 获取金价数据";
        }

        showError(message) {
          this.errorMsg.textContent = message;
          this.errorMsg.classList.add("show");
          this.successMsg.classList.remove("show");
        }

        showSuccess(message) {
          this.successMsg.textContent = message;
          this.successMsg.classList.add("show");
          this.errorMsg.classList.remove("show");
        }

        hideMessages() {
          this.errorMsg.classList.remove("show");
          this.successMsg.classList.remove("show");
        }

        // 自动加载数据
        autoLoadData() {
          // 延迟500ms执行，确保页面完全加载
          setTimeout(() => {
            const config = {
              url: document.getElementById("supabaseUrl").value.trim(),
              apiKey: document.getElementById("apiKey").value.trim(),
              tableName: document.getElementById("tableName").value.trim(),
              limit: document.getElementById("limitRows").value,
              orderBy: document.getElementById("orderBy").value.trim(),
            };

            // 检查配置是否完整
            if (config.url && config.apiKey && config.tableName) {
              console.log("页面加载完成，自动请求金价数据...");
              this.fetchGoldPriceData(config);
            } else {
              console.log("配置不完整，跳过自动请求");
              this.showError("请检查Supabase配置信息");
            }
          }, 500);
        }
      }

      // 初始化应用
      document.addEventListener("DOMContentLoaded", () => {
        new GoldPriceChart();
      });

      // 添加一些模拟数据功能（用于演示）
      window.loadDemoData = function () {
        const chart = window.goldPriceChart || new GoldPriceChart();

                  // 生成30天的模拟金价数据
          const demoData = [];
          const startDate = new Date();
          startDate.setDate(startDate.getDate() - 30);

          for (let i = 0; i < 30; i++) {
            const date = new Date(startDate);
            date.setDate(date.getDate() + i);

            const basePrice = 2000 + Math.sin(i / 5) * 100; // 基础价格波动
            const randomFactor = (Math.random() - 0.5) * 50; // 随机波动

            // 生成三个不同的价格
            const nyPrice = Math.max(1800, basePrice + randomFactor);
            const xauPrice = Math.max(1800, nyPrice + (Math.random() - 0.5) * 30); // 伦敦价格略有差异
            const shPrice = Math.max(400, (nyPrice / 7.2) + (Math.random() - 0.5) * 20); // 沪金价格（人民币）

            demoData.push({
              id: i + 1,
              created_at: date.toISOString(),
              time_period: "realtime",
              price: null, // 保持兼容性
              source: "东方财富",
              currency: "USD",
              xau_price: xauPrice,
              sh_price: shPrice,
              ny_price: nyPrice
            });
          }

        chart.currentData = demoData;
        chart.renderChart(demoData);
        chart.updateStats(demoData);
        chart.showSuccess(`加载了 ${demoData.length} 条演示数据`);
      };
    </script>
  </body>
</html>
