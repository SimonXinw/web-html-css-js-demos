<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <meta http-equiv="X-UA-Compatible" content="ie=edge" />
  <title>弹幕播放器 - 优化版</title>
  <style>
    /* 重置样式 */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Microsoft YaHei', 'PingFang SC', 'Helvetica Neue', Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 10px;
    }

    /* 主容器 */
    .danmu-container {
      width: 100%;
      max-width: 900px;
      background: rgba(255, 255, 255, 0.95);
      border-radius: 20px;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
      overflow: hidden;
      backdrop-filter: blur(10px);
    }

    /* 视频区域 */
    .video-area {
      position: relative;
      width: 100%;
      aspect-ratio: 16/9;
      background: #000;
      overflow: hidden;
      border-radius: 20px 20px 0 0;
    }

    .video-area img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }

    /* 弹幕轨道 */
    .danmu-track {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 10;
    }

    /* 弹幕样式 */
    .danmu-item {
      position: fixed;
      color: #fff;
      font-size: 18px;
      font-weight: 600;
      white-space: nowrap;
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
      border: 1px solid rgba(255, 255, 255, 0.3);
      padding: 4px 8px;
      border-radius: 20px;
      background: rgba(0, 0, 0, 0.3);
      backdrop-filter: blur(5px);
      animation: danmuMove linear forwards;
      cursor: default;
      z-index: 1000;
    }

    /* 弹幕移动动画 */
    @keyframes danmuMove {
      from {
        left: 100vw;
      }

      to {
        left: -100%;
      }
    }

    /* 控制面板 */
    .control-panel {
      padding: 20px;
      background: linear-gradient(45deg, #f8f9fa, #e9ecef);
    }

    /* 发送区域 */
    .send-area {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
      flex-wrap: wrap;
    }

    .input-wrapper {
      flex: 1;
      min-width: 200px;
      position: relative;
    }

    #danmuInput {
      width: 100%;
      height: 45px;
      border: 2px solid #e9ecef;
      border-radius: 25px;
      padding: 0 20px;
      font-size: 16px;
      outline: none;
      transition: all 0.3s ease;
      background: white;
    }

    #danmuInput:focus {
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    #danmuInput::placeholder {
      color: #adb5bd;
    }

    .send-btn {
      height: 45px;
      padding: 0 25px;
      background: linear-gradient(45deg, #667eea, #764ba2);
      color: white;
      border: none;
      border-radius: 25px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      white-space: nowrap;
    }

    .send-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
    }

    .send-btn:active {
      transform: translateY(0);
    }

    /* 设置区域 */
    .settings-area {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      align-items: center;
    }

    .setting-group {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .setting-group label {
      font-size: 14px;
      color: #495057;
      font-weight: 500;
      white-space: nowrap;
    }

    .color-picker {
      width: 35px;
      height: 35px;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      outline: none;
      transition: transform 0.2s ease;
    }

    .color-picker:hover {
      transform: scale(1.1);
    }

    .speed-slider,
    .size-slider {
      width: 80px;
      height: 6px;
      border-radius: 3px;
      background: #e9ecef;
      outline: none;
      cursor: pointer;
    }

    .speed-slider::-webkit-slider-thumb,
    .size-slider::-webkit-slider-thumb {
      appearance: none;
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: linear-gradient(45deg, #667eea, #764ba2);
      cursor: pointer;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
    }

    .clear-btn {
      padding: 8px 16px;
      background: #dc3545;
      color: white;
      border: none;
      border-radius: 20px;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .clear-btn:hover {
      background: #c82333;
      transform: translateY(-1px);
    }

    /* 状态显示 */
    .status-info {
      margin-top: 10px;
      padding: 10px 15px;
      background: rgba(102, 126, 234, 0.1);
      border-radius: 10px;
      font-size: 13px;
      color: #495057;
      display: flex;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 10px;
    }

    /* 移动端适配 */
    @media (max-width: 768px) {
      body {
        padding: 5px;
      }

      .danmu-container {
        border-radius: 15px;
      }

      .video-area {
        border-radius: 15px 15px 0 0;
      }

      .danmu-item {
        font-size: 14px;
        padding: 3px 6px;
      }

      .control-panel {
        padding: 15px;
      }

      .send-area {
        flex-direction: column;
        gap: 10px;
      }

      .input-wrapper {
        min-width: auto;
      }

      #danmuInput,
      .send-btn {
        height: 40px;
        font-size: 15px;
      }

      .settings-area {
        justify-content: center;
        gap: 10px;
      }

      .setting-group {
        flex-direction: column;
        text-align: center;
        gap: 5px;
      }

      .speed-slider,
      .size-slider {
        width: 60px;
      }

      .status-info {
        font-size: 12px;
        justify-content: center;
        text-align: center;
      }
    }

    @media (max-width: 480px) {
      .danmu-item {
        font-size: 12px;
        padding: 2px 5px;
      }

      .control-panel {
        padding: 10px;
      }

      .settings-area {
        flex-direction: column;
        gap: 8px;
      }

      .setting-group {
        flex-direction: row;
        justify-content: space-between;
        width: 100%;
        padding: 5px 0;
      }
    }

    /* 弹幕颜色预设 */
    .danmu-red {
      color: #ff6b6b !important;
    }

    .danmu-blue {
      color: #4ecdc4 !important;
    }

    .danmu-green {
      color: #45b7d1 !important;
    }

    .danmu-yellow {
      color: #f9ca24 !important;
    }

    .danmu-purple {
      color: #a55eea !important;
    }

    .danmu-orange {
      color: #fd79a8 !important;
    }

    /* 加载动画 */
    .loading {
      opacity: 0.6;
      pointer-events: none;
    }

    /* 触摸设备优化 */
    @media (hover: none) and (pointer: coarse) {
      .danmu-item {
        font-size: 16px;
      }

      .send-btn:hover {
        transform: none;
        box-shadow: none;
      }

      .send-btn:active {
        transform: scale(0.95);
      }
    }
  </style>
</head>

<body>
  <div class="danmu-container">
    <!-- 视频播放区域 -->
    <div class="video-area" id="videoArea">
      <img src="../img/美女_1.jpeg" alt="视频背景" />
      <!-- 弹幕轨道 -->
      <div class="danmu-track" id="danmuTrack"></div>
    </div>

    <!-- 控制面板 -->
    <div class="control-panel">
      <!-- 发送区域 -->
      <div class="send-area">
        <div class="input-wrapper">
          <input type="text" id="danmuInput" placeholder="输入弹幕内容..." maxlength="50" autocomplete="off" />
        </div>
        <button class="send-btn" id="sendBtn">发送</button>
      </div>

      <!-- 设置区域 -->
      <div class="settings-area">
        <div class="setting-group">
          <label for="colorPicker">颜色:</label>
          <input type="color" id="colorPicker" class="color-picker" value="#ffffff" />
        </div>

        <div class="setting-group">
          <label for="speedSlider">速度:</label>
          <input type="range" id="speedSlider" class="speed-slider" min="5" max="20" value="10" />
        </div>

        <div class="setting-group">
          <label for="sizeSlider">大小:</label>
          <input type="range" id="sizeSlider" class="size-slider" min="12" max="24" value="18" />
        </div>

        <button class="clear-btn" id="clearBtn">清屏</button>
      </div>

      <!-- 状态信息 -->
      <div class="status-info">
        <span>弹幕数量: <span id="danmuCount">0</span></span>
        <span>发送总数: <span id="totalSent">0</span></span>
        <span>当前设置: 速度 <span id="currentSpeed">10</span>s, 大小 <span id="currentSize">18</span>px</span>
      </div>
    </div>
  </div>

  <script>
    /**
     * 弹幕播放器类 - 管理弹幕的发送、显示和动画
     */
    class DanmuPlayer {
      constructor() {
        // 获取DOM元素
        this.danmuTrack = document.getElementById('danmuTrack');
        this.danmuInput = document.getElementById('danmuInput');
        this.sendBtn = document.getElementById('sendBtn');
        this.colorPicker = document.getElementById('colorPicker');
        this.speedSlider = document.getElementById('speedSlider');
        this.sizeSlider = document.getElementById('sizeSlider');
        this.clearBtn = document.getElementById('clearBtn');
        this.danmuCount = document.getElementById('danmuCount');
        this.totalSent = document.getElementById('totalSent');
        this.currentSpeed = document.getElementById('currentSpeed');
        this.currentSize = document.getElementById('currentSize');

        // 弹幕配置
        this.config = {
          speed: 10,        // 弹幕速度(秒)
          fontSize: 18,     // 字体大小
          color: '#ffffff', // 弹幕颜色
          trackHeight: 40,  // 轨道高度
          maxDanmu: 50     // 最大弹幕数量
        };

        // 状态管理
        this.danmuList = [];      // 当前显示的弹幕列表
        this.totalSentCount = 0;  // 总发送数量
        this.tracks = [];         // 轨道占用状态
        this.trackCount = 0;      // 轨道数量

        // 初始化
        this.init();
      }

      /**
       * 初始化弹幕播放器
       */
      init() {
        this.calculateTracks();
        this.bindEvents();
        this.updateStatus();
        this.addDemoMessages();
      }

      /**
       * 计算轨道数量
       */
      calculateTracks() {
        const containerHeight = this.danmuTrack.offsetHeight;
        this.trackCount = Math.floor(containerHeight / this.config.trackHeight);
        this.tracks = new Array(this.trackCount).fill(0);
      }

      /**
       * 绑定事件监听器
       */
      bindEvents() {
        // 发送按钮点击事件
        this.sendBtn.addEventListener('click', () => this.sendDanmu());

        // 输入框回车事件
        this.danmuInput.addEventListener('keypress', (e) => {
          if (e.key === 'Enter') {
            this.sendDanmu();
          }
        });

        // 清屏按钮
        this.clearBtn.addEventListener('click', () => this.clearAllDanmu());

        // 设置变更事件
        this.speedSlider.addEventListener('input', (e) => {
          this.config.speed = parseInt(e.target.value);
          this.updateStatus();
        });

        this.sizeSlider.addEventListener('input', (e) => {
          this.config.fontSize = parseInt(e.target.value);
          this.updateStatus();
        });

        this.colorPicker.addEventListener('change', (e) => {
          this.config.color = e.target.value;
        });

        // 窗口大小变化时重新计算轨道和弹幕位置
        window.addEventListener('resize', () => {
          setTimeout(() => {
            this.calculateTracks();
            this.updateDanmuPositions();
          }, 100);
        });

        // 滚动时更新弹幕位置
        window.addEventListener('scroll', () => {
          this.updateDanmuPositions();
        });

        // 防止输入框在移动端被虚拟键盘遮挡
        if (this.isMobile()) {
          this.danmuInput.addEventListener('focus', () => {
            setTimeout(() => {
              this.danmuInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }, 300);
          });
        }
      }

      /**
       * 检查是否为移动设备
       */
      isMobile() {
        return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ||
          window.innerWidth <= 768;
      }

      /**
       * 发送弹幕
       */
      sendDanmu() {
        const content = this.danmuInput.value.trim();

        if (!content) {
          this.showTip('请输入弹幕内容');
          return;
        }

        if (content.length > 50) {
          this.showTip('弹幕内容不能超过50个字符');
          return;
        }

        if (this.danmuList.length >= this.config.maxDanmu) {
          this.showTip('弹幕数量已达上限，请稍后再试');
          return;
        }

        // 创建弹幕
        this.createDanmu(content, this.config.color, this.config.fontSize);

        // 清空输入框
        this.danmuInput.value = '';

        // 更新计数
        this.totalSentCount++;
        this.updateStatus();

        // 移动端发送后收起键盘
        if (this.isMobile()) {
          this.danmuInput.blur();
        }
      }

      /**
       * 创建弹幕元素
       */
      createDanmu(content, color = '#ffffff', fontSize = 18) {
        // 获取可用轨道
        const trackIndex = this.getAvailableTrack();
        if (trackIndex === -1) {
          this.showTip('当前轨道已满，请稍后再试');
          return;
        }

        // 创建弹幕元素
        const danmuElement = document.createElement('div');
        danmuElement.className = 'danmu-item';
        danmuElement.textContent = content;
        danmuElement.style.color = color;
        danmuElement.style.fontSize = fontSize + 'px';
        danmuElement.style.animationDuration = this.config.speed + 's';

        // 计算弹幕在视频区域内的绝对位置
        const videoRect = this.danmuTrack.getBoundingClientRect();
        const trackTop = videoRect.top + (trackIndex * this.config.trackHeight + 10);

        // 设置弹幕位置：从屏幕最右边开始，在正确的轨道上
        danmuElement.style.left = '100vw';
        danmuElement.style.top = trackTop + 'px';

        // 添加到轨道
        this.danmuTrack.appendChild(danmuElement);

        // 标记轨道为占用状态
        this.tracks[trackIndex] = Date.now();

        // 添加到弹幕列表
        const danmuInfo = {
          element: danmuElement,
          trackIndex: trackIndex,
          startTime: Date.now()
        };
        this.danmuList.push(danmuInfo);

        // 设置动画结束后的清理
        danmuElement.addEventListener('animationend', () => {
          this.removeDanmu(danmuInfo);
        });

        // 更新状态
        this.updateStatus();
      }

      /**
       * 获取可用轨道
       */
      getAvailableTrack() {
        const now = Date.now();
        const trackCooldown = 2000; // 轨道冷却时间(毫秒)

        for (let i = 0; i < this.trackCount; i++) {
          if (now - this.tracks[i] > trackCooldown) {
            return i;
          }
        }
        return -1; // 没有可用轨道
      }

      /**
       * 移除弹幕
       */
      removeDanmu(danmuInfo) {
        if (danmuInfo.element && danmuInfo.element.parentNode) {
          danmuInfo.element.parentNode.removeChild(danmuInfo.element);
        }

        // 从列表中移除
        const index = this.danmuList.indexOf(danmuInfo);
        if (index > -1) {
          this.danmuList.splice(index, 1);
        }

        // 释放轨道
        this.tracks[danmuInfo.trackIndex] = 0;

        // 更新状态
        this.updateStatus();
      }

      /**
       * 清除所有弹幕
       */
      clearAllDanmu() {
        // 移除所有弹幕元素
        this.danmuList.forEach(danmuInfo => {
          if (danmuInfo.element && danmuInfo.element.parentNode) {
            danmuInfo.element.parentNode.removeChild(danmuInfo.element);
          }
        });

        // 清空列表和轨道
        this.danmuList = [];
        this.tracks.fill(0);

        // 更新状态
        this.updateStatus();

        this.showTip('已清除所有弹幕');
      }

      /**
       * 更新状态显示
       */
      updateStatus() {
        this.danmuCount.textContent = this.danmuList.length;
        this.totalSent.textContent = this.totalSentCount;
        this.currentSpeed.textContent = this.config.speed;
        this.currentSize.textContent = this.config.fontSize;
      }

      /**
       * 显示提示信息
       */
      showTip(message) {
        // 创建临时提示元素
        const tip = document.createElement('div');
        tip.textContent = message;
        tip.style.cssText = `
          position: fixed;
          top: 50%;
          left: 50%;
          transform: translate(-50%, -50%);
          background: rgba(0, 0, 0, 0.8);
          color: white;
          padding: 10px 20px;
          border-radius: 20px;
          font-size: 14px;
          z-index: 10000;
          pointer-events: none;
          animation: fadeInOut 2s forwards;
        `;

        // 添加动画样式
        if (!document.querySelector('#tipAnimation')) {
          const style = document.createElement('style');
          style.id = 'tipAnimation';
          style.textContent = `
            @keyframes fadeInOut {
              0% { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
              20% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
              80% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
              100% { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
            }
          `;
          document.head.appendChild(style);
        }

        document.body.appendChild(tip);

        // 2秒后移除
        setTimeout(() => {
          if (tip.parentNode) {
            tip.parentNode.removeChild(tip);
          }
        }, 2000);
      }

      /**
       * 添加演示弹幕
       */
      addDemoMessages() {
        const demoMessages = [
          { text: '欢迎使用弹幕系统！', color: '#ff6b6b' },
          { text: '支持自定义颜色和速度', color: '#4ecdc4' },
          { text: '兼容移动端触摸操作', color: '#45b7d1' },
          { text: '这是一个演示弹幕', color: '#f9ca24' }
        ];

        demoMessages.forEach((msg, index) => {
          setTimeout(() => {
            this.createDanmu(msg.text, msg.color, 16);
          }, index * 1000);
        });
      }

      /**
       * 更新所有弹幕的位置（用于处理滚动和窗口变化）
       */
      updateDanmuPositions() {
        const videoRect = this.danmuTrack.getBoundingClientRect();

        this.danmuList.forEach(danmuInfo => {
          if (danmuInfo.element && danmuInfo.element.parentNode) {
            const trackTop = videoRect.top + (danmuInfo.trackIndex * this.config.trackHeight + 10);
            danmuInfo.element.style.top = trackTop + 'px';
          }
        });
      }

      /**
       * 获取随机颜色
       */
      getRandomColor() {
        const colors = ['#ff6b6b', '#4ecdc4', '#45b7d1', '#f9ca24', '#a55eea', '#fd79a8'];
        return colors[Math.floor(Math.random() * colors.length)];
      }
    }

    // 页面加载完成后初始化弹幕播放器
    document.addEventListener('DOMContentLoaded', function () {
      window.danmuPlayer = new DanmuPlayer();
    });

    // 添加一些快捷键支持
    document.addEventListener('keydown', function (e) {
      // Ctrl + Enter 快速发送
      if (e.ctrlKey && e.key === 'Enter') {
        window.danmuPlayer.sendDanmu();
      }

      // Esc 清屏
      if (e.key === 'Escape') {
        window.danmuPlayer.clearAllDanmu();
      }
    });
  </script>
</body>

</html>