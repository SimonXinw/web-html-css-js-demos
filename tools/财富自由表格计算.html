<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>è´¢å¯Œè‡ªç”±æŒ‡å—è¡¨æ ¼è®¡ç®—</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: Arial, "Microsoft YaHei", sans-serif;
      padding: 20px;
      background-color: #f5f5f5;
    }

    .container {
      max-width: 100%;
      margin: 0 auto;
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      overflow-x: auto;
    }

    h1 {
      text-align: center;
      color: #333;
      margin-bottom: 20px;
    }

    .input_section {
      margin-bottom: 20px;
    }

    .basic_inputs {
      display: flex;
      gap: 20px;
      margin-bottom: 20px;
      flex-wrap: wrap;
      align-items: center;
      justify-content: center;
    }

    .income_config_section {
      background-color: #f9f9f9;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 15px;
      border: 1px solid #e0e0e0;
    }

    .income_config_title {
      font-size: 16px;
      font-weight: bold;
      color: #333;
      margin-bottom: 15px;
      text-align: center;
    }

    .income_segments {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .income_segment {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
      background-color: white;
      padding: 10px;
      border-radius: 6px;
      border: 1px solid #ddd;
    }

    .segment_label {
      color: #666;
      font-size: 14px;
      white-space: nowrap;
    }

    .segment_year_range {
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .segment_year_input {
      width: 70px;
      padding: 6px 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
    }

    .segment_income_input {
      width: 120px;
      padding: 6px 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
    }

    .input_group {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .input_group label {
      font-weight: bold;
      color: #555;
    }

    .input_group input {
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
      width: 150px;
    }

    .input_group input:focus,
    .segment_year_input:focus,
    .segment_income_input:focus {
      outline: none;
      border-color: #4CAF50;
    }

    .segment_hint {
      color: #999;
      font-size: 12px;
      font-style: italic;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      font-size: 12px;
    }

    th, td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: center;
      min-width: 80px;
      white-space: nowrap;
    }

    th {
      background-color: #FFE599;
      font-weight: bold;
      position: sticky;
      top: 0;
      z-index: 10;
    }

    td:first-child, th:first-child {
      background-color: #B4C7E7;
      font-weight: bold;
      position: sticky;
      left: 0;
      z-index: 5;
    }

    th:first-child {
      z-index: 15;
    }

    .result_cell {
      font-weight: 500;
    }

    .result_cell.forever {
      background-color: #C6E0B4;
      color: #2E7D32;
    }

    .result_cell.years_1_5 {
      background-color: #FF6B6B;
      color: white;
    }

    .result_cell.years_6_10 {
      background-color: #FFA500;
      color: white;
    }

    .result_cell.years_11_30 {
      background-color: #FFD966;
      color: #333;
    }

    .result_cell.years_31_plus {
      background-color: #9BC2E6;
      color: #333;
    }

    @media (max-width: 768px) {
      .basic_inputs {
        flex-direction: column;
      }

      .income_segment {
        flex-direction: column;
        align-items: flex-start;
      }

      table {
        font-size: 10px;
      }

      th, td {
        padding: 5px;
        min-width: 60px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>è´¢å¯Œè‡ªç”±æŒ‡å— - æœ¬é‡‘ï¼ˆå¹´åˆ©ç‡ <span id="rate_display">2.0</span>%ï¼‰</h1>
    
    <div class="input_section">
      <div class="basic_inputs">
        <div class="input_group">
          <label for="annual_rate">å¹´åˆ©ç‡ï¼ˆ%ï¼‰ï¼š</label>
          <input type="number" id="annual_rate" value="2.0" step="0.1" min="0" max="100">
        </div>
      </div>

      <div class="income_config_section">
        <div class="income_config_title">ğŸ’° åˆ†æ®µæ”¶å…¥é…ç½®ï¼ˆæœ€å¤š50å¹´ï¼‰</div>
        <div id="income_segments" class="income_segments">
          <!-- æ”¶å…¥æ®µå°†åŠ¨æ€ç”Ÿæˆ -->
        </div>
      </div>
    </div>

    <table id="wealth_table">
      <!-- è¡¨æ ¼å†…å®¹å°†é€šè¿‡ JavaScript åŠ¨æ€ç”Ÿæˆ -->
    </table>
  </div>

  <script>
    // ç¬¬ä¸€è¡Œï¼šæœ¬é‡‘æ•°æ®ï¼ˆä¸‡å…ƒï¼‰
    const PRINCIPAL_AMOUNTS = [100, 150, 300, 500, 1000, 2000, 3000, 5000, 10000, 20000, 30000];

    // ç¬¬ä¸€åˆ—ï¼šæ¯å¹´æ¶ˆè´¹æ•°æ®ï¼ˆä¸‡å…ƒï¼‰
    const ANNUAL_EXPENSES = [2, 3.5, 5, 10, 20, 30, 50, 75, 100, 150, 200, 250, 300, 500];

    // é»˜è®¤é…ç½®
    const DEFAULT_RATE = 2.0;
    const MAX_YEARS = 50;

    // æ”¶å…¥æ®µé…ç½®æ•°ç»„
    let incomeSegments = [
      { startYear: 1, endYear: 50, income: 0 }
    ];

    /**
     * æ ¼å¼åŒ–æœ¬é‡‘æ˜¾ç¤º
     * @param {number} amount - é‡‘é¢ï¼ˆä¸‡å…ƒï¼‰
     * @returns {string} æ ¼å¼åŒ–åçš„å­—ç¬¦ä¸²
     */
    const formatPrincipal = (amount) => {
      if (amount >= 10000) {
        return `${amount / 10000}äº¿å…ƒ`;
      }
      return `${amount}ä¸‡`;
    };

    /**
     * æ ¹æ®å¹´ä»½è·å–å¯¹åº”çš„æ”¶å…¥
     * @param {number} year - å¹´ä»½
     * @returns {number} è¯¥å¹´ä»½çš„æ”¶å…¥ï¼ˆä¸‡å…ƒï¼‰
     */
    const getIncomeByYear = (year) => {
      for (const segment of incomeSegments) {
        if (year >= segment.startYear && year <= segment.endYear) {
          return segment.income;
        }
      }
      return 0;
    };

    /**
     * è®¡ç®—åœ¨ç»™å®šæ¡ä»¶ä¸‹èƒ½æ¶ˆè´¹å¤šå°‘å¹´
     * @param {number} initialPrincipal - åˆå§‹æœ¬é‡‘ï¼ˆä¸‡å…ƒï¼‰
     * @param {number} annualExpense - æ¯å¹´æ¶ˆè´¹ï¼ˆä¸‡å…ƒï¼‰
     * @param {number} annualRate - å¹´åˆ©ç‡ï¼ˆç™¾åˆ†æ¯”ï¼‰
     * @returns {number|string} å¯æ¶ˆè´¹å¹´æ•°ï¼Œæˆ– "forever" è¡¨ç¤ºæ°¸è¿œèŠ±ä¸å®Œ
     */
    const calculateYearsUntilBroke = (initialPrincipal, annualExpense, annualRate) => {
      // è½¬æ¢åˆ©ç‡ä¸ºå°æ•°
      const rateDecimal = annualRate / 100;
      
      // å½“å‰æœ¬é‡‘
      let currentPrincipal = initialPrincipal;
      
      // å¹´ä»½è®¡æ•°å™¨
      let years = 0;
      
      // æœ€å¤§è®¡ç®—å¹´é™ï¼ˆé˜²æ­¢æ— é™å¾ªç¯ï¼‰
      const MAX_CALCULATION_YEARS = 1000;
      
      // æŒç»­è®¡ç®—ç›´åˆ°é’±èŠ±å®Œæˆ–è¶…è¿‡æœ€å¤§å¹´é™
      while (years < MAX_CALCULATION_YEARS) {
        // è·å–å½“å‰å¹´ä»½çš„æ”¶å…¥
        const currentYearIncome = getIncomeByYear(years + 1);
        
        // è®¡ç®—å¹´åˆå¯ç”¨é‡‘é¢
        const availableAmount = currentPrincipal + currentYearIncome - annualExpense;
        
        // åˆ¤æ–­æ˜¯å¦æ°¸è¿œèŠ±ä¸å®Œï¼šå¦‚æœå¹´åˆé‡‘é¢å¤§äºç­‰äºåˆå§‹æœ¬é‡‘ï¼Œè¯´æ˜é’±è¶Šæ¥è¶Šå¤š
        if (availableAmount >= initialPrincipal && years === 0) {
          return "forever";
        }
        
        // åˆ¤æ–­æ˜¯å¦è¿™ä¸€å¹´å°±èŠ±å®Œäº†
        if (availableAmount <= 0) {
          return years + 1;
        }
        
        // è®¡ç®—å¹´åº•æœ¬é‡‘ï¼ˆåŠ ä¸Šåˆ©æ¯ï¼‰
        currentPrincipal = availableAmount * (1 + rateDecimal);
        
        // å¹´ä»½åŠ ä¸€
        years++;
      }
      
      // å¦‚æœè¶…è¿‡æœ€å¤§å¹´é™ï¼Œä¹Ÿè®¤ä¸ºæ˜¯æ°¸è¿œèŠ±ä¸å®Œ
      return "forever";
    };

    /**
     * æ ¼å¼åŒ–ç»“æœæ˜¾ç¤º
     * @param {number|string} years - å¹´æ•°æˆ– "forever"
     * @returns {string} æ ¼å¼åŒ–åçš„æ˜¾ç¤ºæ–‡æœ¬
     */
    const formatResult = (years) => {
      if (years === "forever") {
        return "æ°¸è¿œèŠ±ä¸å®Œ";
      }
      return `ç¬¬${years}å¹´èŠ±å®Œ`;
    };

    /**
     * æ ¹æ®å¹´æ•°è·å–å¯¹åº”çš„æ ·å¼ç±»å
     * @param {number|string} years - å¹´æ•°æˆ– "forever"
     * @returns {string} CSS ç±»å
     */
    const getResultClass = (years) => {
      if (years === "forever") {
        return "forever";
      }
      if (years <= 5) {
        return "years_1_5";
      }
      if (years <= 10) {
        return "years_6_10";
      }
      if (years <= 30) {
        return "years_11_30";
      }
      return "years_31_plus";
    };

    /**
     * ç”Ÿæˆè¡¨æ ¼ HTML
     * @param {number} annualRate - å¹´åˆ©ç‡ï¼ˆç™¾åˆ†æ¯”ï¼‰
     */
    const generateTable = (annualRate) => {
      const table = document.getElementById("wealth_table");
      let html = "";

      // ç”Ÿæˆè¡¨å¤´
      html += "<thead><tr>";
      html += "<th>æ¯å¹´èŠ±è´¹</th>";
      PRINCIPAL_AMOUNTS.forEach(amount => {
        html += `<th>${formatPrincipal(amount)}</th>`;
      });
      html += "</tr></thead>";

      // ç”Ÿæˆè¡¨æ ¼å†…å®¹
      html += "<tbody>";
      ANNUAL_EXPENSES.forEach(expense => {
        html += "<tr>";
        html += `<td>æ¯å¹´èŠ±${expense}ä¸‡</td>`;
        
        PRINCIPAL_AMOUNTS.forEach(principal => {
          const years = calculateYearsUntilBroke(principal, expense, annualRate);
          const resultText = formatResult(years);
          const resultClass = getResultClass(years);
          html += `<td class="result_cell ${resultClass}">${resultText}</td>`;
        });
        
        html += "</tr>";
      });
      html += "</tbody>";

      table.innerHTML = html;
    };

    /**
     * æ›´æ–°é¡µé¢æ˜¾ç¤ºçš„åˆ©ç‡
     */
    const updateRateDisplay = () => {
      const rateInput = document.getElementById("annual_rate");
      const rateDisplay = document.getElementById("rate_display");
      rateDisplay.textContent = parseFloat(rateInput.value).toFixed(1);
    };

    /**
     * æ¸²æŸ“æ”¶å…¥æ®µé…ç½®ç•Œé¢
     */
    const renderIncomeSegments = () => {
      const container = document.getElementById("income_segments");
      let html = "";

      incomeSegments.forEach((segment, index) => {
        const isLast = index === incomeSegments.length - 1;
        const canEditEnd = isLast && segment.endYear < MAX_YEARS;
        
        html += `<div class="income_segment">`;
        html += `<span class="segment_label">å¹´ä»½</span>`;
        html += `<div class="segment_year_range">`;
        html += `<input type="number" class="segment_year_input" value="${segment.startYear}" readonly>`;
        html += `<span>åˆ°</span>`;
        
        if (canEditEnd) {
          html += `<input type="number" class="segment_year_input" 
                    value="${segment.endYear}" 
                    min="${segment.startYear}" 
                    max="${MAX_YEARS}"
                    data-index="${index}"
                    onchange="handleEndYearChange(${index}, this.value)">`;
        } else {
          html += `<input type="number" class="segment_year_input" value="${segment.endYear}" readonly>`;
        }
        
        html += `<span>å¹´</span>`;
        html += `</div>`;
        
        html += `<span class="segment_label">æ¯å¹´æ”¶å…¥</span>`;
        html += `<input type="number" class="segment_income_input" 
                  value="${segment.income}" 
                  min="0"
                  step="1"
                  data-index="${index}"
                  onchange="handleIncomeChange(${index}, this.value)"
                  placeholder="è¾“å…¥é‡‘é¢">`;
        html += `<span class="segment_label">ä¸‡å…ƒ</span>`;
        
        if (isLast && segment.endYear < MAX_YEARS) {
          html += `<span class="segment_hint">ï¼ˆä¿®æ”¹ç»“æŸå¹´ä»½å¯æ·»åŠ ä¸‹ä¸€æ®µï¼‰</span>`;
        }
        
        html += `</div>`;
      });

      container.innerHTML = html;
    };

    /**
     * å¤„ç†ç»“æŸå¹´ä»½å˜åŒ–
     * @param {number} index - æ®µçš„ç´¢å¼•
     * @param {string} value - æ–°çš„å¹´ä»½å€¼
     */
    window.handleEndYearChange = (index, value) => {
      const endYear = parseInt(value);
      
      // éªŒè¯å¹´ä»½èŒƒå›´
      if (isNaN(endYear) || endYear < incomeSegments[index].startYear || endYear > MAX_YEARS) {
        renderIncomeSegments();
        return;
      }

      // æ›´æ–°å½“å‰æ®µçš„ç»“æŸå¹´ä»½
      incomeSegments[index].endYear = endYear;

      // å¦‚æœç»“æŸå¹´ä»½å°äº50ï¼Œéœ€è¦æ·»åŠ æˆ–æ›´æ–°ä¸‹ä¸€æ®µ
      if (endYear < MAX_YEARS) {
        if (index === incomeSegments.length - 1) {
          // æ·»åŠ æ–°çš„æ®µ
          incomeSegments.push({
            startYear: endYear + 1,
            endYear: MAX_YEARS,
            income: 0
          });
        } else {
          // æ›´æ–°ä¸‹ä¸€æ®µçš„å¼€å§‹å¹´ä»½
          incomeSegments[index + 1].startYear = endYear + 1;
        }
      } else {
        // å¦‚æœç»“æŸå¹´ä»½ç­‰äº50ï¼Œåˆ é™¤åé¢çš„æ‰€æœ‰æ®µ
        incomeSegments = incomeSegments.slice(0, index + 1);
      }

      renderIncomeSegments();
      handleInputChange();
    };

    /**
     * å¤„ç†æ”¶å…¥é‡‘é¢å˜åŒ–
     * @param {number} index - æ®µçš„ç´¢å¼•
     * @param {string} value - æ–°çš„æ”¶å…¥å€¼
     */
    window.handleIncomeChange = (index, value) => {
      const income = parseFloat(value) || 0;
      incomeSegments[index].income = income;
      handleInputChange();
    };

    /**
     * å¤„ç†è¾“å…¥å˜åŒ–å¹¶é‡æ–°è®¡ç®—è¡¨æ ¼
     */
    const handleInputChange = () => {
      const annualRate = parseFloat(document.getElementById("annual_rate").value) || DEFAULT_RATE;
      
      updateRateDisplay();
      generateTable(annualRate);
    };

    /**
     * åˆå§‹åŒ–é¡µé¢
     */
    const initPage = () => {
      // ç»‘å®šåˆ©ç‡è¾“å…¥æ¡†äº‹ä»¶
      document.getElementById("annual_rate").addEventListener("input", handleInputChange);
      
      // æ¸²æŸ“æ”¶å…¥æ®µé…ç½®
      renderIncomeSegments();
      
      // åˆå§‹åŒ–è¡¨æ ¼
      generateTable(DEFAULT_RATE);
    };

    // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
    document.addEventListener("DOMContentLoaded", initPage);
  </script>
</body>
</html>

