<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è´¢å¯Œè‡ªç”±æŒ‡å—è¡¨æ ¼è®¡ç®—</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, "Microsoft YaHei", sans-serif;
            padding: 20px;
            background-color: #f5f5f5;
        }

        .container {
            max-width: 100%;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            overflow-x: auto;
        }

        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 20px;
        }

        .input_section {
            margin-bottom: 20px;
        }

        .basic_inputs {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: center;
            justify-content: center;
        }

        .income_config_section {
            background-color: #f9f9f9;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            border: 1px solid #e0e0e0;
        }

        .income_config_title {
            font-size: 16px;
            font-weight: bold;
            color: #333;
            margin-bottom: 15px;
            text-align: center;
        }

        .income_segments {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .income_segment {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
            background-color: white;
            padding: 10px;
            border-radius: 6px;
            border: 1px solid #ddd;
        }

        .segment_label {
            color: #666;
            font-size: 14px;
            white-space: nowrap;
        }

        .segment_year_range {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .segment_year_input {
            width: 70px;
            padding: 6px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        .segment_income_input {
            width: 120px;
            padding: 6px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        .input_group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .input_group label {
            font-weight: bold;
            color: #555;
        }

        .input_group input {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            width: 150px;
        }

        .input_group input:focus,
        .segment_year_input:focus,
        .segment_income_input:focus {
            outline: none;
            border-color: #4CAF50;
        }

        .segment_hint {
            color: #999;
            font-size: 12px;
            font-style: italic;
        }

        .table_wrapper {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            margin-top: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
            min-width: 800px;
        }

        th,
        td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: center;
            min-width: 80px;
            white-space: nowrap;
        }

        th {
            background-color: #FFE599;
            font-weight: bold;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        td:first-child,
        th:first-child {
            background-color: #B4C7E7;
            font-weight: bold;
            position: sticky;
            left: 0;
            z-index: 5;
        }

        th:first-child {
            z-index: 15;
        }

        .result_cell {
            font-weight: 500;
        }

        .result_cell.forever {
            background-color: #C6E0B4;
            color: #2E7D32;
        }

        .result_cell.years_1_5 {
            background-color: #FF6B6B;
            color: white;
        }

        .result_cell.years_6_10 {
            background-color: #FFA500;
            color: white;
        }

        .result_cell.years_11_30 {
            background-color: #FFD966;
            color: #333;
        }

        .result_cell.years_31_plus {
            background-color: #9BC2E6;
            color: #333;
        }

        .description_section {
            margin-top: 30px;
            padding: 20px;
            background-color: #f9f9f9;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
        }

        .description_title {
            font-size: 18px;
            font-weight: bold;
            color: #333;
            margin-bottom: 15px;
            border-bottom: 2px solid #4CAF50;
            padding-bottom: 10px;
        }

        .description_content {
            color: #555;
            line-height: 1.8;
        }

        .description_content h3 {
            font-size: 16px;
            color: #333;
            margin-top: 20px;
            margin-bottom: 10px;
            font-weight: bold;
        }

        .description_content h3:first-child {
            margin-top: 0;
        }

        .description_content p {
            margin-bottom: 12px;
        }

        .description_content ul {
            margin: 10px 0;
            padding-left: 20px;
        }

        .description_content li {
            margin-bottom: 8px;
        }

        .description_content code {
            background-color: #fff;
            padding: 2px 6px;
            border-radius: 3px;
            color: #e91e63;
            font-family: "Courier New", monospace;
            border: 1px solid #e0e0e0;
        }

        .formula_box {
            background-color: #fff;
            padding: 15px;
            border-radius: 6px;
            border-left: 4px solid #4CAF50;
            margin: 15px 0;
            font-family: "Courier New", monospace;
        }

        .color_legend {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin: 15px 0;
        }

        .color_item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .color_box {
            width: 30px;
            height: 20px;
            border-radius: 3px;
            border: 1px solid #ddd;
        }

        .color_box.forever {
            background-color: #C6E0B4;
        }

        .color_box.years_1_5 {
            background-color: #FF6B6B;
        }

        .color_box.years_6_10 {
            background-color: #FFA500;
        }

        .color_box.years_11_30 {
            background-color: #FFD966;
        }

        .color_box.years_31_plus {
            background-color: #9BC2E6;
        }

        @media (max-width: 768px) {
            body {
                padding: 10px;
            }

            .container {
                padding: 15px;
            }

            h1 {
                font-size: 18px;
                margin-bottom: 15px;
            }

            .basic_inputs {
                flex-direction: column;
            }

            .income_segment {
                flex-direction: column;
                align-items: flex-start;
            }

            .income_config_section {
                padding: 10px;
            }

            .income_config_title {
                font-size: 14px;
            }

            table {
                font-size: 10px;
                min-width: 600px;
            }

            th,
            td {
                padding: 5px;
                min-width: 50px;
            }

            .description_section {
                padding: 15px;
                margin-top: 20px;
            }

            .description_title {
                font-size: 16px;
            }

            .description_content {
                font-size: 14px;
            }

            .description_content h3 {
                font-size: 15px;
            }

            .color_legend {
                gap: 10px;
            }

            .formula_box {
                padding: 10px;
                font-size: 12px;
                overflow-x: auto;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>è´¢å¯Œè‡ªç”±æŒ‡å— - æœ¬é‡‘ï¼ˆå¹´åˆ©ç‡ <span id="rate_display">2.0</span>%ï¼‰</h1>

        <div class="input_section">
            <div class="basic_inputs">
                <div class="input_group">
                    <label for="annual_rate">å¹´åˆ©ç‡ï¼ˆ%ï¼‰ï¼š</label>
                    <input type="number" id="annual_rate" value="2.0" step="0.1" min="0" max="100">
                </div>
                <div class="input_group">
                    <label for="max_years">è®¡ç®—å¹´ä»½ï¼š</label>
                    <input type="number" id="max_years" value="50" step="1" min="10" max="200">
                </div>
            </div>

            <div class="income_config_section">
                <div class="income_config_title">ğŸ’° åˆ†æ®µæ”¶å…¥é…ç½®ï¼ˆæœ€å¤š<span id="max_years_display">50</span>å¹´ï¼‰</div>
                <div id="income_segments" class="income_segments">
                    <!-- æ”¶å…¥æ®µå°†åŠ¨æ€ç”Ÿæˆ -->
                </div>
            </div>
        </div>

        <div class="table_wrapper">
            <table id="wealth_table">
                <!-- è¡¨æ ¼å†…å®¹å°†é€šè¿‡ JavaScript åŠ¨æ€ç”Ÿæˆ -->
            </table>
        </div>

        <div class="description_section">
            <div class="description_title">ğŸ“Š è®¡ç®—é€»è¾‘è¯´æ˜</div>
            <div class="description_content">
                <h3>ğŸ’¡ å·¥å…·ç”¨é€”</h3>
                <p>è¿™ä¸ªå·¥å…·å¸®åŠ©ä½ è®¡ç®—åœ¨ä¸åŒæœ¬é‡‘ã€æ¶ˆè´¹æ°´å¹³å’Œæ”¶å…¥æ¡ä»¶ä¸‹ï¼Œä½ çš„èµ„äº§èƒ½å¤Ÿç»´æŒå¤šå°‘å¹´ï¼Œä»è€Œè§„åˆ’è´¢å¯Œè‡ªç”±ä¹‹è·¯ã€‚</p>

                <h3>ğŸ§® æ ¸å¿ƒè®¡ç®—å…¬å¼</h3>
                <div class="formula_box">
                    <strong>ç¬¬Nå¹´å¹´åº•æœ¬é‡‘ = (ç¬¬Nå¹´å¹´åˆæœ¬é‡‘ + ç¬¬Nå¹´æ”¶å…¥ - ç¬¬Nå¹´æ¶ˆè´¹) Ã— (1 + å¹´åˆ©ç‡)</strong>
                </div>
                <p>è®¡ç®—è¿‡ç¨‹ï¼š</p>
                <ul>
                    <li><strong>å¹´åˆæœ¬é‡‘ï¼š</strong>ä¸Šä¸€å¹´å¹´åº•å‰©ä½™çš„æœ¬é‡‘</li>
                    <li><strong>ç¬¬Nå¹´æ”¶å…¥ï¼š</strong>æ ¹æ®åˆ†æ®µé…ç½®è·å–è¯¥å¹´çš„æ”¶å…¥é‡‘é¢</li>
                    <li><strong>ç¬¬Nå¹´æ¶ˆè´¹ï¼š</strong>è¡¨æ ¼ç¬¬ä¸€åˆ—å¯¹åº”çš„æ¯å¹´æ¶ˆè´¹é‡‘é¢</li>
                    <li><strong>å¹´åˆ©ç‡ï¼š</strong>é¡µé¢é¡¶éƒ¨è¾“å…¥çš„å¹´åˆ©ç‡ï¼ˆå¦‚2%è¡¨ç¤º0.02ï¼‰</li>
                </ul>

                <h3>ğŸ”„ è®¡ç®—æµç¨‹</h3>
                <p>å¯¹äºæ¯ä¸ªæœ¬é‡‘å’Œæ¶ˆè´¹ç»„åˆï¼Œç³»ç»Ÿä¼šè¿›è¡Œä»¥ä¸‹è®¡ç®—ï¼š</p>
                <ul>
                    <li><strong>ç¬¬1æ­¥ï¼š</strong>è®¡ç®—ç¬¬1å¹´å¹´åˆå¯ç”¨é‡‘é¢ = åˆå§‹æœ¬é‡‘ + ç¬¬1å¹´æ”¶å…¥ - ç¬¬1å¹´æ¶ˆè´¹</li>
                    <li><strong>ç¬¬2æ­¥ï¼š</strong>å¦‚æœå¯ç”¨é‡‘é¢ â‰¥ åˆå§‹æœ¬é‡‘ï¼Œåˆ¤å®šä¸º"æ°¸è¿œèŠ±ä¸å®Œ"ï¼ˆé’±è¶Šæ¥è¶Šå¤šï¼‰</li>
                    <li><strong>ç¬¬3æ­¥ï¼š</strong>å¦‚æœå¯ç”¨é‡‘é¢ â‰¤ 0ï¼Œè®°å½•ä¸º"ç¬¬1å¹´èŠ±å®Œ"</li>
                    <li><strong>ç¬¬4æ­¥ï¼š</strong>å¦åˆ™ï¼Œè®¡ç®—å¹´åº•æœ¬é‡‘ = å¯ç”¨é‡‘é¢ Ã— (1 + å¹´åˆ©ç‡)</li>
                    <li><strong>ç¬¬5æ­¥ï¼š</strong>è¿›å…¥ç¬¬2å¹´ï¼Œé‡å¤ä»¥ä¸Šæ­¥éª¤ï¼Œç›´åˆ°é’±èŠ±å®Œæˆ–è¶…è¿‡1000å¹´</li>
                </ul>

                <h3>ğŸ’° åˆ†æ®µæ”¶å…¥é…ç½®</h3>
                <p>æ”¯æŒä¸ºä¸åŒå¹´ä»½æ®µè®¾ç½®ä¸åŒçš„æ”¶å…¥ï¼Œæ¨¡æ‹ŸçœŸå®çš„äººç”Ÿè´¢åŠ¡è§„åˆ’ï¼š</p>
                <ul>
                    <li><strong>å·¥ä½œæœŸï¼š</strong>ä¾‹å¦‚1-30å¹´ï¼Œæ¯å¹´æœ‰ç¨³å®šæ”¶å…¥</li>
                    <li><strong>é€€ä¼‘æœŸï¼š</strong>ä¾‹å¦‚31-50å¹´ï¼Œæ”¶å…¥é™ä½æˆ–ä¸º0</li>
                    <li>å¯æ·»åŠ å¤šä¸ªæ—¶é—´æ®µï¼Œæœ€å¤šé…ç½®åˆ°ç¬¬50å¹´</li>
                </ul>

                <h3>ğŸ¨ ç»“æœé¢œè‰²è¯´æ˜</h3>
                <div class="color_legend">
                    <div class="color_item">
                        <div class="color_box years_1_5"></div>
                        <span>1-5å¹´èŠ±å®Œï¼ˆçº¢è‰²ï¼‰- é£é™©æé«˜</span>
                    </div>
                    <div class="color_item">
                        <div class="color_box years_6_10"></div>
                        <span>6-10å¹´èŠ±å®Œï¼ˆæ©™è‰²ï¼‰- é£é™©è¾ƒé«˜</span>
                    </div>
                    <div class="color_item">
                        <div class="color_box years_11_30"></div>
                        <span>11-30å¹´èŠ±å®Œï¼ˆé»„è‰²ï¼‰- ä¸­ç­‰é£é™©</span>
                    </div>
                    <div class="color_item">
                        <div class="color_box years_31_plus"></div>
                        <span>31å¹´ä»¥ä¸ŠèŠ±å®Œï¼ˆè“è‰²ï¼‰- ç›¸å¯¹å®‰å…¨</span>
                    </div>
                    <div class="color_item">
                        <div class="color_box forever"></div>
                        <span>æ°¸è¿œèŠ±ä¸å®Œï¼ˆç»¿è‰²ï¼‰- è´¢å¯Œè‡ªç”±</span>
                    </div>
                </div>

                <h3>ğŸ“ ä½¿ç”¨ç¤ºä¾‹</h3>
                <p><strong>åœºæ™¯ï¼š</strong>æœ¬é‡‘100ä¸‡ï¼Œæ¯å¹´æ¶ˆè´¹10ä¸‡ï¼Œå¹´åˆ©ç‡2%ï¼Œå‰30å¹´æ¯å¹´æ”¶å…¥20ä¸‡</p>
                <ul>
                    <li><strong>ç¬¬1å¹´åˆï¼š</strong>å¯ç”¨ = 100 + 20 - 10 = 110ä¸‡ â‰¥ 100ä¸‡ â†’ åˆ¤å®šä¸º"æ°¸è¿œèŠ±ä¸å®Œ"</li>
                </ul>
                <p><strong>åœºæ™¯ï¼š</strong>æœ¬é‡‘100ä¸‡ï¼Œæ¯å¹´æ¶ˆè´¹20ä¸‡ï¼Œå¹´åˆ©ç‡2%ï¼Œæ— æ”¶å…¥</p>
                <ul>
                    <li><strong>ç¬¬1å¹´åˆï¼š</strong>å¯ç”¨ = 100 + 0 - 20 = 80ä¸‡</li>
                    <li><strong>ç¬¬1å¹´åº•ï¼š</strong>æœ¬é‡‘ = 80 Ã— 1.02 = 81.6ä¸‡</li>
                    <li><strong>ç¬¬2å¹´åˆï¼š</strong>å¯ç”¨ = 81.6 + 0 - 20 = 61.6ä¸‡</li>
                    <li><strong>ç¬¬2å¹´åº•ï¼š</strong>æœ¬é‡‘ = 61.6 Ã— 1.02 = 62.832ä¸‡</li>
                    <li>...ä»¥æ­¤ç±»æ¨ï¼Œç›´åˆ°æŸå¹´å¯ç”¨é‡‘é¢ â‰¤ 0</li>
                </ul>

                <h3>âš ï¸ æ³¨æ„äº‹é¡¹</h3>
                <ul>
                    <li>è®¡ç®—ç»“æœåŸºäºç†æƒ³åŒ–å‡è®¾ï¼Œä¸è€ƒè™‘é€šè´§è†¨èƒ€ã€ç¨æ”¶ã€åŒ»ç–—ç­‰é¢å¤–æ”¯å‡º</li>
                    <li>å¹´åˆ©ç‡åº”æ ¹æ®å®é™…æŠ•èµ„æ”¶ç›Šç‡è®¾ç½®ï¼ˆå¦‚å›½å€º2%ã€ç†è´¢4%ã€è‚¡ç¥¨8%ç­‰ï¼‰</li>
                    <li>å»ºè®®åœ¨å®é™…è§„åˆ’æ—¶é¢„ç•™ä¸€å®šçš„å®‰å…¨è¾¹é™…</li>
                    <li>æœ¬å·¥å…·ä»…ä¾›å‚è€ƒï¼Œä¸æ„æˆæŠ•èµ„å»ºè®®</li>
                </ul>
            </div>
        </div>
    </div>

    <script>
        // ç¬¬ä¸€è¡Œï¼šæœ¬é‡‘æ•°æ®ï¼ˆä¸‡å…ƒï¼‰
        const PRINCIPAL_AMOUNTS = [10, 20, 30, 50, 100, 150, 200, 300, 500, 1000, 2000, 5000, 10000];

        // ç¬¬ä¸€åˆ—ï¼šæ¯å¹´æ¶ˆè´¹æ•°æ®ï¼ˆä¸‡å…ƒï¼‰
        const ANNUAL_EXPENSES = [2, 3.5, 5, 10, 20, 30, 50, 75, 100, 150, 200, 250, 300, 500];

        // é»˜è®¤é…ç½®
        const DEFAULT_RATE = 2.0;
        const DEFAULT_MAX_YEARS = 50;
        let MAX_YEARS = DEFAULT_MAX_YEARS;

        // æ”¶å…¥æ®µé…ç½®æ•°ç»„
        let incomeSegments = [
            { startYear: 1, endYear: DEFAULT_MAX_YEARS, income: 0 }
        ];

        /**
         * æ ¼å¼åŒ–æœ¬é‡‘æ˜¾ç¤º
         * @param {number} amount - é‡‘é¢ï¼ˆä¸‡å…ƒï¼‰
         * @returns {string} æ ¼å¼åŒ–åçš„å­—ç¬¦ä¸²
         */
        const formatPrincipal = (amount) => {
            if (amount >= 10000) {
                return `${amount / 10000}äº¿å…ƒ`;
            }
            return `${amount}ä¸‡`;
        };

        /**
         * æ ¹æ®å¹´ä»½è·å–å¯¹åº”çš„æ”¶å…¥
         * @param {number} year - å¹´ä»½
         * @returns {number} è¯¥å¹´ä»½çš„æ”¶å…¥ï¼ˆä¸‡å…ƒï¼‰
         */
        const getIncomeByYear = (year) => {
            for (const segment of incomeSegments) {
                if (year >= segment.startYear && year <= segment.endYear) {
                    return segment.income;
                }
            }
            return 0;
        };

        /**
         * è®¡ç®—åœ¨ç»™å®šæ¡ä»¶ä¸‹èƒ½æ¶ˆè´¹å¤šå°‘å¹´
         * @param {number} initialPrincipal - åˆå§‹æœ¬é‡‘ï¼ˆä¸‡å…ƒï¼‰
         * @param {number} annualExpense - æ¯å¹´æ¶ˆè´¹ï¼ˆä¸‡å…ƒï¼‰
         * @param {number} annualRate - å¹´åˆ©ç‡ï¼ˆç™¾åˆ†æ¯”ï¼‰
         * @returns {number|string} å¯æ¶ˆè´¹å¹´æ•°ï¼Œæˆ– "forever" è¡¨ç¤ºæ°¸è¿œèŠ±ä¸å®Œ
         */
        const calculateYearsUntilBroke = (initialPrincipal, annualExpense, annualRate) => {
            // è½¬æ¢åˆ©ç‡ä¸ºå°æ•°
            const rateDecimal = annualRate / 100;

            // å½“å‰æœ¬é‡‘
            let currentPrincipal = initialPrincipal;

            // å¹´ä»½è®¡æ•°å™¨
            let years = 0;

            // æŒç»­è®¡ç®—ç›´åˆ°é’±èŠ±å®Œæˆ–è¶…è¿‡è®¾å®šçš„æœ€å¤§å¹´é™
            while (years < MAX_YEARS) {
                // è·å–å½“å‰å¹´ä»½çš„æ”¶å…¥
                const currentYearIncome = getIncomeByYear(years + 1);

                // è®¡ç®—å¹´åˆå¯ç”¨é‡‘é¢
                const availableAmount = currentPrincipal + currentYearIncome - annualExpense;

                // åˆ¤æ–­æ˜¯å¦è¿™ä¸€å¹´å°±èŠ±å®Œäº†
                if (availableAmount <= 0) {
                    return years + 1;
                }

                // è®¡ç®—å¹´åº•æœ¬é‡‘ï¼ˆåŠ ä¸Šåˆ©æ¯ï¼‰
                currentPrincipal = availableAmount * (1 + rateDecimal);

                // å¹´ä»½åŠ ä¸€
                years++;
            }

            // å¦‚æœè¶…è¿‡è®¾å®šçš„æœ€å¤§å¹´é™è¿˜æ²¡èŠ±å®Œï¼Œè®¤ä¸ºæ˜¯æ°¸è¿œèŠ±ä¸å®Œ
            return "forever";
        };

        /**
         * æ ¼å¼åŒ–ç»“æœæ˜¾ç¤º
         * @param {number|string} years - å¹´æ•°æˆ– "forever"
         * @returns {string} æ ¼å¼åŒ–åçš„æ˜¾ç¤ºæ–‡æœ¬
         */
        const formatResult = (years) => {
            if (years === "forever") {
                return "æ°¸è¿œèŠ±ä¸å®Œ";
            }
            return `ç¬¬${years}å¹´èŠ±å®Œ`;
        };

        /**
         * æ ¹æ®å¹´æ•°è·å–å¯¹åº”çš„æ ·å¼ç±»å
         * @param {number|string} years - å¹´æ•°æˆ– "forever"
         * @returns {string} CSS ç±»å
         */
        const getResultClass = (years) => {
            if (years === "forever") {
                return "forever";
            }
            if (years <= 5) {
                return "years_1_5";
            }
            if (years <= 10) {
                return "years_6_10";
            }
            if (years <= 30) {
                return "years_11_30";
            }
            return "years_31_plus";
        };

        /**
         * ç”Ÿæˆè¡¨æ ¼ HTML
         * @param {number} annualRate - å¹´åˆ©ç‡ï¼ˆç™¾åˆ†æ¯”ï¼‰
         */
        const generateTable = (annualRate) => {
            const table = document.getElementById("wealth_table");
            let html = "";

            // ç”Ÿæˆè¡¨å¤´
            html += "<thead><tr>";
            html += "<th>æ¯å¹´èŠ±è´¹</th>";
            PRINCIPAL_AMOUNTS.forEach(amount => {
                html += `<th>${formatPrincipal(amount)}</th>`;
            });
            html += "</tr></thead>";

            // ç”Ÿæˆè¡¨æ ¼å†…å®¹
            html += "<tbody>";
            ANNUAL_EXPENSES.forEach(expense => {
                html += "<tr>";
                html += `<td>æ¯å¹´èŠ±${expense}ä¸‡</td>`;

                PRINCIPAL_AMOUNTS.forEach(principal => {
                    const years = calculateYearsUntilBroke(principal, expense, annualRate);
                    const resultText = formatResult(years);
                    const resultClass = getResultClass(years);
                    html += `<td class="result_cell ${resultClass}">${resultText}</td>`;
                });

                html += "</tr>";
            });
            html += "</tbody>";

            table.innerHTML = html;
        };

        /**
         * æ›´æ–°é¡µé¢æ˜¾ç¤ºçš„åˆ©ç‡
         */
        const updateRateDisplay = () => {
            const rateInput = document.getElementById("annual_rate");
            const rateDisplay = document.getElementById("rate_display");
            rateDisplay.textContent = parseFloat(rateInput.value).toFixed(1);
        };

        /**
         * æ›´æ–°æœ€å¤§å¹´ä»½é…ç½®
         */
        const updateMaxYears = () => {
            const maxYearsInput = document.getElementById("max_years");
            const maxYearsDisplay = document.getElementById("max_years_display");
            const newMaxYears = parseInt(maxYearsInput.value) || DEFAULT_MAX_YEARS;
            
            MAX_YEARS = newMaxYears;
            maxYearsDisplay.textContent = MAX_YEARS;
            
            // æ›´æ–°æ”¶å…¥æ®µé…ç½®
            const lastSegment = incomeSegments[incomeSegments.length - 1];
            if (lastSegment.endYear > MAX_YEARS) {
                lastSegment.endYear = MAX_YEARS;
                // åˆ é™¤è¶…å‡ºèŒƒå›´çš„æ®µ
                incomeSegments = incomeSegments.filter(seg => seg.startYear <= MAX_YEARS);
            } else if (lastSegment.endYear < MAX_YEARS) {
                lastSegment.endYear = MAX_YEARS;
            }
            
            renderIncomeSegments();
        };

        /**
         * æ¸²æŸ“æ”¶å…¥æ®µé…ç½®ç•Œé¢
         */
        const renderIncomeSegments = () => {
            const container = document.getElementById("income_segments");
            let html = "";

            incomeSegments.forEach((segment, index) => {
                const isLast = index === incomeSegments.length - 1;

                html += `<div class="income_segment">`;
                html += `<span class="segment_label">å¹´ä»½</span>`;
                html += `<div class="segment_year_range">`;
                html += `<input type="number" class="segment_year_input" value="${segment.startYear}" readonly>`;
                html += `<span>åˆ°</span>`;

                // æœ€åä¸€æ®µçš„ç»“æŸå¹´ä»½å§‹ç»ˆå¯ä»¥ç¼–è¾‘
                if (isLast) {
                    html += `<input type="number" class="segment_year_input" 
                    value="${segment.endYear}" 
                    min="${segment.startYear}" 
                    max="${MAX_YEARS}"
                    data-index="${index}"
                    onchange="handleEndYearChange(${index}, this.value)">`;
                } else {
                    html += `<input type="number" class="segment_year_input" value="${segment.endYear}" readonly>`;
                }

                html += `<span>å¹´</span>`;
                html += `</div>`;

                html += `<span class="segment_label">æ¯å¹´æ”¶å…¥</span>`;
                html += `<input type="number" class="segment_income_input" 
                  value="${segment.income}" 
                  min="0"
                  step="1"
                  data-index="${index}"
                  onchange="handleIncomeChange(${index}, this.value)"
                  placeholder="è¾“å…¥é‡‘é¢">`;
                html += `<span class="segment_label">ä¸‡å…ƒ</span>`;

                // åªæœ‰åœ¨æœ€åä¸€æ®µä¸”ç»“æŸå¹´ä»½å°äº50æ—¶ï¼Œæ‰æ˜¾ç¤ºæç¤º
                if (isLast && segment.endYear < MAX_YEARS) {
                    html += `<span class="segment_hint">ï¼ˆä¿®æ”¹ç»“æŸå¹´ä»½å¯æ·»åŠ ä¸‹ä¸€æ®µï¼‰</span>`;
                }

                html += `</div>`;
            });

            container.innerHTML = html;
        };

        /**
         * å¤„ç†ç»“æŸå¹´ä»½å˜åŒ–
         * @param {number} index - æ®µçš„ç´¢å¼•
         * @param {string} value - æ–°çš„å¹´ä»½å€¼
         */
        window.handleEndYearChange = (index, value) => {
            let endYear = parseInt(value);

            // éªŒè¯å¹´ä»½æ˜¯å¦ä¸ºæœ‰æ•ˆæ•°å­—
            if (isNaN(endYear)) {
                renderIncomeSegments();
                return;
            }

            // å¦‚æœå°äºå¼€å§‹å¹´ä»½ï¼Œè®¾ç½®ä¸ºå¼€å§‹å¹´ä»½
            if (endYear < incomeSegments[index].startYear) {
                endYear = incomeSegments[index].startYear;
            }

            // å¦‚æœè¶…è¿‡50ï¼Œè‡ªåŠ¨è®¾ç½®ä¸º50
            if (endYear > MAX_YEARS) {
                endYear = MAX_YEARS;
            }

            // æ›´æ–°å½“å‰æ®µçš„ç»“æŸå¹´ä»½
            incomeSegments[index].endYear = endYear;

            // å¦‚æœç»“æŸå¹´ä»½å°äº50ï¼Œéœ€è¦æ·»åŠ æˆ–æ›´æ–°ä¸‹ä¸€æ®µ
            if (endYear < MAX_YEARS) {
                if (index === incomeSegments.length - 1) {
                    // æ·»åŠ æ–°çš„æ®µ
                    incomeSegments.push({
                        startYear: endYear + 1,
                        endYear: MAX_YEARS,
                        income: 0
                    });
                } else {
                    // æ›´æ–°ä¸‹ä¸€æ®µçš„å¼€å§‹å¹´ä»½
                    incomeSegments[index + 1].startYear = endYear + 1;
                }
            } else {
                // å¦‚æœç»“æŸå¹´ä»½ç­‰äº50ï¼Œåˆ é™¤åé¢çš„æ‰€æœ‰æ®µ
                incomeSegments = incomeSegments.slice(0, index + 1);
            }

            renderIncomeSegments();
            handleInputChange();
        };

        /**
         * å¤„ç†æ”¶å…¥é‡‘é¢å˜åŒ–
         * @param {number} index - æ®µçš„ç´¢å¼•
         * @param {string} value - æ–°çš„æ”¶å…¥å€¼
         */
        window.handleIncomeChange = (index, value) => {
            const income = parseFloat(value) || 0;
            incomeSegments[index].income = income;
            handleInputChange();
        };

        /**
         * å¤„ç†è¾“å…¥å˜åŒ–å¹¶é‡æ–°è®¡ç®—è¡¨æ ¼
         */
        const handleInputChange = () => {
            const annualRate = parseFloat(document.getElementById("annual_rate").value) || DEFAULT_RATE;

            updateRateDisplay();
            generateTable(annualRate);
        };

        /**
         * å¤„ç†æœ€å¤§å¹´ä»½å˜åŒ–
         */
        const handleMaxYearsChange = () => {
            updateMaxYears();
            handleInputChange();
        };

        /**
         * åˆå§‹åŒ–é¡µé¢
         */
        const initPage = () => {
            // ç»‘å®šåˆ©ç‡è¾“å…¥æ¡†äº‹ä»¶
            document.getElementById("annual_rate").addEventListener("input", handleInputChange);

            // ç»‘å®šæœ€å¤§å¹´ä»½è¾“å…¥æ¡†äº‹ä»¶
            document.getElementById("max_years").addEventListener("input", handleMaxYearsChange);

            // æ¸²æŸ“æ”¶å…¥æ®µé…ç½®
            renderIncomeSegments();

            // åˆå§‹åŒ–è¡¨æ ¼
            generateTable(DEFAULT_RATE);
        };

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener("DOMContentLoaded", initPage);
    </script>
</body>

</html>