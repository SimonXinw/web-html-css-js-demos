<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>å›¾ç‰‡è½¬æ¢å·¥å…·</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    /* ä¸»å®¹å™¨ */
    .main-container {
      max-width: 100%;
      margin: 0 auto;
      background: white;
      border-radius: 20px;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
      overflow: hidden;
    }

    /* é¡¶éƒ¨æ§åˆ¶åŒºåŸŸ */
    .header-section {
      background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
      padding: 30px;
      color: white;
    }

    .header-title {
      font-size: 28px;
      font-weight: 600;
      margin-bottom: 20px;
      text-align: center;
    }

    .controls-container {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      align-items: center;
      justify-content: center;
    }

    .control-group {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 5px;
    }

    .control-group label {
      font-size: 14px;
      font-weight: 500;
    }

    .control-input {
      padding: 8px 12px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      background: rgba(255, 255, 255, 0.9);
      color: #333;
      min-width: 120px;
    }

    .control-input:focus {
      outline: none;
      background: white;
      box-shadow: 0 0 0 3px rgba(255, 255, 255, 0.3);
    }

    .file-input-wrapper {
      position: relative;
      overflow: hidden;
      display: inline-block;
    }

    .file-input-button {
      background: rgba(255, 255, 255, 0.2);
      color: white;
      padding: 12px 24px;
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-radius: 25px;
      cursor: pointer;
      font-size: 16px;
      font-weight: 500;
      transition: all 0.3s ease;
      backdrop-filter: blur(10px);
    }

    .file-input-button:hover {
      background: rgba(255, 255, 255, 0.3);
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    #fileInput {
      position: absolute;
      left: -9999px;
      opacity: 0;
    }

    .action-buttons {
      display: flex;
      gap: 15px;
      justify-content: center;
      flex-wrap: wrap;
    }

    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 25px;
      font-size: 16px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
      text-decoration: none;
      display: inline-block;
      text-align: center;
    }

    .btn-primary {
      background: #ff6b6b;
      color: white;
    }

    .btn-secondary {
      background: rgba(255, 255, 255, 0.2);
      color: white;
      border: 2px solid rgba(255, 255, 255, 0.3);
    }

    .btn-success {
      background: #51cf66;
      color: white;
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    /* å†…å®¹åŒºåŸŸ */
    .content-section {
      padding: 30px;
    }

    /* çŠ¶æ€æ¶ˆæ¯ */
    #statusMessage {
      text-align: center;
      font-size: 16px;
      font-weight: 500;
      margin-bottom: 20px;
      padding: 15px;
      border-radius: 10px;
      background: #e3f2fd;
      color: #1976d2;
      border-left: 4px solid #2196f3;
    }

    /* å›¾ç‰‡ç½‘æ ¼ */
    #result {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(239px, 1fr));
      gap: 15px;
      margin-top: 20px;
    }

    .image-container {
      background: white;
      border-radius: 15px;
      padding: 15px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      border: 1px solid #f0f0f0;
    }

    .image-container:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
    }

    .image-wrapper {
      width: 100%;
      height: 125px;
      border-radius: 10px;
      overflow: hidden;
      background: #f8f9fa;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .image-wrapper img {
      width: 100%;
      height: 100%;
      object-fit: contain;
      border-radius: 10px;
    }

    .file-name {
      margin-top: 12px;
      font-size: 14px;
      font-weight: 500;
      color: #333;
      text-align: center;
      word-break: break-all;
    }

    .size-info {
      margin-top: 8px;
      font-size: 12px;
      text-align: center;
      font-weight: 500;
    }

    .individual-download {
      margin-top: 12px;
      display: block;
      text-align: center;
      padding: 8px 16px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      text-decoration: none;
      border-radius: 20px;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.3s ease;
    }

    .individual-download:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
    }

    /* æ‹–æ‹½è¦†ç›–å±‚ */
    .drag-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(102, 126, 234, 0.9);
      backdrop-filter: blur(10px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      font-size: 32px;
      color: white;
      font-weight: 600;
      text-align: center;
      /* æ·»åŠ è™šçº¿è¾¹æ¡†æ•ˆæœ */
      border: 3px dashed #4fd1c5;
      box-sizing: border-box;
      margin: 20px;
      border-radius: 20px;
      /* æ·»åŠ è¾¹æ¡†åŠ¨ç”»æ•ˆæœ */
      animation: borderPulse 2s ease-in-out infinite;
    }

    .drag-overlay.show {
      display: flex;
    }

    .drag-overlay::before {
      content: "ğŸ–¼ï¸ æ‹–æ‹½å›¾ç‰‡åˆ°æ­¤å¤„å¼€å§‹è½¬æ¢";
      animation: pulse 2s infinite;
    }

    @keyframes pulse {

      0%,
      100% {
        opacity: 1;
      }

      50% {
        opacity: 0.7;
      }
    }

    /* è¾¹æ¡†æ¸äº®æ¸æš—åŠ¨ç”» */
    @keyframes borderPulse {
      0% {
        border-color: rgba(79, 209, 197, 0.3);
        box-shadow: 0 0 0 rgba(79, 209, 197, 0.3);
      }

      50% {
        border-color: rgba(79, 209, 197, 1);
        box-shadow: 0 0 20px rgba(79, 209, 197, 0.6);
      }

      100% {
        border-color: rgba(79, 209, 197, 0.3);
        box-shadow: 0 0 0 rgba(79, 209, 197, 0.3);
      }
    }

    /* å“åº”å¼è®¾è®¡ */
    @media (max-width: 768px) {
      .controls-container {
        justify-content: flex-start;
        /* ç§»åŠ¨ç«¯æŒ‰é’®å°ºå¯¸è°ƒæ•´ */
      }

      .btn,
      .file-input-button {
        padding: 10px 16px;
        font-size: 14px;
      }

      .control-input {
        min-width: inherit;
      }

      .action-buttons {
        width: 100%;
      }

      #result {
        grid-template-columns: 1fr;
      }

      .header-title {
        font-size: 24px;
      }
    }
  </style>
  <!-- åŠ è½½JSZipå’ŒFileSaver.jsï¼Œç”¨äºå‹ç¼©å’Œä¸‹è½½æ–‡ä»¶ -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
</head>

<body>
  <!-- æ‹–æ‹½è¦†ç›–å±‚ -->
  <div id="dragOverlay" class="drag-overlay"></div>

  <div class="main-container">
    <!-- é¡¶éƒ¨æ§åˆ¶åŒºåŸŸ -->
    <div class="header-section">
      <h1 class="header-title">ğŸ¨ æ™ºèƒ½å›¾ç‰‡å‹ç¼©è½¬æ¢å·¥å…·</h1>

      <div class="controls-container">
        <!-- æ–‡ä»¶é€‰æ‹© -->
        <div class="control-group">
          <label>é€‰æ‹©å›¾ç‰‡</label>
          <div class="file-input-wrapper">
            <div class="file-input-button" onclick="document.getElementById('fileInput').click()">
              ğŸ“ é€‰æ‹©æ–‡ä»¶
            </div>
            <input type="file" id="fileInput" accept="image/*" multiple />
          </div>
        </div>

        <!-- è¾“å‡ºæ ¼å¼é€‰æ‹© -->
        <div class="control-group">
          <label>è¾“å‡ºæ ¼å¼</label>
          <select id="formatSelect" class="control-input">
            <option value="image/jpeg">JPEG</option>
            <option value="image/png">PNG</option>
            <option value="image/webp" selected>WEBP</option>
          </select>
        </div>

        <!-- è´¨é‡è¾“å…¥æ¡† -->
        <div class="control-group">
          <label>å‹ç¼©è´¨é‡</label>
          <input type="number" id="qualityInput" class="control-input" min="1" max="100" value="80"
            placeholder="1-100" />
        </div>

        <!-- æ“ä½œæŒ‰é’® -->
        <div class="action-buttons">
          <button id="convertButton" class="btn btn-primary">
            ğŸš€ å¼€å§‹è½¬æ¢
          </button>
          <button id="clearButton" class="btn btn-secondary">
            ğŸ—‘ï¸ æ¸…é™¤å›¾ç‰‡
          </button>
          <a id="downloadButton" class="btn btn-success" style="display: none">ğŸ“¦ ä¸‹è½½å…¨éƒ¨</a>
        </div>
      </div>
    </div>

    <!-- å†…å®¹åŒºåŸŸ -->
    <div class="content-section">
      <!-- çŠ¶æ€æ¶ˆæ¯ -->
      <div id="statusMessage" style="display: none"></div>

      <!-- å±•ç¤ºè½¬æ¢åçš„å›¾ç‰‡ -->
      <div id="result"></div>
    </div>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", function () {
      // è·å–å…ƒç´ çš„å¼•ç”¨
      const fileInput = document.getElementById("fileInput");
      const formatSelect = document.getElementById("formatSelect");
      const qualityInput = document.getElementById("qualityInput");
      const downloadButton = document.getElementById("downloadButton");
      const clearButton = document.getElementById("clearButton");
      const resultDiv = document.getElementById("result");
      const statusMessage = document.getElementById("statusMessage");
      const dragOverlay = document.getElementById("dragOverlay");

      let imagesData = []; // å­˜å‚¨æ¯ä¸ªå›¾ç‰‡çš„dataUrlå’Œæ–°æ–‡ä»¶å
      let conversionInProgress = false; // æ ‡è¯†è½¬æ¢çŠ¶æ€ï¼Œé˜²æ­¢é‡å¤è½¬æ¢
      let isDragging = false; // æ‹–æ‹½çŠ¶æ€

      // ç›‘å¬æ–‡ä»¶é€‰æ‹©
      fileInput.addEventListener("change", handleFileSelect, false);

      // æ‹–æ‹½äº‹ä»¶å¤„ç†
      window.addEventListener("dragover", function (e) {
        e.preventDefault();
        if (!isDragging) {
          isDragging = true;
          dragOverlay.classList.add("show");
        }
      });

      window.addEventListener("dragleave", function (e) {
        e.preventDefault();
        // åªæœ‰å½“é¼ æ ‡çœŸæ­£ç¦»å¼€çª—å£æ—¶æ‰ç§»é™¤æ‹–æ‹½çŠ¶æ€
        if (
          e.clientX <= 0 ||
          e.clientY <= 0 ||
          e.clientX >= window.innerWidth ||
          e.clientY >= window.innerHeight
        ) {
          isDragging = false;
          dragOverlay.classList.remove("show");
        }
      });

      window.addEventListener("drop", function (e) {
        e.preventDefault();
        isDragging = false;
        dragOverlay.classList.remove("show");

        const files = e.dataTransfer.files;
        if (files.length > 0) {
          // å°†æ‹–æ‹½çš„æ–‡ä»¶è®¾ç½®åˆ°æ–‡ä»¶è¾“å…¥æ¡†
          fileInput.files = files;
          handleFileSelect({ target: { files: files } });

          // è‡ªåŠ¨å¼€å§‹è½¬æ¢
          setTimeout(() => {
            convertImages();
          }, 100);
        }
      });

      // ä¸‹è½½æŒ‰é’®ç‚¹å‡»äº‹ä»¶
      downloadButton.addEventListener("click", function () {
        if (!conversionInProgress) {
          downloadImages();
        }
      });

      /**
       * è½¬æ¢å›¾ç‰‡çš„ä¸»è¦å‡½æ•°
       */
      function convertImages() {
        const files = fileInput.files;
        if (files.length === 0) {
          showMessage("è¯·å…ˆé€‰æ‹©æ–‡ä»¶ã€‚", "error");
          return;
        }

        if (conversionInProgress) {
          showMessage("è½¬æ¢æ­£åœ¨è¿›è¡Œä¸­ï¼Œè¯·ç¨å€™...", "warning");
          return;
        }

        // é‡ç½®çŠ¶æ€
        resetConversionState();

        // è·å–è½¬æ¢å‚æ•°
        const quality = getQualityValue();
        const outputFormat = formatSelect.value;

        // å¼€å§‹è½¬æ¢
        showMessage("ğŸ”„ å›¾ç‰‡è½¬æ¢ä¸­...", "info");
        conversionInProgress = true;

        const conversionPromises = Array.from(files).map((file) =>
          convertSingleImage(file, outputFormat, quality)
        );

        // ç­‰å¾…æ‰€æœ‰è½¬æ¢å®Œæˆ
        Promise.all(conversionPromises)
          .then(() => {
            showMessage(`âœ… æˆåŠŸè½¬æ¢ ${files.length} å¼ å›¾ç‰‡ï¼`, "success");

            downloadButton.style.display = "block";

            if (files.length === 1) {
              // å•å¼ å›¾ç‰‡ç›´æ¥ä¸‹è½½
              const imageData = imagesData[0];
              downloadImage(imageData.dataUrl, imageData.newFileName);
            } else {
              // å¤šå¼ å›¾ç‰‡æ‰“åŒ…ä¸‹è½½
              downloadImages();
            }

          })
          .catch((error) => {
            console.error("è½¬æ¢å¤±è´¥:", error);
            showMessage("âŒ è½¬æ¢è¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯", "error");
          })
          .finally(() => {
            conversionInProgress = false;
          });
      }

      /**
       * è½¬æ¢å•å¼ å›¾ç‰‡
       * @param {File} file - è¦è½¬æ¢çš„æ–‡ä»¶
       * @param {string} outputFormat - è¾“å‡ºæ ¼å¼
       * @param {number} quality - å‹ç¼©è´¨é‡
       * @returns {Promise} è½¬æ¢Promise
       */
      function convertSingleImage(file, outputFormat, quality) {
        return new Promise((resolve, reject) => {
          const originalSize = file.size;
          const reader = new FileReader();

          reader.onload = function (event) {
            const img = new Image();

            img.onload = function () {
              try {
                const dataUrl = convertImageFormat(
                  img,
                  outputFormat,
                  quality
                );
                const fileName = generateFileName(file.name, outputFormat);
                const compressedSize = calculateCompressedSize(dataUrl);

                // ä¿å­˜è½¬æ¢ç»“æœï¼ˆåŒ…å«åƒç´ å°ºå¯¸ï¼‰
                imagesData.push({
                  dataUrl,
                  newFileName: fileName,
                  originalSize,
                  compressedSize,
                  width: img.width,
                  height: img.height,
                });

                // æ˜¾ç¤ºè½¬æ¢ç»“æœ
                displayImage(dataUrl, fileName, originalSize, compressedSize, img.width, img.height);
                resolve();
              } catch (error) {
                reject(error);
              }
            };

            img.onerror = () =>
              reject(new Error(`æ— æ³•åŠ è½½å›¾ç‰‡: ${file.name}`));
            img.src = event.target.result;
          };

          reader.onerror = () =>
            reject(new Error(`æ— æ³•è¯»å–æ–‡ä»¶: ${file.name}`));
          reader.readAsDataURL(file);
        });
      }

      // è½¬æ¢å›¾ç‰‡æŒ‰é’®ç‚¹å‡»äº‹ä»¶
      document
        .getElementById("convertButton")
        .addEventListener("click", convertImages);

      /**
       * é‡ç½®è½¬æ¢çŠ¶æ€
       */
      function resetConversionState() {
        imagesData = [];
        resultDiv.innerHTML = "";
        downloadButton.style.display = "none";
      }

      /**
       * è·å–è´¨é‡å€¼å¹¶ç¡®ä¿åœ¨æœ‰æ•ˆèŒƒå›´å†…
       * @returns {number} è´¨é‡å€¼ (0.01-1)
       */
      function getQualityValue() {
        return Math.min(Math.max(qualityInput.value / 100, 0.01), 1);
      }

      /**
       * ç”Ÿæˆæ–°çš„æ–‡ä»¶å
       * @param {string} originalName - åŸå§‹æ–‡ä»¶å
       * @param {string} outputFormat - è¾“å‡ºæ ¼å¼
       * @returns {string} æ–°æ–‡ä»¶å
       */
      function generateFileName(originalName, outputFormat) {
        const nameWithoutExt = originalName.split(".")[0];
        const newExtension = outputFormat.split("/")[1];
        return `${nameWithoutExt}.${newExtension}`;
      }

      /**
       * è®¡ç®—å‹ç¼©åçš„æ–‡ä»¶å¤§å°
       * @param {string} dataUrl - base64æ•°æ®URL
       * @returns {number} æ–‡ä»¶å¤§å°ï¼ˆå­—èŠ‚ï¼‰
       */
      function calculateCompressedSize(dataUrl) {
        // ç§»é™¤data URLå‰ç¼€ï¼Œè®¡ç®—base64æ•°æ®çš„å®é™…å¤§å°
        const base64Data = dataUrl.split(",")[1];
        return Math.round((base64Data.length * 3) / 4);
      }

      /**
       * æ˜¾ç¤ºçŠ¶æ€æ¶ˆæ¯
       * @param {string} message - æ¶ˆæ¯å†…å®¹
       * @param {string} type - æ¶ˆæ¯ç±»å‹ (info, success, error, warning)
       */
      function showMessage(message, type = "info") {
        statusMessage.style.display = "block";
        statusMessage.textContent = message;

        // æ ¹æ®ç±»å‹è®¾ç½®æ ·å¼
        const colors = {
          info: { bg: "#e3f2fd", color: "#1976d2", border: "#2196f3" },
          success: { bg: "#e8f5e8", color: "#2e7d32", border: "#4caf50" },
          error: { bg: "#ffebee", color: "#c62828", border: "#f44336" },
          warning: { bg: "#fff3e0", color: "#ef6c00", border: "#ff9800" },
        };

        const style = colors[type] || colors.info;
        statusMessage.style.background = style.bg;
        statusMessage.style.color = style.color;
        statusMessage.style.borderLeftColor = style.border;
      }

      // æ¸…é™¤æŒ‰é’®äº‹ä»¶å¤„ç†
      clearButton.addEventListener("click", function () {
        resetConversionState();
        fileInput.value = ""; // æ¸…ç©ºæ–‡ä»¶è¾“å…¥æ¡†
        statusMessage.style.display = "none";
      });

      /**
       * ä¸‹è½½æ‰€æœ‰è½¬æ¢åçš„å›¾ç‰‡ï¼ˆæ‰“åŒ…ä¸ºZIPæ–‡ä»¶ï¼‰
       */
      function downloadImages() {
        if (imagesData.length === 0) {
          showMessage("æ²¡æœ‰å¯ä¸‹è½½çš„å›¾ç‰‡", "warning");
          return;
        }

        const zip = new JSZip();
        const timestamp = new Date()
          .toISOString()
          .slice(0, 19)
          .replace(/:/g, "-");

        // å°†æ¯ä¸ªå›¾ç‰‡æ–‡ä»¶æ·»åŠ åˆ°ZIPæ–‡ä»¶ä¸­
        imagesData.forEach((imageData) => {
          const base64Data = imageData.dataUrl.split(",")[1];
          zip.file(imageData.newFileName, base64Data, { base64: true });
        });

        // ç”ŸæˆZIPæ–‡ä»¶å¹¶è§¦å‘ä¸‹è½½
        showMessage("ğŸ“¦ æ­£åœ¨æ‰“åŒ…ä¸‹è½½æ–‡ä»¶...", "info");
        zip
          .generateAsync({ type: "blob" })
          .then((content) => {
            saveAs(content, `converted-images-${timestamp}.zip`);
            showMessage("âœ… ä¸‹è½½å®Œæˆï¼", "success");
          })
          .catch((error) => {
            console.error("ä¸‹è½½å¤±è´¥:", error);
            showMessage("âŒ ä¸‹è½½å¤±è´¥", "error");
          });
      }

      /**
       * æ˜¾ç¤ºè½¬æ¢åçš„å›¾ç‰‡åŠå…¶ç›¸å…³ä¿¡æ¯
       * @param {string} dataUrl - å›¾ç‰‡çš„base64æ•°æ®URL
       * @param {string} fileName - æ–‡ä»¶å
       * @param {number} originalSize - åŸå§‹æ–‡ä»¶å¤§å°ï¼ˆå­—èŠ‚ï¼‰
       * @param {number} compressedSize - å‹ç¼©åæ–‡ä»¶å¤§å°ï¼ˆå­—èŠ‚ï¼‰
       * @param {number} width - å›¾ç‰‡å®½åº¦
       * @param {number} height - å›¾ç‰‡é«˜åº¦
       */
      function displayImage(dataUrl, fileName, originalSize, compressedSize, width, height) {
        const container = document.createElement("div");
        container.classList.add("image-container");

        // åˆ›å»ºå›¾ç‰‡åŒ…è£…å™¨
        const imageWrapper = document.createElement("div");
        imageWrapper.classList.add("image-wrapper");

        const img = document.createElement("img");
        img.src = dataUrl;
        img.alt = fileName;

        imageWrapper.appendChild(img);

        // æ–‡ä»¶åæ ‡ç­¾
        const fileNameLabel = document.createElement("div");
        fileNameLabel.classList.add("file-name");
        fileNameLabel.textContent = fileName;

        // åƒç´ å°ºå¯¸ä¿¡æ¯
        const dimensionInfo = document.createElement("div");
        dimensionInfo.style.marginTop = "8px";
        dimensionInfo.style.fontSize = "12px";
        dimensionInfo.style.textAlign = "center";
        dimensionInfo.style.color = "#666";
        dimensionInfo.style.fontWeight = "500";
        dimensionInfo.textContent = `${width} Ã— ${height} åƒç´ `;

        // æ–‡ä»¶å¤§å°ä¿¡æ¯
        const sizeInfo = document.createElement("div");
        sizeInfo.classList.add("size-info");

        const originalSizeText = document.createElement("span");
        originalSizeText.style.color = "black";
        originalSizeText.textContent = `${formatFileSize(originalSize)} `;

        const separator = document.createElement("span");
        separator.textContent = "â†’ ";
        separator.style.color = "#666";

        const compressedSizeText = document.createElement("span");
        compressedSizeText.style.color = "green";
        compressedSizeText.textContent = `${formatFileSize(compressedSize)}`;

        // è®¡ç®—å‹ç¼©æ¯”ä¾‹
        const compressionRatio = (
          ((originalSize - compressedSize) / originalSize) *
          100
        ).toFixed(1);
        const ratioText = document.createElement("span");
        ratioText.style.color = compressionRatio > 0 ? "green" : "red";
        ratioText.style.marginLeft = "8px";
        ratioText.style.fontSize = "11px";
        ratioText.textContent = `(${compressionRatio > 0 ? "-" : "+"
          }${Math.abs(compressionRatio)}%)`;

        sizeInfo.appendChild(originalSizeText);
        sizeInfo.appendChild(separator);
        sizeInfo.appendChild(compressedSizeText);
        sizeInfo.appendChild(ratioText);

        // å•ç‹¬ä¸‹è½½æŒ‰é’®
        const individualDownloadButton = document.createElement("a");
        individualDownloadButton.classList.add("individual-download");
        individualDownloadButton.textContent = "ğŸ“¥ ä¸‹è½½";
        individualDownloadButton.href = "#";
        individualDownloadButton.onclick = function (e) {
          e.preventDefault();
          downloadImage(dataUrl, fileName);
        };

        // ç»„è£…å®¹å™¨
        container.appendChild(imageWrapper);
        container.appendChild(fileNameLabel);
        container.appendChild(dimensionInfo);
        container.appendChild(sizeInfo);
        container.appendChild(individualDownloadButton);
        resultDiv.appendChild(container);
      }

      /**
       * æ ¼å¼åŒ–æ–‡ä»¶å¤§å°æ˜¾ç¤º
       * @param {number} bytes - æ–‡ä»¶å¤§å°ï¼ˆå­—èŠ‚ï¼‰
       * @returns {string} æ ¼å¼åŒ–åçš„æ–‡ä»¶å¤§å°å­—ç¬¦ä¸²
       */
      function formatFileSize(bytes) {
        if (bytes === 0) return "0 B";
        const k = 1024;
        const sizes = ["B", "KB", "MB", "GB"];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return (
          parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + " " + sizes[i]
        );
      }

      /**
       * å•ç‹¬ä¸‹è½½ä¸€å¼ å›¾ç‰‡
       * @param {string} dataUrl - å›¾ç‰‡çš„base64æ•°æ®URL
       * @param {string} fileName - æ–‡ä»¶å
       */
      function downloadImage(dataUrl, fileName) {
        try {
          const a = document.createElement("a");
          a.href = dataUrl;
          a.download = fileName;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);

          // æ˜¾ç¤ºä¸‹è½½æç¤º
          showMessage(`ğŸ“¥ ${fileName} ä¸‹è½½å®Œæˆï¼`, "success");
        } catch (error) {
          console.error("ä¸‹è½½å¤±è´¥:", error);
          showMessage("âŒ ä¸‹è½½å¤±è´¥", "error");
        }
      }

      /**
       * æ‰§è¡Œå›¾ç‰‡æ ¼å¼è½¬æ¢
       * @param {HTMLImageElement} image - å›¾ç‰‡å…ƒç´ 
       * @param {string} outputFormat - è¾“å‡ºæ ¼å¼
       * @param {number} quality - å‹ç¼©è´¨é‡ (0.01-1)
       * @returns {string} è½¬æ¢åçš„base64æ•°æ®URL
       */
      function convertImageFormat(image, outputFormat, quality) {
        const canvas = document.createElement("canvas");
        canvas.width = image.width;
        canvas.height = image.height;

        const ctx = canvas.getContext("2d");
        // è®¾ç½®ç™½è‰²èƒŒæ™¯ï¼ˆå¯¹äºJPEGæ ¼å¼å¾ˆé‡è¦ï¼‰
        if (outputFormat === "image/jpeg") {
          ctx.fillStyle = "#FFFFFF";
          ctx.fillRect(0, 0, canvas.width, canvas.height);
        }

        ctx.drawImage(image, 0, 0, image.width, image.height);
        return canvas.toDataURL(outputFormat, quality);
      }

      /**
       * å¤„ç†æ–‡ä»¶é€‰æ‹©äº‹ä»¶
       * @param {Event} event - æ–‡ä»¶é€‰æ‹©äº‹ä»¶
       */
      function handleFileSelect(event) {
        const files = event.target.files;

        if (!files.length) {
          return;
        }

        // éªŒè¯æ–‡ä»¶ç±»å‹
        const invalidFiles = Array.from(files).filter(
          (file) => !file.type.match("image.*")
        );
        if (invalidFiles.length > 0) {
          showMessage(
            `âŒ æ£€æµ‹åˆ° ${invalidFiles.length} ä¸ªéå›¾ç‰‡æ–‡ä»¶ï¼Œè¯·åªé€‰æ‹©å›¾ç‰‡æ–‡ä»¶ã€‚`,
            "error"
          );
          return;
        }

        downloadButton.style.display = "none";

        showMessage(`ğŸ“ å·²é€‰æ‹© ${files.length} ä¸ªå›¾ç‰‡æ–‡ä»¶`, "info");
      }
    });
  </script>
</body>

</html>