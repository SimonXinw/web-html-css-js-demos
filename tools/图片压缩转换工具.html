<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>图片转换工具</title>
    <style>
        img {
            width: 100%;
        }

        #result {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }

        .image-container {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .file-name {
            margin-top: 5px;
            font-size: 14px;
            color: #333;
        }

        #downloadButton {
            cursor: pointer;
            text-decoration: underline;
        }

        .individual-download {
            margin-top: 5px;
            cursor: pointer;
            text-decoration: underline;
            color: #007BFF; /* 你可以选择其他颜色 */
        }

        #statusMessage {
            margin-top: 10px;
            font-size: 16px;
            color: #007BFF; /* 你可以选择其他颜色 */
        }
    </style>
    <!-- 加载JSZip和FileSaver.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
</head>

<body>
    <!-- 文件上传控件 -->
    <input type="file" id="fileInput" accept="image/*" multiple />

    <!-- 输出格式选择 -->
    <select id="formatSelect">
        <option value="image/jpeg">JPEG</option>
        <option value="image/png">PNG</option>
        <option value="image/webp" selected>WEBP</option>
    </select>

    <!-- 转换图片按钮 -->
    <button id="convertButton">转换图片</button>

    <!-- 清除图片按钮 -->
    <button id="clearButton">清除图片</button>

    <!-- 导出图片按钮 -->
    <div id="download_list" style="display: inline-block">
        <a id="downloadButton" style="display: none" onclick="return false;">下载转换后的图片</a>
    </div>

    <!-- 状态消息 -->
    <div id="statusMessage" style="display: none;"></div>

    <!-- 展示转换后的图片 -->
    <div id="result"></div>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const fileInput = document.getElementById("fileInput");
            const formatSelect = document.getElementById("formatSelect");
            const downloadButton = document.getElementById("downloadButton");
            const clearButton = document.getElementById("clearButton");
            const resultDiv = document.getElementById("result");
            const statusMessage = document.getElementById("statusMessage");

            let fileNames = []; // 保存文件名数组
            let imagesData = []; // 保存图片及其下载链接
            let conversionInProgress = false; // 转换进程标志

            fileInput.addEventListener("change", handleFileSelect, false);
            downloadButton.addEventListener("click", function () {
                if (!conversionInProgress) {
                    downloadImages();
                }
            });

            document
                .getElementById("convertButton")
                .addEventListener("click", function () {
                    const files = fileInput.files;
                    if (files.length === 0) {
                        alert("请先选择文件。");
                        return;
                    }

                    fileNames = []; // 清空文件名列表
                    imagesData = []; // 清空图片数据
                    resultDiv.innerHTML = ""; // 清除上次的图片预览
                    statusMessage.style.display = "block"; // 显示状态消息
                    statusMessage.textContent = "图片转换中..."; // 更新状态消息
                    downloadButton.style.display = "none"; // 隐藏下载按钮
                    conversionInProgress = true; // 设置转换标志

                    let promises = []; // 存储转换过程中的Promise

                    for (let i = 0; i < files.length; i++) {
                        const file = files[i];
                        const reader = new FileReader();
                        const promise = new Promise((resolve) => {
                            reader.onload = function (event) {
                                const img = new Image();
                                img.onload = function () {
                                    const dataUrl = convertImageFormat(
                                        img,
                                        formatSelect.value,
                                        0.8
                                    ); // 80% 质量
                                    const originalName = file.name.split(".")[0]; // 去掉扩展名
                                    const newExtension = formatSelect.value.split("/")[1]; // 新扩展名
                                    const newFileName = originalName + "." + newExtension;
                                    imagesData.push({ dataUrl, newFileName });
                                    displayImage(dataUrl, newFileName);
                                    resolve(); // 标记该图片转换完成
                                };
                                img.src = event.target.result;
                            };
                        });

                        promises.push(promise); // 将Promise添加到数组中
                        reader.readAsDataURL(file);
                    }

                    Promise.all(promises).then(() => {
                        statusMessage.textContent = "图片转换成功"; // 更新状态消息
                        downloadButton.style.display = "block"; // 显示下载按钮
                        conversionInProgress = false; // 重置转换标志
                    });
                });

            // 清除按钮事件
            clearButton.addEventListener("click", function () {
                // 清除预览的图片
                resultDiv.innerHTML = "";
                // 清除文件输入控件的内容
                fileInput.value = "";
                // 隐藏下载按钮
                downloadButton.style.display = "none";
                // 清空文件名数组
                fileNames = [];
                imagesData = [];
                statusMessage.style.display = "none"; // 隐藏状态消息
            });

            function downloadImages() {
                const zip = new JSZip();

                for (let i = 0; i < imagesData.length; i++) {
                    // 将图片数据添加到ZIP文件中
                    const imgData = imagesData[i].dataUrl.split(",")[1]; // 获取Base64编码部分
                    zip.file(imagesData[i].newFileName, imgData, { base64: true });
                }

                // 生成ZIP文件并下载
                zip.generateAsync({ type: "blob" }).then(function (content) {
                    // 使用FileSaver.js下载ZIP文件
                    saveAs(content, "images.zip");
                });
            }

            function displayImage(dataUrl, fileName) {
                const container = document.createElement("div");
                container.classList.add("image-container");

                const img = document.createElement("img");
                img.src = dataUrl;

                const fileNameLabel = document.createElement("div");
                fileNameLabel.classList.add("file-name");
                fileNameLabel.textContent = fileName; // 显示新文件名

                const individualDownloadButton = document.createElement("a");
                individualDownloadButton.classList.add("individual-download");
                individualDownloadButton.textContent = "单独下载";
                individualDownloadButton.onclick = function () {
                    downloadImage(dataUrl, fileName); // 调用下载单个图片的函数
                };

                container.appendChild(img);
                container.appendChild(fileNameLabel);
                container.appendChild(individualDownloadButton); // 添加单独下载按钮
                resultDiv.appendChild(container);
            }

            function downloadImage(dataUrl, fileName) {
                const a = document.createElement("a");
                a.href = dataUrl;
                a.download = fileName; // 指定下载的文件名
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a); // 清理DOM
            }

            function convertImageFormat(image, outputFormat, quality) {
                const canvas = document.createElement("canvas");
                canvas.width = image.width;
                canvas.height = image.height;
                const ctx = canvas.getContext("2d");
                ctx.drawImage(image, 0, 0, image.width, image.height);
                return canvas.toDataURL(outputFormat, quality);
            }

            function handleFileSelect(event) {
                const files = event.target.files;
                if (!files.length || !files[0].type.match("image.*")) {
                    alert("请选择有效的图片文件。");
                    return;
                }
                downloadButton.style.display = "none"; // 隐藏下载按钮
            }
        });
    </script>
</body>
</html>
