<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>图片转换工具</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    /* 主容器 */
    .main-container {
      max-width: 100%;
      margin: 0 auto;
      background: white;
      border-radius: 20px;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
      overflow: hidden;
    }

    /* 顶部控制区域 */
    .header-section {
      background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
      padding: 30px;
      color: white;
    }

    .header-title {
      font-size: 28px;
      font-weight: 600;
      margin-bottom: 20px;
      text-align: center;
    }

    .controls-container {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      align-items: center;
      justify-content: center;
    }

    .control-group {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 5px;
    }

    .control-group label {
      font-size: 14px;
      font-weight: 500;
    }

    .control-input {
      padding: 8px 12px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      background: rgba(255, 255, 255, 0.9);
      color: #333;
      min-width: 120px;
    }

    .control-input:focus {
      outline: none;
      background: white;
      box-shadow: 0 0 0 3px rgba(255, 255, 255, 0.3);
    }

    .file-input-wrapper {
      position: relative;
      overflow: hidden;
      display: inline-block;
    }

    .file-input-button {
      background: rgba(255, 255, 255, 0.2);
      color: white;
      padding: 12px 24px;
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-radius: 25px;
      cursor: pointer;
      font-size: 16px;
      font-weight: 500;
      transition: all 0.3s ease;
      backdrop-filter: blur(10px);
    }

    .file-input-button:hover {
      background: rgba(255, 255, 255, 0.3);
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    #fileInput {
      position: absolute;
      left: -9999px;
      opacity: 0;
    }

    .action-buttons {
      display: flex;
      gap: 15px;
      justify-content: center;
      flex-wrap: wrap;
    }

    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 25px;
      font-size: 16px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
      text-decoration: none;
      display: inline-block;
      text-align: center;
    }

    .btn-primary {
      background: #ff6b6b;
      color: white;
    }

    .btn-secondary {
      background: rgba(255, 255, 255, 0.2);
      color: white;
      border: 2px solid rgba(255, 255, 255, 0.3);
    }

    .btn-success {
      background: #51cf66;
      color: white;
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    /* 内容区域 */
    .content-section {
      padding: 30px;
    }

    /* 状态消息 */
    #statusMessage {
      text-align: center;
      font-size: 16px;
      font-weight: 500;
      margin-bottom: 20px;
      padding: 15px;
      border-radius: 10px;
      background: #e3f2fd;
      color: #1976d2;
      border-left: 4px solid #2196f3;
    }

    /* 图片网格 */
    #result {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(239px, 1fr));
      gap: 15px;
      margin-top: 20px;
    }

    .image-container {
      background: white;
      border-radius: 15px;
      padding: 15px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      border: 1px solid #f0f0f0;
    }

    .image-container:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
    }

    .image-wrapper {
      width: 100%;
      height: 125px;
      border-radius: 10px;
      overflow: hidden;
      background: #f8f9fa;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .image-wrapper img {
      width: 100%;
      height: 100%;
      object-fit: contain;
      border-radius: 10px;
    }

    .file-name {
      margin-top: 12px;
      font-size: 14px;
      font-weight: 500;
      color: #333;
      text-align: center;
      word-break: break-all;
    }

    .size-info {
      margin-top: 8px;
      font-size: 12px;
      text-align: center;
      font-weight: 500;
    }

    .individual-download {
      margin-top: 12px;
      display: block;
      text-align: center;
      padding: 8px 16px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      text-decoration: none;
      border-radius: 20px;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.3s ease;
    }

    .individual-download:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
    }

    /* 拖拽覆盖层 */
    .drag-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(102, 126, 234, 0.9);
      backdrop-filter: blur(10px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      font-size: 32px;
      color: white;
      font-weight: 600;
      text-align: center;
      /* 添加虚线边框效果 */
      border: 3px dashed #4fd1c5;
      box-sizing: border-box;
      margin: 20px;
      border-radius: 20px;
      /* 添加边框动画效果 */
      animation: borderPulse 2s ease-in-out infinite;
    }

    .drag-overlay.show {
      display: flex;
    }

    .drag-overlay::before {
      content: "🖼️ 拖拽图片到此处开始转换";
      animation: pulse 2s infinite;
    }

    @keyframes pulse {

      0%,
      100% {
        opacity: 1;
      }

      50% {
        opacity: 0.7;
      }
    }

    /* 边框渐亮渐暗动画 */
    @keyframes borderPulse {
      0% {
        border-color: rgba(79, 209, 197, 0.3);
        box-shadow: 0 0 0 rgba(79, 209, 197, 0.3);
      }

      50% {
        border-color: rgba(79, 209, 197, 1);
        box-shadow: 0 0 20px rgba(79, 209, 197, 0.6);
      }

      100% {
        border-color: rgba(79, 209, 197, 0.3);
        box-shadow: 0 0 0 rgba(79, 209, 197, 0.3);
      }
    }

    /* 响应式设计 */
    @media (max-width: 768px) {
      .controls-container {
        justify-content: flex-start;
        /* 移动端按钮尺寸调整 */
      }

      .btn,
      .file-input-button {
        padding: 10px 16px;
        font-size: 14px;
      }

      .control-input {
        min-width: inherit;
      }

      .action-buttons {
        width: 100%;
      }

      #result {
        grid-template-columns: 1fr;
      }

      .header-title {
        font-size: 24px;
      }
    }
  </style>
  <!-- 加载JSZip和FileSaver.js，用于压缩和下载文件 -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
</head>

<body>
  <!-- 拖拽覆盖层 -->
  <div id="dragOverlay" class="drag-overlay"></div>

  <div class="main-container">
    <!-- 顶部控制区域 -->
    <div class="header-section">
      <h1 class="header-title">🎨 智能图片压缩转换工具</h1>

      <div class="controls-container">
        <!-- 文件选择 -->
        <div class="control-group">
          <label>选择图片</label>
          <div class="file-input-wrapper">
            <div class="file-input-button" onclick="document.getElementById('fileInput').click()">
              📁 选择文件
            </div>
            <input type="file" id="fileInput" accept="image/*" multiple />
          </div>
        </div>

        <!-- 输出格式选择 -->
        <div class="control-group">
          <label>输出格式</label>
          <select id="formatSelect" class="control-input">
            <option value="image/jpeg">JPEG</option>
            <option value="image/png">PNG</option>
            <option value="image/webp" selected>WEBP</option>
          </select>
        </div>

        <!-- 质量输入框 -->
        <div class="control-group">
          <label>压缩质量</label>
          <input type="number" id="qualityInput" class="control-input" min="1" max="100" value="80"
            placeholder="1-100" />
        </div>

        <!-- 操作按钮 -->
        <div class="action-buttons">
          <button id="convertButton" class="btn btn-primary">
            🚀 开始转换
          </button>
          <button id="clearButton" class="btn btn-secondary">
            🗑️ 清除图片
          </button>
          <a id="downloadButton" class="btn btn-success" style="display: none">📦 下载全部</a>
        </div>
      </div>
    </div>

    <!-- 内容区域 -->
    <div class="content-section">
      <!-- 状态消息 -->
      <div id="statusMessage" style="display: none"></div>

      <!-- 展示转换后的图片 -->
      <div id="result"></div>
    </div>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", function () {
      // 获取元素的引用
      const fileInput = document.getElementById("fileInput");
      const formatSelect = document.getElementById("formatSelect");
      const qualityInput = document.getElementById("qualityInput");
      const downloadButton = document.getElementById("downloadButton");
      const clearButton = document.getElementById("clearButton");
      const resultDiv = document.getElementById("result");
      const statusMessage = document.getElementById("statusMessage");
      const dragOverlay = document.getElementById("dragOverlay");

      let imagesData = []; // 存储每个图片的dataUrl和新文件名
      let conversionInProgress = false; // 标识转换状态，防止重复转换
      let isDragging = false; // 拖拽状态

      // 监听文件选择
      fileInput.addEventListener("change", handleFileSelect, false);

      // 拖拽事件处理
      window.addEventListener("dragover", function (e) {
        e.preventDefault();
        if (!isDragging) {
          isDragging = true;
          dragOverlay.classList.add("show");
        }
      });

      window.addEventListener("dragleave", function (e) {
        e.preventDefault();
        // 只有当鼠标真正离开窗口时才移除拖拽状态
        if (
          e.clientX <= 0 ||
          e.clientY <= 0 ||
          e.clientX >= window.innerWidth ||
          e.clientY >= window.innerHeight
        ) {
          isDragging = false;
          dragOverlay.classList.remove("show");
        }
      });

      window.addEventListener("drop", function (e) {
        e.preventDefault();
        isDragging = false;
        dragOverlay.classList.remove("show");

        const files = e.dataTransfer.files;
        if (files.length > 0) {
          // 将拖拽的文件设置到文件输入框
          fileInput.files = files;
          handleFileSelect({ target: { files: files } });

          // 自动开始转换
          setTimeout(() => {
            convertImages();
          }, 100);
        }
      });

      // 下载按钮点击事件
      downloadButton.addEventListener("click", function () {
        if (!conversionInProgress) {
          downloadImages();
        }
      });

      /**
       * 转换图片的主要函数
       */
      function convertImages() {
        const files = fileInput.files;
        if (files.length === 0) {
          showMessage("请先选择文件。", "error");
          return;
        }

        if (conversionInProgress) {
          showMessage("转换正在进行中，请稍候...", "warning");
          return;
        }

        // 重置状态
        resetConversionState();

        // 获取转换参数
        const quality = getQualityValue();
        const outputFormat = formatSelect.value;

        // 开始转换
        showMessage("🔄 图片转换中...", "info");
        conversionInProgress = true;

        const conversionPromises = Array.from(files).map((file) =>
          convertSingleImage(file, outputFormat, quality)
        );

        // 等待所有转换完成
        Promise.all(conversionPromises)
          .then(() => {
            showMessage(`✅ 成功转换 ${files.length} 张图片！`, "success");

            downloadButton.style.display = "block";

            if (files.length === 1) {
              // 单张图片直接下载
              const imageData = imagesData[0];
              downloadImage(imageData.dataUrl, imageData.newFileName);
            } else {
              // 多张图片打包下载
              downloadImages();
            }

          })
          .catch((error) => {
            console.error("转换失败:", error);
            showMessage("❌ 转换过程中出现错误", "error");
          })
          .finally(() => {
            conversionInProgress = false;
          });
      }

      /**
       * 转换单张图片
       * @param {File} file - 要转换的文件
       * @param {string} outputFormat - 输出格式
       * @param {number} quality - 压缩质量
       * @returns {Promise} 转换Promise
       */
      function convertSingleImage(file, outputFormat, quality) {
        return new Promise((resolve, reject) => {
          const originalSize = file.size;
          const reader = new FileReader();

          reader.onload = function (event) {
            const img = new Image();

            img.onload = function () {
              try {
                const dataUrl = convertImageFormat(
                  img,
                  outputFormat,
                  quality
                );
                const fileName = generateFileName(file.name, outputFormat);
                const compressedSize = calculateCompressedSize(dataUrl);

                // 保存转换结果（包含像素尺寸）
                imagesData.push({
                  dataUrl,
                  newFileName: fileName,
                  originalSize,
                  compressedSize,
                  width: img.width,
                  height: img.height,
                });

                // 显示转换结果
                displayImage(dataUrl, fileName, originalSize, compressedSize, img.width, img.height);
                resolve();
              } catch (error) {
                reject(error);
              }
            };

            img.onerror = () =>
              reject(new Error(`无法加载图片: ${file.name}`));
            img.src = event.target.result;
          };

          reader.onerror = () =>
            reject(new Error(`无法读取文件: ${file.name}`));
          reader.readAsDataURL(file);
        });
      }

      // 转换图片按钮点击事件
      document
        .getElementById("convertButton")
        .addEventListener("click", convertImages);

      /**
       * 重置转换状态
       */
      function resetConversionState() {
        imagesData = [];
        resultDiv.innerHTML = "";
        downloadButton.style.display = "none";
      }

      /**
       * 获取质量值并确保在有效范围内
       * @returns {number} 质量值 (0.01-1)
       */
      function getQualityValue() {
        return Math.min(Math.max(qualityInput.value / 100, 0.01), 1);
      }

      /**
       * 生成新的文件名
       * @param {string} originalName - 原始文件名
       * @param {string} outputFormat - 输出格式
       * @returns {string} 新文件名
       */
      function generateFileName(originalName, outputFormat) {
        const nameWithoutExt = originalName.split(".")[0];
        const newExtension = outputFormat.split("/")[1];
        return `${nameWithoutExt}.${newExtension}`;
      }

      /**
       * 计算压缩后的文件大小
       * @param {string} dataUrl - base64数据URL
       * @returns {number} 文件大小（字节）
       */
      function calculateCompressedSize(dataUrl) {
        // 移除data URL前缀，计算base64数据的实际大小
        const base64Data = dataUrl.split(",")[1];
        return Math.round((base64Data.length * 3) / 4);
      }

      /**
       * 显示状态消息
       * @param {string} message - 消息内容
       * @param {string} type - 消息类型 (info, success, error, warning)
       */
      function showMessage(message, type = "info") {
        statusMessage.style.display = "block";
        statusMessage.textContent = message;

        // 根据类型设置样式
        const colors = {
          info: { bg: "#e3f2fd", color: "#1976d2", border: "#2196f3" },
          success: { bg: "#e8f5e8", color: "#2e7d32", border: "#4caf50" },
          error: { bg: "#ffebee", color: "#c62828", border: "#f44336" },
          warning: { bg: "#fff3e0", color: "#ef6c00", border: "#ff9800" },
        };

        const style = colors[type] || colors.info;
        statusMessage.style.background = style.bg;
        statusMessage.style.color = style.color;
        statusMessage.style.borderLeftColor = style.border;
      }

      // 清除按钮事件处理
      clearButton.addEventListener("click", function () {
        resetConversionState();
        fileInput.value = ""; // 清空文件输入框
        statusMessage.style.display = "none";
      });

      /**
       * 下载所有转换后的图片（打包为ZIP文件）
       */
      function downloadImages() {
        if (imagesData.length === 0) {
          showMessage("没有可下载的图片", "warning");
          return;
        }

        const zip = new JSZip();
        const timestamp = new Date()
          .toISOString()
          .slice(0, 19)
          .replace(/:/g, "-");

        // 将每个图片文件添加到ZIP文件中
        imagesData.forEach((imageData) => {
          const base64Data = imageData.dataUrl.split(",")[1];
          zip.file(imageData.newFileName, base64Data, { base64: true });
        });

        // 生成ZIP文件并触发下载
        showMessage("📦 正在打包下载文件...", "info");
        zip
          .generateAsync({ type: "blob" })
          .then((content) => {
            saveAs(content, `converted-images-${timestamp}.zip`);
            showMessage("✅ 下载完成！", "success");
          })
          .catch((error) => {
            console.error("下载失败:", error);
            showMessage("❌ 下载失败", "error");
          });
      }

      /**
       * 显示转换后的图片及其相关信息
       * @param {string} dataUrl - 图片的base64数据URL
       * @param {string} fileName - 文件名
       * @param {number} originalSize - 原始文件大小（字节）
       * @param {number} compressedSize - 压缩后文件大小（字节）
       * @param {number} width - 图片宽度
       * @param {number} height - 图片高度
       */
      function displayImage(dataUrl, fileName, originalSize, compressedSize, width, height) {
        const container = document.createElement("div");
        container.classList.add("image-container");

        // 创建图片包装器
        const imageWrapper = document.createElement("div");
        imageWrapper.classList.add("image-wrapper");

        const img = document.createElement("img");
        img.src = dataUrl;
        img.alt = fileName;

        imageWrapper.appendChild(img);

        // 文件名标签
        const fileNameLabel = document.createElement("div");
        fileNameLabel.classList.add("file-name");
        fileNameLabel.textContent = fileName;

        // 像素尺寸信息
        const dimensionInfo = document.createElement("div");
        dimensionInfo.style.marginTop = "8px";
        dimensionInfo.style.fontSize = "12px";
        dimensionInfo.style.textAlign = "center";
        dimensionInfo.style.color = "#666";
        dimensionInfo.style.fontWeight = "500";
        dimensionInfo.textContent = `${width} × ${height} 像素`;

        // 文件大小信息
        const sizeInfo = document.createElement("div");
        sizeInfo.classList.add("size-info");

        const originalSizeText = document.createElement("span");
        originalSizeText.style.color = "black";
        originalSizeText.textContent = `${formatFileSize(originalSize)} `;

        const separator = document.createElement("span");
        separator.textContent = "→ ";
        separator.style.color = "#666";

        const compressedSizeText = document.createElement("span");
        compressedSizeText.style.color = "green";
        compressedSizeText.textContent = `${formatFileSize(compressedSize)}`;

        // 计算压缩比例
        const compressionRatio = (
          ((originalSize - compressedSize) / originalSize) *
          100
        ).toFixed(1);
        const ratioText = document.createElement("span");
        ratioText.style.color = compressionRatio > 0 ? "green" : "red";
        ratioText.style.marginLeft = "8px";
        ratioText.style.fontSize = "11px";
        ratioText.textContent = `(${compressionRatio > 0 ? "-" : "+"
          }${Math.abs(compressionRatio)}%)`;

        sizeInfo.appendChild(originalSizeText);
        sizeInfo.appendChild(separator);
        sizeInfo.appendChild(compressedSizeText);
        sizeInfo.appendChild(ratioText);

        // 单独下载按钮
        const individualDownloadButton = document.createElement("a");
        individualDownloadButton.classList.add("individual-download");
        individualDownloadButton.textContent = "📥 下载";
        individualDownloadButton.href = "#";
        individualDownloadButton.onclick = function (e) {
          e.preventDefault();
          downloadImage(dataUrl, fileName);
        };

        // 组装容器
        container.appendChild(imageWrapper);
        container.appendChild(fileNameLabel);
        container.appendChild(dimensionInfo);
        container.appendChild(sizeInfo);
        container.appendChild(individualDownloadButton);
        resultDiv.appendChild(container);
      }

      /**
       * 格式化文件大小显示
       * @param {number} bytes - 文件大小（字节）
       * @returns {string} 格式化后的文件大小字符串
       */
      function formatFileSize(bytes) {
        if (bytes === 0) return "0 B";
        const k = 1024;
        const sizes = ["B", "KB", "MB", "GB"];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return (
          parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + " " + sizes[i]
        );
      }

      /**
       * 单独下载一张图片
       * @param {string} dataUrl - 图片的base64数据URL
       * @param {string} fileName - 文件名
       */
      function downloadImage(dataUrl, fileName) {
        try {
          const a = document.createElement("a");
          a.href = dataUrl;
          a.download = fileName;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);

          // 显示下载提示
          showMessage(`📥 ${fileName} 下载完成！`, "success");
        } catch (error) {
          console.error("下载失败:", error);
          showMessage("❌ 下载失败", "error");
        }
      }

      /**
       * 执行图片格式转换
       * @param {HTMLImageElement} image - 图片元素
       * @param {string} outputFormat - 输出格式
       * @param {number} quality - 压缩质量 (0.01-1)
       * @returns {string} 转换后的base64数据URL
       */
      function convertImageFormat(image, outputFormat, quality) {
        const canvas = document.createElement("canvas");
        canvas.width = image.width;
        canvas.height = image.height;

        const ctx = canvas.getContext("2d");
        // 设置白色背景（对于JPEG格式很重要）
        if (outputFormat === "image/jpeg") {
          ctx.fillStyle = "#FFFFFF";
          ctx.fillRect(0, 0, canvas.width, canvas.height);
        }

        ctx.drawImage(image, 0, 0, image.width, image.height);
        return canvas.toDataURL(outputFormat, quality);
      }

      /**
       * 处理文件选择事件
       * @param {Event} event - 文件选择事件
       */
      function handleFileSelect(event) {
        const files = event.target.files;

        if (!files.length) {
          return;
        }

        // 验证文件类型
        const invalidFiles = Array.from(files).filter(
          (file) => !file.type.match("image.*")
        );
        if (invalidFiles.length > 0) {
          showMessage(
            `❌ 检测到 ${invalidFiles.length} 个非图片文件，请只选择图片文件。`,
            "error"
          );
          return;
        }

        downloadButton.style.display = "none";

        showMessage(`📁 已选择 ${files.length} 个图片文件`, "info");
      }
    });
  </script>
</body>

</html>