<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>PDF压缩工具</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    /* 主容器 */
    .main-container {
      max-width: 100%;
      margin: 0 auto;
      background: white;
      border-radius: 20px;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
      overflow: hidden;
    }

    /* 顶部控制区域 */
    .header-section {
      background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
      padding: 30px;
      color: white;
    }

    .header-title {
      font-size: 28px;
      font-weight: 600;
      margin-bottom: 20px;
      text-align: center;
    }

    .controls-container {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      align-items: center;
      justify-content: center;
    }

    .control-group {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 5px;
    }

    .control-group label {
      font-size: 14px;
      font-weight: 500;
    }

    .control-input {
      padding: 8px 12px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      background: rgba(255, 255, 255, 0.9);
      color: #333;
      min-width: 120px;
    }

    .control-input:focus {
      outline: none;
      background: white;
      box-shadow: 0 0 0 3px rgba(255, 255, 255, 0.3);
    }

    .file-input-wrapper {
      position: relative;
      overflow: hidden;
      display: inline-block;
    }

    .file-input-button {
      background: rgba(255, 255, 255, 0.2);
      color: white;
      padding: 12px 24px;
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-radius: 25px;
      cursor: pointer;
      font-size: 16px;
      font-weight: 500;
      transition: all 0.3s ease;
      backdrop-filter: blur(10px);
    }

    .file-input-button:hover {
      background: rgba(255, 255, 255, 0.3);
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    #fileInput {
      position: absolute;
      left: -9999px;
      opacity: 0;
    }

    .action-buttons {
      display: flex;
      gap: 15px;
      justify-content: center;
      flex-wrap: wrap;
    }

    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 25px;
      font-size: 16px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
      text-decoration: none;
      display: inline-block;
      text-align: center;
    }

    .btn-primary {
      background: #ff6b6b;
      color: white;
    }

    .btn-secondary {
      background: rgba(255, 255, 255, 0.2);
      color: white;
      border: 2px solid rgba(255, 255, 255, 0.3);
    }

    .btn-success {
      background: #51cf66;
      color: white;
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    /* 内容区域 */
    .content-section {
      padding: 30px;
    }

    /* 状态消息 */
    #statusMessage {
      text-align: center;
      font-size: 16px;
      font-weight: 500;
      margin-bottom: 20px;
      padding: 15px;
      border-radius: 10px;
      background: #e3f2fd;
      color: #1976d2;
      border-left: 4px solid #2196f3;
    }

    /* 进度条 */
    .progress-container {
      width: 100%;
      background: #f0f0f0;
      border-radius: 10px;
      overflow: hidden;
      margin: 20px 0;
      display: none;
    }

    .progress-bar {
      height: 20px;
      background: linear-gradient(90deg, #ff6b6b, #ee5a24);
      width: 0%;
      transition: width 0.3s ease;
      border-radius: 10px;
      position: relative;
    }

    .progress-text {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: white;
      font-size: 12px;
      font-weight: 500;
    }

    /* PDF文件显示 */
    #result {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }

    .pdf-container {
      background: white;
      border-radius: 15px;
      padding: 20px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      border: 1px solid #f0f0f0;
    }

    .pdf-container:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
    }

    .pdf-icon {
      width: 80px;
      height: 80px;
      background: linear-gradient(135deg, #ff6b6b, #ee5a24);
      border-radius: 15px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 15px;
      font-size: 32px;
      color: white;
    }

    .file-name {
      margin-top: 12px;
      font-size: 14px;
      font-weight: 500;
      color: #333;
      text-align: center;
      word-break: break-all;
    }

    .size-info {
      margin-top: 8px;
      font-size: 12px;
      text-align: center;
      font-weight: 500;
    }

    .individual-download {
      margin-top: 12px;
      display: block;
      text-align: center;
      padding: 8px 16px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      text-decoration: none;
      border-radius: 20px;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.3s ease;
    }

    .individual-download:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
    }

    /* 拖拽覆盖层 */
    .drag-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(255, 107, 107, 0.9);
      backdrop-filter: blur(10px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      font-size: 32px;
      color: white;
      font-weight: 600;
      text-align: center;
      border: 3px dashed #4fd1c5;
      box-sizing: border-box;
      margin: 20px;
      border-radius: 20px;
      animation: borderPulse 2s ease-in-out infinite;
    }

    .drag-overlay.show {
      display: flex;
    }

    .drag-overlay::before {
      content: "📄 拖拽PDF文件到此处开始压缩";
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% {
        opacity: 1;
      }
      50% {
        opacity: 0.7;
      }
    }

    @keyframes borderPulse {
      0% {
        border-color: rgba(79, 209, 197, 0.3);
        box-shadow: 0 0 0 rgba(79, 209, 197, 0.3);
      }
      50% {
        border-color: rgba(79, 209, 197, 1);
        box-shadow: 0 0 20px rgba(79, 209, 197, 0.6);
      }
      100% {
        border-color: rgba(79, 209, 197, 0.3);
        box-shadow: 0 0 0 rgba(79, 209, 197, 0.3);
      }
    }

    /* 响应式设计 */
    @media (max-width: 768px) {
      .controls-container {
        justify-content: flex-start;
      }

      .btn,
      .file-input-button {
        padding: 10px 16px;
        font-size: 14px;
      }

      .control-input {
        min-width: inherit;
      }

      .action-buttons {
        width: 100%;
      }

      #result {
        grid-template-columns: 1fr;
      }

      .header-title {
        font-size: 24px;
      }
    }
  </style>
  <!-- 加载PDF处理库和文件保存库 -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.17.1/pdf-lib.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
</head>

<body>
  <!-- 拖拽覆盖层 -->
  <div id="dragOverlay" class="drag-overlay"></div>

  <div class="main-container">
    <!-- 顶部控制区域 -->
    <div class="header-section">
      <h1 class="header-title">📄 智能PDF压缩工具</h1>

      <div class="controls-container">
        <!-- 文件选择 -->
        <div class="control-group">
          <label>选择PDF文件</label>
          <div class="file-input-wrapper">
            <div class="file-input-button" onclick="document.getElementById('fileInput').click()">
              📁 选择文件
            </div>
            <input type="file" id="fileInput" accept=".pdf,application/pdf" multiple />
          </div>
        </div>

        <!-- 压缩级别选择 -->
        <div class="control-group">
          <label>压缩级别</label>
          <select id="compressionLevel" class="control-input">
            <option value="low">轻度压缩</option>
            <option value="medium" selected>中度压缩</option>
            <option value="high">高度压缩</option>
          </select>
        </div>

        <!-- 操作按钮 -->
        <div class="action-buttons">
          <button id="compressButton" class="btn btn-primary">
            🚀 开始压缩
          </button>
          <button id="clearButton" class="btn btn-secondary">
            🗑️ 清除文件
          </button>
          <a id="downloadButton" class="btn btn-success" style="display: none">📦 下载全部</a>
        </div>
      </div>
    </div>

    <!-- 内容区域 -->
    <div class="content-section">
      <!-- 状态消息 -->
      <div id="statusMessage" style="display: none"></div>

      <!-- 进度条 -->
      <div id="progressContainer" class="progress-container">
        <div id="progressBar" class="progress-bar">
          <div id="progressText" class="progress-text">0%</div>
        </div>
      </div>

      <!-- 展示压缩后的PDF -->
      <div id="result"></div>
    </div>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", function () {
      // 获取元素的引用
      const fileInput = document.getElementById("fileInput");
      const compressionLevel = document.getElementById("compressionLevel");
      const compressButton = document.getElementById("compressButton");
      const downloadButton = document.getElementById("downloadButton");
      const clearButton = document.getElementById("clearButton");
      const resultDiv = document.getElementById("result");
      const statusMessage = document.getElementById("statusMessage");
      const dragOverlay = document.getElementById("dragOverlay");
      const progressContainer = document.getElementById("progressContainer");
      const progressBar = document.getElementById("progressBar");
      const progressText = document.getElementById("progressText");

      let compressedPDFs = []; // 存储压缩后的PDF数据
      let compressionInProgress = false; // 标识压缩状态
      let isDragging = false; // 拖拽状态

      // 监听文件选择
      fileInput.addEventListener("change", handleFileSelect, false);

      // 拖拽事件处理
      window.addEventListener("dragover", function (e) {
        e.preventDefault();
        if (!isDragging) {
          isDragging = true;
          dragOverlay.classList.add("show");
        }
      });

      window.addEventListener("dragleave", function (e) {
        e.preventDefault();
        if (
          e.clientX <= 0 ||
          e.clientY <= 0 ||
          e.clientX >= window.innerWidth ||
          e.clientY >= window.innerHeight
        ) {
          isDragging = false;
          dragOverlay.classList.remove("show");
        }
      });

      window.addEventListener("drop", function (e) {
        e.preventDefault();
        isDragging = false;
        dragOverlay.classList.remove("show");

        const files = e.dataTransfer.files;
        if (files.length > 0) {
          fileInput.files = files;
          handleFileSelect({ target: { files: files } });
          
          // 自动开始压缩
          setTimeout(() => {
            compressPDFs();
          }, 100);
        }
      });

      // 压缩按钮点击事件
      compressButton.addEventListener("click", compressPDFs);

      // 下载按钮点击事件
      downloadButton.addEventListener("click", function () {
        if (!compressionInProgress && compressedPDFs.length > 0) {
          if (compressedPDFs.length === 1) {
            downloadPDF(compressedPDFs[0].blob, compressedPDFs[0].fileName);
          } else {
            downloadAllPDFs();
          }
        }
      });

      // 清除按钮事件处理
      clearButton.addEventListener("click", function () {
        resetCompressionState();
        fileInput.value = "";
        statusMessage.style.display = "none";
        progressContainer.style.display = "none";
      });

      /**
       * 压缩PDF文件的主要函数
       */
      async function compressPDFs() {
        const files = fileInput.files;
        if (files.length === 0) {
          showMessage("请先选择PDF文件。", "error");
          return;
        }

        if (compressionInProgress) {
          showMessage("压缩正在进行中，请稍候...", "warning");
          return;
        }

        // 重置状态
        resetCompressionState();
        compressionInProgress = true;
        compressButton.disabled = true;

        // 显示进度条
        progressContainer.style.display = "block";
        showMessage("🔄 PDF压缩中...", "info");

        try {
          const level = compressionLevel.value;
          let completedFiles = 0;

          for (let i = 0; i < files.length; i++) {
            const file = files[i];
            updateProgress((i / files.length) * 100, `正在压缩: ${file.name}`);

            try {
              const compressedData = await compressSinglePDF(file, level);
              compressedPDFs.push(compressedData);
              displayPDF(compressedData);
              completedFiles++;
            } catch (error) {
              console.error(`压缩文件 ${file.name} 失败:`, error);
              showMessage(`❌ 压缩文件 ${file.name} 失败: ${error.message}`, "error");
            }

            updateProgress(((i + 1) / files.length) * 100, `已完成: ${i + 1}/${files.length}`);
          }

          if (completedFiles > 0) {
            showMessage(`✅ 成功压缩 ${completedFiles} 个PDF文件！`, "success");
            downloadButton.style.display = "block";
            
            // 如果只有一个文件，自动下载
            if (completedFiles === 1) {
              setTimeout(() => {
                downloadPDF(compressedPDFs[0].blob, compressedPDFs[0].fileName);
              }, 1000);
            }
          } else {
            showMessage("❌ 没有文件被成功压缩", "error");
          }

        } catch (error) {
          console.error("压缩过程中出现错误:", error);
          showMessage("❌ 压缩过程中出现错误", "error");
        } finally {
          compressionInProgress = false;
          compressButton.disabled = false;
          progressContainer.style.display = "none";
        }
      }

      /**
       * 压缩单个PDF文件
       * @param {File} file - 要压缩的PDF文件
       * @param {string} level - 压缩级别
       * @returns {Promise} 压缩结果
       */
      async function compressSinglePDF(file, level) {
        const arrayBuffer = await file.arrayBuffer();
        const pdfDoc = await PDFLib.PDFDocument.load(arrayBuffer);

        // 根据压缩级别设置参数
        const compressionSettings = {
          low: { imageQuality: 0.8, removeMetadata: false },
          medium: { imageQuality: 0.6, removeMetadata: true },
          high: { imageQuality: 0.4, removeMetadata: true }
        };

        const settings = compressionSettings[level];

        // 移除元数据（如果设置了的话）
        if (settings.removeMetadata) {
          try {
            pdfDoc.setTitle('');
            pdfDoc.setAuthor('');
            pdfDoc.setSubject('');
            pdfDoc.setKeywords([]);
            pdfDoc.setProducer('');
            pdfDoc.setCreator('');
          } catch (e) {
            // 忽略元数据移除错误
          }
        }

        // 生成压缩后的PDF
        const pdfBytes = await pdfDoc.save({
          useObjectStreams: true,
          addDefaultPage: false,
          objectsPerTick: 50,
        });

        const originalSize = file.size;
        const compressedSize = pdfBytes.length;
        const compressionRatio = ((originalSize - compressedSize) / originalSize * 100).toFixed(1);

        const blob = new Blob([pdfBytes], { type: 'application/pdf' });
        const fileName = generateFileName(file.name);

        return {
          blob,
          fileName,
          originalSize,
          compressedSize,
          compressionRatio,
          pageCount: pdfDoc.getPageCount()
        };
      }

      /**
       * 生成新的文件名
       * @param {string} originalName - 原始文件名
       * @returns {string} 新文件名
       */
      function generateFileName(originalName) {
        const nameWithoutExt = originalName.replace(/\.pdf$/i, '');
        return `${nameWithoutExt}_compressed.pdf`;
      }

      /**
       * 显示压缩后的PDF信息
       * @param {Object} pdfData - PDF数据对象
       */
      function displayPDF(pdfData) {
        const container = document.createElement("div");
        container.classList.add("pdf-container");

        // PDF图标
        const pdfIcon = document.createElement("div");
        pdfIcon.classList.add("pdf-icon");
        pdfIcon.textContent = "📄";

        // 文件名标签
        const fileNameLabel = document.createElement("div");
        fileNameLabel.classList.add("file-name");
        fileNameLabel.textContent = pdfData.fileName;

        // 页数信息
        const pageInfo = document.createElement("div");
        pageInfo.style.marginTop = "8px";
        pageInfo.style.fontSize = "12px";
        pageInfo.style.textAlign = "center";
        pageInfo.style.color = "#666";
        pageInfo.style.fontWeight = "500";
        pageInfo.textContent = `${pdfData.pageCount} 页`;

        // 文件大小信息
        const sizeInfo = document.createElement("div");
        sizeInfo.classList.add("size-info");

        const originalSizeText = document.createElement("span");
        originalSizeText.style.color = "black";
        originalSizeText.textContent = `${formatFileSize(pdfData.originalSize)} `;

        const separator = document.createElement("span");
        separator.textContent = "→ ";
        separator.style.color = "#666";

        const compressedSizeText = document.createElement("span");
        compressedSizeText.style.color = "green";
        compressedSizeText.textContent = `${formatFileSize(pdfData.compressedSize)}`;

        const ratioText = document.createElement("span");
        ratioText.style.color = pdfData.compressionRatio > 0 ? "green" : "red";
        ratioText.style.marginLeft = "8px";
        ratioText.style.fontSize = "11px";
        ratioText.textContent = `(${pdfData.compressionRatio > 0 ? "-" : "+"}${Math.abs(pdfData.compressionRatio)}%)`;

        sizeInfo.appendChild(originalSizeText);
        sizeInfo.appendChild(separator);
        sizeInfo.appendChild(compressedSizeText);
        sizeInfo.appendChild(ratioText);

        // 单独下载按钮
        const individualDownloadButton = document.createElement("a");
        individualDownloadButton.classList.add("individual-download");
        individualDownloadButton.textContent = "📥 下载";
        individualDownloadButton.href = "#";
        individualDownloadButton.onclick = function (e) {
          e.preventDefault();
          downloadPDF(pdfData.blob, pdfData.fileName);
        };

        // 组装容器
        container.appendChild(pdfIcon);
        container.appendChild(fileNameLabel);
        container.appendChild(pageInfo);
        container.appendChild(sizeInfo);
        container.appendChild(individualDownloadButton);
        resultDiv.appendChild(container);
      }

      /**
       * 下载单个PDF文件
       * @param {Blob} blob - PDF文件blob
       * @param {string} fileName - 文件名
       */
      function downloadPDF(blob, fileName) {
        try {
          saveAs(blob, fileName);
          showMessage(`📥 ${fileName} 下载完成！`, "success");
        } catch (error) {
          console.error("下载失败:", error);
          showMessage("❌ 下载失败", "error");
        }
      }

      /**
       * 下载所有压缩后的PDF文件（打包为ZIP）
       */
      async function downloadAllPDFs() {
        if (compressedPDFs.length === 0) {
          showMessage("没有可下载的文件", "warning");
          return;
        }

        try {
          // 如果只有一个文件，直接下载
          if (compressedPDFs.length === 1) {
            downloadPDF(compressedPDFs[0].blob, compressedPDFs[0].fileName);
            return;
          }

          // 多个文件时，创建ZIP包
          const JSZip = window.JSZip;
          if (!JSZip) {
            showMessage("❌ ZIP库未加载，请刷新页面重试", "error");
            return;
          }

          const zip = new JSZip();
          const timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, "-");

          // 将每个PDF文件添加到ZIP
          for (const pdfData of compressedPDFs) {
            const arrayBuffer = await pdfData.blob.arrayBuffer();
            zip.file(pdfData.fileName, arrayBuffer);
          }

          showMessage("📦 正在打包下载文件...", "info");
          const content = await zip.generateAsync({ type: "blob" });
          saveAs(content, `compressed-pdfs-${timestamp}.zip`);
          showMessage("✅ 下载完成！", "success");

        } catch (error) {
          console.error("打包下载失败:", error);
          showMessage("❌ 打包下载失败", "error");
        }
      }

      /**
       * 更新进度条
       * @param {number} percentage - 进度百分比
       * @param {string} text - 进度文本
       */
      function updateProgress(percentage, text) {
        progressBar.style.width = percentage + "%";
        progressText.textContent = Math.round(percentage) + "%";
        if (text) {
          showMessage(text, "info");
        }
      }

      /**
       * 重置压缩状态
       */
      function resetCompressionState() {
        compressedPDFs = [];
        resultDiv.innerHTML = "";
        downloadButton.style.display = "none";
        progressBar.style.width = "0%";
        progressText.textContent = "0%";
      }

      /**
       * 显示状态消息
       * @param {string} message - 消息内容
       * @param {string} type - 消息类型
       */
      function showMessage(message, type = "info") {
        statusMessage.style.display = "block";
        statusMessage.textContent = message;

        const colors = {
          info: { bg: "#e3f2fd", color: "#1976d2", border: "#2196f3" },
          success: { bg: "#e8f5e8", color: "#2e7d32", border: "#4caf50" },
          error: { bg: "#ffebee", color: "#c62828", border: "#f44336" },
          warning: { bg: "#fff3e0", color: "#ef6c00", border: "#ff9800" },
        };

        const style = colors[type] || colors.info;
        statusMessage.style.background = style.bg;
        statusMessage.style.color = style.color;
        statusMessage.style.borderLeftColor = style.border;
      }

      /**
       * 格式化文件大小显示
       * @param {number} bytes - 文件大小（字节）
       * @returns {string} 格式化后的文件大小字符串
       */
      function formatFileSize(bytes) {
        if (bytes === 0) return "0 B";
        const k = 1024;
        const sizes = ["B", "KB", "MB", "GB"];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + " " + sizes[i];
      }

      /**
       * 处理文件选择事件
       * @param {Event} event - 文件选择事件
       */
      function handleFileSelect(event) {
        const files = event.target.files;

        if (!files.length) {
          return;
        }

        // 验证文件类型
        const invalidFiles = Array.from(files).filter(
          (file) => !file.type.match("application/pdf") && !file.name.toLowerCase().endsWith('.pdf')
        );
        
        if (invalidFiles.length > 0) {
          showMessage(
            `❌ 检测到 ${invalidFiles.length} 个非PDF文件，请只选择PDF文件。`,
            "error"
          );
          return;
        }

        downloadButton.style.display = "none";
        showMessage(`📁 已选择 ${files.length} 个PDF文件`, "info");
      }
    });
  </script>
</body>

</html>
