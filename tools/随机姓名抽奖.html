<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3D 随机姓名抽奖</title>
    <style>
        :root {
            --primary-color: #ff3b30;
            --secondary-color: #ff9f0a;
            --bg-color: #1c1c1e;
            --card-bg: #2c2c2e;
            --border-color: #3a3a3c;
            --text-color: #fff;
            --text-secondary: #8e8e93;
            --item-height: 80px;
            --visible-count: 5; /* 屏幕上可见的数量 */
        }

        body {
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        /* 左侧：抽奖主舞台 */
        .stage-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            position: relative;
            background: radial-gradient(circle at center, #2c2c2e 0%, #000 100%);
        }

        /* 3D 滚轮容器 */
        .lottery-wheel {
            position: relative;
            width: 400px;
            height: calc(var(--item-height) * var(--visible-count)); /* 80px * 5 = 400px */
            overflow: hidden;
            perspective: 1000px; /* 3D 透视关键 */
            mask-image: linear-gradient(to bottom, 
                transparent 0%, 
                black 20%, 
                black 80%, 
                transparent 100%
            );
            -webkit-mask-image: linear-gradient(to bottom, 
                transparent 0%, 
                black 20%, 
                black 80%, 
                transparent 100%
            );
            border-left: 2px solid rgba(255,255,255,0.1);
            border-right: 2px solid rgba(255,255,255,0.1);
        }

        /* 名字列表 */
        .name-list {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            list-style: none;
            padding: 0;
            margin: 0;
            transform-style: preserve-3d;
        }

        .name-item {
            height: var(--item-height);
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 32px;
            font-weight: bold;
            color: rgba(255, 255, 255, 0.5);
            backface-visibility: hidden;
            transition: color 0.2s;
            white-space: nowrap;
        }

        .name-item.active {
            color: #fff;
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.8);
            font-size: 40px;
        }

        /* 选中框指示器 */
        .highlight-bar {
            position: absolute;
            top: 50%;
            left: 0;
            width: 100%;
            height: var(--item-height);
            transform: translateY(-50%);
            border-top: 2px solid var(--primary-color);
            border-bottom: 2px solid var(--primary-color);
            background: rgba(255, 59, 48, 0.1);
            pointer-events: none;
            z-index: 10;
            box-shadow: 0 0 20px rgba(255, 59, 48, 0.2);
        }

        /* 控制区 */
        .controls {
            margin-top: 40px;
            z-index: 20;
            display: flex;
            gap: 20px;
        }

        .btn {
            padding: 15px 40px;
            font-size: 20px;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            transition: transform 0.1s, background-color 0.3s, box-shadow 0.3s;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 1px;
            outline: none;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .btn:active {
            transform: scale(0.95);
        }

        .btn:disabled {
            background-color: #48484a;
            cursor: not-allowed;
            box-shadow: none;
            color: #8e8e93;
        }

        .btn-primary {
            background-color: var(--primary-color);
            box-shadow: 0 4px 15px rgba(255, 59, 48, 0.4);
        }

        .btn-warning {
            background-color: var(--secondary-color);
            box-shadow: 0 4px 15px rgba(255, 159, 10, 0.4);
        }

        .btn-secondary {
            background-color: #3a3a3c;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            font-size: 16px;
            padding: 15px 30px;
        }

        /* 右侧：侧边栏 */
        .sidebar {
            width: 350px;
            background-color: var(--card-bg);
            padding: 20px;
            display: flex;
            flex-direction: column;
            border-left: 1px solid var(--border-color);
            box-shadow: -5px 0 15px rgba(0,0,0,0.3);
        }

        h2 {
            margin-top: 0;
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 10px;
            font-size: 18px;
            color: var(--text-secondary);
        }

        .prize-section {
            flex: 1;
            overflow-y: auto;
            margin-bottom: 20px;
            /* 美化滚动条 */
            scrollbar-width: thin;
            scrollbar-color: #48484a transparent;
        }

        .prize-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: var(--border-color);
            margin-bottom: 8px;
            border-radius: 8px;
            transition: all 0.3s;
        }

        .prize-item.current {
            background: rgba(255, 59, 48, 0.2);
            border: 1px solid var(--primary-color);
        }

        .prize-item.done {
            opacity: 0.4;
            text-decoration: line-through;
        }

        .prize-name { font-weight: bold; }
        .prize-count { 
            background: #000; 
            padding: 2px 8px; 
            border-radius: 10px; 
            font-size: 12px;
        }

        .winner-section {
            flex: 1;
            overflow-y: auto;
            scrollbar-width: thin;
        }

        .winner-list {
            list-style: none;
            padding: 0;
        }

        .winner-item {
            padding: 8px 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            font-size: 14px;
            display: flex;
            justify-content: space-between;
        }
        
        .winner-item span:first-child { color: var(--secondary-color); }

        /* 通用弹窗样式 */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 100;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
            backdrop-filter: blur(5px);
        }

        .modal.show {
            opacity: 1;
            pointer-events: auto;
        }

        /* 结果弹窗内容 */
        .result-content {
            background: linear-gradient(135deg, #1c1c1e, #2c2c2e);
            padding: 40px 60px;
            border-radius: 20px;
            text-align: center;
            border: 2px solid var(--primary-color);
            transform: scale(0.5);
            transition: transform 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: 0 0 50px rgba(255, 59, 48, 0.5);
        }

        .modal.show .result-content { transform: scale(1); }
        .modal-title { font-size: 24px; color: var(--text-secondary); margin-bottom: 10px; }
        .modal-name { font-size: 60px; font-weight: bold; color: #fff; margin: 20px 0; }
        .modal-prize { font-size: 30px; color: var(--primary-color); }

        /* 人员管理弹窗内容 */
        .user-manage-content {
            background: var(--card-bg);
            width: 600px;
            max-width: 90%;
            max-height: 80vh;
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
            transform: translateY(20px);
            transition: transform 0.3s;
        }
        
        .modal.show .user-manage-content { transform: translateY(0); }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #252527;
        }

        .modal-header h3 { margin: 0; font-size: 20px; }
        .close-btn { background: none; border: none; color: #fff; font-size: 24px; cursor: pointer; padding: 0 10px; }

        .modal-body {
            padding: 20px;
            overflow-y: auto;
            flex: 1;
        }

        /* 添加人员输入区域 */
        .add-user-area {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .add-user-input {
            flex: 1;
            padding: 10px 15px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            background: #1c1c1e;
            color: #fff;
            font-size: 14px;
        }

        .add-user-btn {
            padding: 10px 20px;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            white-space: nowrap;
        }

        /* 人员列表表格 */
        .user-table {
            width: 100%;
            border-collapse: collapse;
        }

        .user-table th {
            text-align: left;
            padding: 10px;
            color: var(--text-secondary);
            border-bottom: 1px solid var(--border-color);
            position: sticky;
            top: 0;
            background: var(--card-bg);
        }

        .user-table td {
            padding: 10px;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }

        .status-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
        }
        .status-pending { background: #3a3a3c; color: #aaa; }
        .status-won { background: rgba(255, 59, 48, 0.2); color: var(--primary-color); }

    </style>
</head>
<body>

    <!-- 主舞台 -->
    <div class="stage-container">
        <div class="lottery-wheel">
            <div class="highlight-bar"></div>
            <ul class="name-list" id="nameList">
                <!-- JS 动态生成 -->
            </ul>
        </div>

        <div class="controls">
            <button id="userManageBtn" class="btn btn-secondary">人员管理</button>
            <button id="actionBtn" class="btn btn-primary">开始抽奖</button>
        </div>
    </div>

    <!-- 侧边栏 -->
    <div class="sidebar">
        <h2>当前奖品池</h2>
        <div class="prize-section" id="prizeList">
            <!-- JS 动态生成 -->
        </div>

        <h2>中奖名单</h2>
        <div class="winner-section">
            <ul class="winner-list" id="winnerList">
                <!-- JS 动态生成 -->
            </ul>
        </div>
    </div>

    <!-- 中奖结果弹窗 -->
    <div class="modal" id="resultModal">
        <div class="result-content">
            <div class="modal-title">恭喜中奖</div>
            <div class="modal-prize" id="modalPrizeName">一等奖</div>
            <div class="modal-name" id="modalWinnerName">张三</div>
            <button class="btn btn-primary" onclick="closeResultModal()" style="margin-top: 20px;">确定</button>
        </div>
    </div>

    <!-- 人员管理弹窗 -->
    <div class="modal" id="userModal">
        <div class="user-manage-content">
            <div class="modal-header">
                <h3>人员列表</h3>
                <button class="close-btn" onclick="closeUserModal()">×</button>
            </div>
            <div class="modal-body">
                <div class="add-user-area">
                    <input type="text" id="addUserInput" class="add-user-input" placeholder="输入姓名，多个用逗号分隔 (如: 张三, 李四)">
                    <button class="add-user-btn" onclick="handleAddUsers()">添加</button>
                </div>
                <table class="user-table">
                    <thead>
                        <tr>
                            <th>姓名</th>
                            <th>状态</th>
                            <th>奖品</th>
                        </tr>
                    </thead>
                    <tbody id="userTableBody">
                        <!-- JS 填充 -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // ================= 配置数据 =================
        const initialNames = [
            "赵一", "钱二", "孙三", "李四", "周五", "吴六", "郑七", "王八", "冯九", "陈十",
            "褚十一", "卫十二", "蒋十三", "沈十四", "韩十五", "杨十六", "朱十七", "秦十八", "尤十九", "许二十"
        ];
        
        const initialPrizes = [
            { name: "特等奖：MacBook Pro", count: 1 },
            { name: "一等奖：iPhone 16", count: 2 },
            { name: "二等奖：iPad Air", count: 3 },
            { name: "三等奖：AirPods", count: 4 },
            { name: "四等奖：京东卡 500元", count: 5 },
            { name: "五等奖：精美公仔", count: 5 }
        ];

        // ================= 状态管理 =================
        // activeNames: 还在奖池中的人
        // winnerHistory: 已经中奖的人 { name, prize, time }
        let activeNames = [...initialNames];
        let winnerHistory = [];
        let prizes = JSON.parse(JSON.stringify(initialPrizes));
        
        // 动画相关
        let isRolling = false;
        let isStopping = false;
        let speed = 0;
        let currentOffset = 0;
        let animationId = null;
        let stopStartTime = 0;
        let initialStopSpeed = 0; // 记录点击停止时的瞬时速度
        
        const ITEM_HEIGHT = 80;
        const VISIBLE_COUNT = 5;
        
        // DOM
        const nameListEl = document.getElementById('nameList');
        const actionBtn = document.getElementById('actionBtn');
        const userManageBtn = document.getElementById('userManageBtn');
        const prizeListEl = document.getElementById('prizeList');
        const winnerListEl = document.getElementById('winnerList');
        
        // Modals
        const resultModal = document.getElementById('resultModal');
        const userModal = document.getElementById('userModal');
        const userTableBody = document.getElementById('userTableBody');
        const addUserInput = document.getElementById('addUserInput');

        // ================= 初始化 =================
        function init() {
            renderPrizes();
            renderWheel();
        }

        function renderWheel() {
            nameListEl.innerHTML = '';
            // 如果没人了，显示空
            if (activeNames.length === 0) return;

            // 构造显示列表：为了无缝滚动，至少要有足够的长度
            // 复制 activeNames 直到超过一定数量 (例如 30)
            let displayNames = [...activeNames];
            while (displayNames.length < 30) {
                displayNames = displayNames.concat(activeNames);
            }
            // 再复制一份用于无缝连接的尾巴
            displayNames = displayNames.concat(displayNames);

            displayNames.forEach(name => {
                const li = document.createElement('li');
                li.className = 'name-item';
                li.textContent = name;
                nameListEl.appendChild(li);
            });
        }

        function renderPrizes() {
            prizeListEl.innerHTML = '';
            let activeFound = false;
            
            prizes.forEach((prize) => {
                const div = document.createElement('div');
                div.className = 'prize-item';
                if (prize.count === 0) {
                    div.classList.add('done');
                } else if (!activeFound) {
                    div.classList.add('current');
                    activeFound = true;
                }
                
                div.innerHTML = `
                    <span class="prize-name">${prize.name}</span>
                    <span class="prize-count">剩余: ${prize.count}</span>
                `;
                prizeListEl.appendChild(div);
            });

            if (!activeFound && activeNames.length > 0) {
                actionBtn.textContent = "抽奖结束";
                actionBtn.disabled = true;
                actionBtn.className = 'btn btn-secondary';
            } else if (activeNames.length === 0) {
                actionBtn.textContent = "人员已空";
                actionBtn.disabled = true;
                actionBtn.className = 'btn btn-secondary';
            }
        }

        function getCurrentPrize() {
            return prizes.find(p => p.count > 0);
        }

        // ================= 动画核心 =================

        function update() {
            // 1. 物理计算
            if (isStopping) {
                const now = Date.now();
                const t = now - stopStartTime;
                const DURATION = 20000; // 设定 10秒 完整停下
                const MIN_CRAWL_SPEED = 0.5; // 最低龟爬速度

                if (t < DURATION) {
                    // --- 单一数学公式控制全程 (0s -> 10s) ---
                    // 进度 progress 从 0 变到 1
                    const progress = t / DURATION;
                    
                    // 使用五次幂缓动 (Quintic Ease Out)
                    // 指数越高，初期减速越快，后期的"龟爬"时间越长，悬念感越强
                    // 3 = 均衡，5 = 极强拖拽感
                    const decayFactor = Math.pow(1 - progress, 5);
                    
                    speed = (initialStopSpeed - MIN_CRAWL_SPEED) * decayFactor + MIN_CRAWL_SPEED;
                } else {
                    // --- 超时停止阶段 ---
                    // 此时速度已经非常接近 MIN_CRAWL_SPEED (0.5)
                    // 保持这个速度直到对齐
                    speed = MIN_CRAWL_SPEED;
                    
                    const remainder = currentOffset % ITEM_HEIGHT;
                    // 检测对齐 (允许 1px 误差)
                    if (remainder < 1 || remainder > ITEM_HEIGHT - 1) {
                        speed = 0;
                        isRolling = false;
                        isStopping = false;
                        
                        // 修正位置
                        currentOffset = Math.round(currentOffset / ITEM_HEIGHT) * ITEM_HEIGHT;
                        
                        // 结束动画循环，进入结算
                        finishLottery();
                        return; 
                    }
                }
            }

            // 更新位移
            currentOffset += speed;
            
            // 无缝循环逻辑
            const totalHeight = nameListEl.scrollHeight / 2;
            if (currentOffset >= totalHeight) {
                currentOffset -= totalHeight;
            }

            // 渲染位移
            // 向上滚动 => translateY 为负
            const visualOffset = -(currentOffset % totalHeight);
            nameListEl.style.transform = `translateY(${visualOffset}px)`;

            // 3D 效果计算
            update3DEffect(visualOffset);

            if (isRolling || isStopping) {
                animationId = requestAnimationFrame(update);
            }
        }

        function update3DEffect(visualOffset) {
            const items = nameListEl.children;
            const containerCenter = (ITEM_HEIGHT * VISIBLE_COUNT) / 2; 

            for (let i = 0; i < items.length; i++) {
                const item = items[i];
                // 加上 visualOffset (负数) 才是当前的真实 Y 坐标
                const itemY = (i * ITEM_HEIGHT) + visualOffset; 
                const itemCenterY = itemY + (ITEM_HEIGHT / 2);
                
                // 距离视口中心的距离
                const dist = Math.abs(containerCenter - itemCenterY);
                
                if (dist < 400) {
                    const normalizedDist = Math.min(dist / 250, 1);
                    const rotateDir = itemCenterY < containerCenter ? 1 : -1;
                    const rotateX = normalizedDist * 45 * rotateDir;
                    const scale = 1 - (normalizedDist * 0.3);
                    const opacity = 1 - (normalizedDist * 0.7);
                    
                    item.style.transform = `perspective(1000px) rotateX(${rotateX}deg) scale(${scale})`;
                    item.style.opacity = opacity;

                    if (dist < ITEM_HEIGHT / 2) {
                        item.classList.add('active');
                    } else {
                        item.classList.remove('active');
                    }
                }
            }
        }

        // ================= 交互控制 =================
        
        actionBtn.addEventListener('click', () => {
            if (!isRolling && !isStopping) {
                startRoll();
            } else if (isRolling && !isStopping) {
                stopRoll();
            }
        });

        function startRoll() {
            if (!getCurrentPrize()) {
                alert("所有奖品已抽完！");
                return;
            }
            if (activeNames.length === 0) {
                alert("人员已空！请添加人员。");
                return;
            }

            isRolling = true;
            isStopping = false;
            speed = 40; // 初始高速
            
            actionBtn.textContent = "停止";
            actionBtn.className = "btn btn-warning";
            userManageBtn.disabled = true; // 抽奖中禁止操作人员
            
            update();
        }

        function stopRoll() {
            isStopping = true;
            stopStartTime = Date.now();
            initialStopSpeed = speed; // 锁定初始速度
            actionBtn.textContent = "好运降临...";
            actionBtn.disabled = true;
            actionBtn.className = "btn btn-secondary";
        }

        function finishLottery() {
            const activeItem = document.querySelector('.name-item.active');
            if (!activeItem) {
                // 极端情况未对齐
                stopRoll(); return;
            }

            const winnerName = activeItem.textContent;
            const currentPrize = getCurrentPrize();
            
            // 延迟 2秒 弹出结果
            setTimeout(() => {
                // 记录数据
                winnerHistory.push({
                    name: winnerName,
                    prize: currentPrize.name,
                    time: new Date().toLocaleTimeString()
                });

                // 移除获奖者
                const idx = activeNames.indexOf(winnerName);
                if (idx > -1) activeNames.splice(idx, 1);

                // 扣减奖品
                currentPrize.count--;

                // UI 更新
                showResultModal(winnerName, currentPrize);
                renderPrizes();
                addWinnerToList(winnerName, currentPrize.name);
            }, 2000);
        }

        // ================= UI 与 弹窗 =================

        function showResultModal(name, prize) {
            document.getElementById('modalPrizeName').textContent = prize.name.split('：')[0];
            document.getElementById('modalWinnerName').textContent = name;
            resultModal.classList.add('show');
        }

        function closeResultModal() {
            resultModal.classList.remove('show');
            actionBtn.disabled = false;
            actionBtn.textContent = "开始抽奖";
            actionBtn.className = "btn btn-primary";
            userManageBtn.disabled = false;
            
            // 重要：重置滚动位置和列表
            currentOffset = 0;
            nameListEl.style.transform = `translateY(0px)`;
            renderWheel();
            
            // 重新初始化 3D 状态 (防止第一帧闪烁)
            update3DEffect(0);
        }

        function addWinnerToList(name, prizeName) {
            const li = document.createElement('li');
            li.className = 'winner-item';
            li.innerHTML = `
                <span>${name}</span>
                <span style="color:#aaa">${prizeName.split('：')[1] || prizeName}</span>
            `;
            winnerListEl.prepend(li); // 最新在最前
        }

        // ================= 人员管理 =================

        userManageBtn.addEventListener('click', () => {
            renderUserTable();
            userModal.classList.add('show');
        });

        function closeUserModal() {
            userModal.classList.remove('show');
        }

        function renderUserTable() {
            userTableBody.innerHTML = '';
            
            // 合并列表：待抽奖在前，已中奖在后
            // 1. 待抽奖
            activeNames.forEach(name => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${name}</td>
                    <td><span class="status-badge status-pending">待抽奖</span></td>
                    <td>-</td>
                `;
                userTableBody.appendChild(tr);
            });

            // 2. 已中奖 (反转顺序，最近中奖的在上面)
            [...winnerHistory].reverse().forEach(record => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${record.name}</td>
                    <td><span class="status-badge status-won">已中奖</span></td>
                    <td>${record.prize}</td>
                `;
                userTableBody.appendChild(tr);
            });
        }

        function handleAddUsers() {
            const val = addUserInput.value.trim();
            if (!val) return;

            // 支持中英文逗号，换行符分隔
            const newNames = val.split(/[,，\n]/)
                .map(s => s.trim())
                .filter(s => s.length > 0);

            if (newNames.length === 0) return;

            // 去重添加
            let count = 0;
            newNames.forEach(name => {
                // 检查是否已经在待抽列表或已中奖列表
                const isPending = activeNames.includes(name);
                const isWon = winnerHistory.some(w => w.name === name);
                
                if (!isPending && !isWon) {
                    activeNames.push(name);
                    count++;
                }
            });

            addUserInput.value = '';
            alert(`成功添加 ${count} 位新人员！`);
            renderUserTable();
            renderWheel(); // 刷新主舞台滚轮
            renderPrizes(); // 更新按钮状态（如果之前没人了）
        }

        // 初始化
        init();

    </script>
</body>
</html>
