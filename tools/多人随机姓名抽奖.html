<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¤šäººéšæœºå§“åæŠ½å¥– - å–œåº†ç‰ˆ</title>
    <style>
        :root {
            --primary-red: #D42721;
            --dark-red: #8B0000;
            --gold: #FFD700;
            --light-gold: #FFFACD;
            --text-color: #333;
            --border-radius: 12px;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: "Microsoft YaHei", "Heiti SC", sans-serif;
            background: radial-gradient(circle at center, #e63946, #8B0000);
            min-height: 100vh;
            color: var(--light-gold);
            overflow-x: hidden;
            display: flex;
            flex-direction: column;
        }

        /* èƒŒæ™¯è£…é¥° - äº‘çº¹/ç¯ç¬¼ (CSSç»˜åˆ¶ç®€å•ç¤ºæ„) */
        .bg-pattern {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                radial-gradient(var(--gold) 1px, transparent 1px),
                radial-gradient(var(--gold) 1px, transparent 1px);
            background-size: 50px 50px;
            background-position: 0 0, 25px 25px;
            opacity: 0.1;
            pointer-events: none;
            z-index: 0;
        }

        .lantern {
            position: absolute;
            top: -20px;
            width: 80px;
            height: 100px;
            background: var(--primary-red);
            border-radius: 50px;
            border: 4px solid var(--gold);
            box-shadow: 0 0 20px var(--gold);
            z-index: 1;
            animation: swing 3s infinite ease-in-out alternate;
        }
        .lantern::after {
            content: '';
            position: absolute;
            bottom: -20px;
            left: 30px;
            width: 20px;
            height: 40px;
            background: var(--gold);
        }
        .lantern.left { left: 5%; }
        .lantern.right { right: 5%; animation-delay: 1s; }

        @keyframes swing {
            from { transform: rotate(-5deg); }
            to { transform: rotate(5deg); }
        }

        /* ä¸»å®¹å™¨ */
        .container {
            position: relative;
            z-index: 10;
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
            margin-top: 20px;
        }

        h1 {
            font-size: 3.5rem;
            color: var(--gold);
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5), 0 0 20px var(--gold);
            letter-spacing: 5px;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .subtitle {
            font-size: 1.2rem;
            color: var(--light-gold);
            opacity: 0.9;
        }

        /* æŠ½å¥–ä¸»åŒºåŸŸ */
        .main-stage {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 4px solid var(--gold);
            border-radius: 20px;
            padding: 40px;
            width: 100%;
            max-width: 900px;
            text-align: center;
            box-shadow: 0 0 50px rgba(0,0,0,0.3);
            margin-bottom: 30px;
            position: relative;
        }

        /* å¥–å“é€‰æ‹©æ  */
        .prize-selector {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .prize-card {
            background: linear-gradient(135deg, #fff, #f0f0f0);
            color: var(--dark-red);
            padding: 10px 20px;
            border-radius: 10px;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.3s;
            min-width: 120px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
            position: relative;
            overflow: hidden;
        }

        .prize-card.active {
            background: var(--gold);
            border-color: #fff;
            transform: scale(1.05);
            font-weight: bold;
            box-shadow: 0 0 15px var(--gold);
        }

        .prize-card .prize-name { font-size: 1.1rem; }
        .prize-card .prize-count { font-size: 0.9rem; opacity: 0.8; }
        
        /* è¿›åº¦æ¡æ•ˆæœ */
        .prize-progress {
            position: absolute;
            bottom: 0;
            left: 0;
            height: 4px;
            background: var(--primary-red);
            width: 0%;
            transition: width 0.3s;
        }

        /* æ»šåŠ¨åå­—æ˜¾ç¤º */
        .rolling-display {
            font-size: 5rem;
            font-weight: bold;
            color: #fff;
            height: 200px;
            display: flex;
            justify-content: center;
            align-items: center;
            text-shadow: 0 0 10px rgba(0,0,0,0.5);
            margin: 20px 0;
            perspective: 1000px;
        }

        .rolling-name {
            display: inline-block;
            animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        /* ç»“æœå±•ç¤ºåŒº (ç”¨äºä¸€æ¬¡æŠ½å¤šä¸ª) */
        .winners-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
            margin-top: 20px;
            display: none; /* é»˜è®¤éšè—ï¼ŒæŠ½å¥–ç»“æŸåæ˜¾ç¤º */
        }
        
        .winner-card {
            background: var(--gold);
            color: var(--primary-red);
            padding: 15px;
            border-radius: 10px;
            font-size: 1.5rem;
            font-weight: bold;
            animation: zoomIn 0.5s;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        @keyframes zoomIn {
            from { transform: scale(0); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        /* æ§åˆ¶æŒ‰é’® */
        .controls {
            display: flex;
            gap: 20px;
            justify-content: center;
            align-items: center;
        }

        .btn {
            padding: 15px 40px;
            font-size: 1.5rem;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
            text-transform: uppercase;
            box-shadow: 0 4px 0 rgba(0,0,0,0.2);
        }
        
        .btn:active {
            transform: translateY(4px);
            box-shadow: none;
        }

        .btn-start {
            background: var(--gold);
            color: var(--primary-red);
        }
        
        .btn-stop {
            background: var(--primary-red);
            color: #fff;
            border: 2px solid #fff;
            display: none;
        }

        .btn-settings {
            padding: 10px 20px;
            font-size: 1rem;
            background: rgba(255,255,255,0.2);
            color: #fff;
        }

        .batch-select {
            padding: 10px;
            border-radius: 10px;
            border: 2px solid var(--gold);
            background: transparent;
            color: var(--gold);
            font-size: 1.2rem;
            font-weight: bold;
        }
        .batch-select option {
            background: var(--dark-red);
            color: #fff;
        }

        /* å¼¹çª—é¢æ¿ */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 100;
            display: none;
            justify-content: center;
            align-items: center;
        }

        .modal {
            background: #fff;
            color: #333;
            width: 90%;
            max-width: 800px;
            border-radius: 15px;
            padding: 0;
            max-height: 85vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            box-shadow: 0 0 30px rgba(0,0,0,0.5);
        }

        .modal-header {
            background: var(--primary-red);
            color: #fff;
            padding: 15px 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 { margin: 0; }
        
        .close-btn {
            background: none;
            border: none;
            color: #fff;
            font-size: 1.5rem;
            cursor: pointer;
        }

        .modal-body {
            padding: 20px;
            overflow-y: auto;
        }

        .tabs {
            display: flex;
            border-bottom: 2px solid #ddd;
            margin-bottom: 20px;
        }

        .tab {
            padding: 10px 20px;
            cursor: pointer;
            font-weight: bold;
            color: #666;
        }

        .tab.active {
            color: var(--primary-red);
            border-bottom: 3px solid var(--primary-red);
        }

        /* è®¾ç½®è¡¨å• */
        .form-group { margin-bottom: 20px; }
        .form-label { display: block; margin-bottom: 8px; font-weight: bold; }
        .form-control {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1rem;
        }
        textarea.form-control { min-height: 150px; resize: vertical; }

        .btn-primary {
            background: var(--primary-red);
            color: #fff;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        .btn-danger {
            background: #dc3545;
            color: #fff;
            padding: 5px 10px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.8rem;
        }

        /* åˆ—è¡¨è¡¨æ ¼ */
        .data-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .data-table th, .data-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        .data-table th { background: #f8f9fa; color: #333; }
        
        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.85rem;
        }
        .status-unwon { background: #e9ecef; color: #666; }
        .status-won { background: #d4edda; color: #155724; }

        .prize-row {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            align-items: center;
        }

        /* ç²’å­åŠ¨ç”» Canvas */
        #confetti-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 50;
        }

        /* 3Dåå­—èƒŒæ™¯ Canvas */
        #bg-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
        }
        
        /* è°ƒæ•´åŸæœ‰èƒŒæ™¯å±‚çº§ */
        .bg-pattern {
            z-index: 0;
            opacity: 0.05; /* é™ä½åŸæœ‰çº¹ç†é€æ˜åº¦ */
        }
    </style>
</head>
<body>

    <canvas id="bg-canvas"></canvas>
    <canvas id="confetti-canvas"></canvas>

    <div class="bg-pattern"></div>
    <div class="lantern left"></div>
    <div class="lantern right"></div>

    <div class="container">
        <header>
            <h1>ğŸ‰ æ–°æ˜¥å˜‰å¹´å Â· å¹¸è¿å¤§æŠ½å¥– ğŸ‰</h1>
            <div class="subtitle">Fair, Just, and Joyous Lucky Draw</div>
        </header>

        <div class="main-stage">
            <div class="prize-selector" id="prizeListDisplay">
                <!-- å¥–å“åˆ—è¡¨å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
            </div>

            <div class="rolling-display" id="rollingDisplay">
                å‡†å¤‡å¼€å§‹
            </div>

            <div class="winners-grid" id="winnersGrid">
                <!-- ä¸­å¥–ç»“æœå±•ç¤º -->
            </div>
        </div>

        <div class="controls">
            <select class="batch-select" id="batchSizeSelect">
                <option value="1">æŠ½ 1 äºº</option>
                <option value="3">æŠ½ 3 äºº</option>
                <option value="5">æŠ½ 5 äºº</option>
                <option value="10">æŠ½ 10 äºº</option>
            </select>
            
            <button class="btn btn-start" id="startBtn">å¼€å§‹æŠ½å¥–</button>
            <button class="btn btn-stop" id="stopBtn">åœæ­¢ !</button>
            
            <button class="btn btn-settings" id="settingsBtn">âš™ï¸ è®¾ç½® / åå•</button>
        </div>
    </div>

    <!-- è®¾ç½®å¼¹çª— -->
    <div class="modal-overlay" id="settingsModal">
        <div class="modal">
            <div class="modal-header">
                <h2>âš™ï¸ æŠ½å¥–ç®¡ç†</h2>
                <button class="close-btn" id="closeSettings">&times;</button>
            </div>
            <div class="modal-body">
                <div class="tabs">
                    <div class="tab active" data-tab="participants">äººå‘˜ç®¡ç†</div>
                    <div class="tab" data-tab="prizes">å¥–å“è®¾ç½®</div>
                    <div class="tab" data-tab="results">äººå‘˜çŠ¶æ€</div>
                </div>

                <!-- äººå‘˜ç®¡ç† -->
                <div id="tab-participants" class="tab-content">
                    <div class="form-group">
                        <label class="form-label">å¯¼å…¥åå• (æ¯è¡Œä¸€ä¸ªå§“å)</label>
                        <textarea class="form-control" id="namesInput" placeholder="å¼ ä¸‰&#10;æå››&#10;ç‹äº”"></textarea>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <div>
                            <span>å½“å‰æ€»äººæ•°: <strong id="totalCount">0</strong></span>
                            <span style="margin-left: 20px;">å¾…æŠ½å¥–: <strong id="remainCount">0</strong></span>
                        </div>
                        <div>
                            <button class="btn-primary" id="saveNamesBtn">ä¿å­˜åå•</button>
                            <button class="btn-danger" id="resetAllBtn" style="margin-left: 10px;">é‡ç½®æ‰€æœ‰çŠ¶æ€</button>
                        </div>
                    </div>
                </div>

                <!-- å¥–å“è®¾ç½® -->
                <div id="tab-prizes" class="tab-content" style="display: none;">
                    <div id="prizesContainer">
                        <!-- åŠ¨æ€ç”Ÿæˆå¥–å“è¾“å…¥è¡Œ -->
                    </div>
                    <button class="btn-primary" id="addPrizeBtn" style="margin-top: 10px;">+ æ·»åŠ å¥–å“</button>
                    <button class="btn-primary" id="savePrizesBtn" style="float: right; margin-top: 10px;">ä¿å­˜å¥–å“è®¾ç½®</button>
                </div>

                <!-- ä¸­å¥–ç»“æœ -->
                <div id="tab-results" class="tab-content" style="display: none;">
                    <div style="overflow-x: auto;">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>å§“å</th>
                                    <th>å¥–é¡¹</th>
                                    <th>ä¸­å¥–æ—¶é—´</th>
                                    <th>æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody id="resultsTableBody">
                                <!-- ç»“æœåˆ—è¡¨ -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        /**
         * çŠ¶æ€ç®¡ç†
         */
        const state = {
            users: [], // { name, id, prizeId: null | string, winTime: null }
            prizes: [], // { id, name, count, drawnCount }
            currentPrizeId: null,
            isRolling: false,
            batchSize: 1,
            timer: null
        };

        const STORAGE_KEY = 'lucky_draw_data';

        // åˆå§‹åŒ–é»˜è®¤æ•°æ®
        const defaultPrizes = [
            { id: 'p1', name: 'ç‰¹ç­‰å¥–', count: 1, drawnCount: 0 },
            { id: 'p2', name: 'ä¸€ç­‰å¥–', count: 3, drawnCount: 0 },
            { id: 'p3', name: 'äºŒç­‰å¥–', count: 5, drawnCount: 0 },
            { id: 'p4', name: 'ä¸‰ç­‰å¥–', count: 10, drawnCount: 0 }
        ];

        // DOM å…ƒç´ 
        const el = {
            startBtn: document.getElementById('startBtn'),
            stopBtn: document.getElementById('stopBtn'),
            settingsBtn: document.getElementById('settingsBtn'),
            closeSettings: document.getElementById('closeSettings'),
            settingsModal: document.getElementById('settingsModal'),
            rollingDisplay: document.getElementById('rollingDisplay'),
            winnersGrid: document.getElementById('winnersGrid'),
            prizeListDisplay: document.getElementById('prizeListDisplay'),
            batchSizeSelect: document.getElementById('batchSizeSelect'),
            namesInput: document.getElementById('namesInput'),
            saveNamesBtn: document.getElementById('saveNamesBtn'),
            resetAllBtn: document.getElementById('resetAllBtn'),
            totalCount: document.getElementById('totalCount'),
            remainCount: document.getElementById('remainCount'),
            prizesContainer: document.getElementById('prizesContainer'),
            addPrizeBtn: document.getElementById('addPrizeBtn'),
            savePrizesBtn: document.getElementById('savePrizesBtn'),
            resultsTableBody: document.getElementById('resultsTableBody'),
            tabs: document.querySelectorAll('.tab'),
            tabContents: document.querySelectorAll('.tab-content'),
            confettiCanvas: document.getElementById('confetti-canvas')
        };

        // éŸ³æ•ˆ (å¯é€‰ï¼Œè¿™é‡Œä½¿ç”¨ç®€å•çš„Audio Contextæˆ–è€…ä¸åŠ )
        
        /**
         * åˆå§‹åŒ–
         */
        function init() {
            loadData();
            renderUI();
            setupEventListeners();
            animateConfetti(); // é¢„åŠ è½½ Canvas
            initBgAnimation(); // å¯åŠ¨3Dåå­—èƒŒæ™¯
        }

        // ... existing code ...

        /**
         * 3D åå­—èƒŒæ™¯ç‰¹æ•ˆ
         */
        const bgCanvas = document.getElementById('bg-canvas');
        const bgCtx = bgCanvas.getContext('2d');
        let nameStars = [];
        const STAR_COUNT = 150; // åå­—æ•°é‡
        const FOCAL_LENGTH = 400; // ç„¦è·ï¼Œæ§åˆ¶é€è§†æ„Ÿ
        
        class NameStar {
            constructor() {
                this.reset(true);
            }

            reset(initial = false) {
                // å¦‚æœæ²¡æœ‰ç”¨æˆ·æ•°æ®ï¼Œä½¿ç”¨é»˜è®¤å ä½
                const nameList = state.users.length > 0 ? state.users : [{name: 'ç¦'}, {name: 'ä¹'}, {name: 'å–œ'}];
                this.name = nameList[Math.floor(Math.random() * nameList.length)].name;
                
                // éšæœºåˆ†å¸ƒåœ¨è§†é‡èŒƒå›´å†…
                // x, y èŒƒå›´éœ€è¦æ¯”å±å¹•å¤§å¾ˆå¤šï¼Œè¿™æ ·é£è¿‡æ¥æ—¶æ‰ä¼šä»å››å‘¨åˆ’è¿‡
                this.x = (Math.random() - 0.5) * window.innerWidth * 4;
                this.y = (Math.random() - 0.5) * window.innerHeight * 4;
                
                // zè½´æ·±åº¦: åˆå§‹æ—¶éšæœºåˆ†å¸ƒåœ¨è¿œè¿‘ï¼Œé‡ç½®æ—¶å›åˆ°æœ€è¿œå¤„
                this.z = initial ? Math.random() * 2000 : 2000;
                
                this.speed = 5 + Math.random() * 5; // ç§»åŠ¨é€Ÿåº¦
                this.color = '#FFFACD';
            }

            update() {
                this.z -= this.speed;
                
                // å¦‚æœé£è¿‡å¤´äº†ï¼ˆz <= 0ï¼‰ï¼Œé‡ç½®åˆ°è¿œå¤„
                if (this.z <= 10) {
                    this.reset();
                }
            }

            draw() {
                if (!this.name) return;

                // 3D æŠ•å½±å…¬å¼
                const scale = FOCAL_LENGTH / (FOCAL_LENGTH + this.z); // zè¶Šå°(è¶Šè¿‘)ï¼Œscaleè¶Šå¤§
                
                // å±å¹•ä¸­å¿ƒåæ ‡
                const cx = bgCanvas.width / 2;
                const cy = bgCanvas.height / 2;

                const x2d = cx + this.x * scale;
                const y2d = cy + this.y * scale;

                // ç®€å•çš„è§†é”¥è£å‰ª
                if (x2d < -100 || x2d > bgCanvas.width + 100 || y2d < -100 || y2d > bgCanvas.height + 100) {
                    // å¦‚æœè¿˜åœ¨å¾ˆè¿œçš„åœ°æ–¹å°±å‡ºç•Œäº†ï¼Œä¸éœ€è¦é‡ç½®ï¼Œç»§ç»­é£
                    // å¦‚æœå¾ˆè¿‘äº†å‡ºç•Œï¼Œå¯ä»¥é‡ç½®ä»¥èŠ‚çœèµ„æº? å…¶å®ä¸ç”¨ï¼Œz<=10ä¼šè‡ªåŠ¨é‡ç½®
                    return; 
                }

                // é€æ˜åº¦éšè·ç¦»å˜åŒ–ï¼šè¿œå¤„é€æ˜ï¼Œè¿‘å¤„æ¸…æ™°ï¼Œæè¿‘å¤„æ¶ˆå¤±
                // z: 2000 -> 0
                // alpha: 0 -> 1 -> 0
                let alpha = 1;
                if (this.z > 1500) {
                    alpha = 1 - (this.z - 1500) / 500;
                } else if (this.z < 200) {
                    alpha = this.z / 200;
                }
                
                // é™åˆ¶ alpha èŒƒå›´
                alpha = Math.max(0, Math.min(1, alpha * 0.4)); // *0.4 é™ä½æ•´ä½“äº®åº¦ï¼Œä¸è¦å¤ªæŠ¢çœ¼

                bgCtx.save();
                bgCtx.translate(x2d, y2d);
                
                // å­—ä½“å¤§å°éšè·ç¦»å˜åŒ–
                const fontSize = Math.max(10, 40 * scale);
                bgCtx.font = `bold ${fontSize}px "Microsoft YaHei"`;
                bgCtx.fillStyle = `rgba(255, 250, 205, ${alpha})`;
                bgCtx.textAlign = 'center';
                bgCtx.textBaseline = 'middle';
                
                bgCtx.fillText(this.name, 0, 0);
                bgCtx.restore();
            }
        }

        function initBgAnimation() {
            // å“åº” resize
            const resizeBg = () => {
                bgCanvas.width = window.innerWidth;
                bgCanvas.height = window.innerHeight;
            };
            window.addEventListener('resize', resizeBg);
            resizeBg();

            // åˆ›å»ºç²’å­
            nameStars = [];
            for(let i=0; i<STAR_COUNT; i++) {
                nameStars.push(new NameStar());
            }

            animateBg();
        }

        function animateBg() {
            bgCtx.clearRect(0, 0, bgCanvas.width, bgCanvas.height);
            
            nameStars.forEach(star => {
                star.update();
                star.draw();
            });

            requestAnimationFrame(animateBg);
        }

        function loadData() {
            const stored = localStorage.getItem(STORAGE_KEY);
            if (stored) {
                const data = JSON.parse(stored);
                state.users = data.users || [];
                state.prizes = data.prizes || defaultPrizes;
            } else {
                state.prizes = defaultPrizes;
                // Add demo users
                const demoNames = [
                    "å¼ ä¸‰", "æå››", "ç‹äº”", "èµµå…­", "å­™ä¸ƒ", "å‘¨å…«", "å´ä¹", "éƒ‘å",
                    "åˆ˜ä¸€", "é™ˆäºŒ", "æ¨ä¸‰", "é»„å››", "æœ±äº”", "å¾å…­", "ä½•ä¸ƒ", "é©¬å…«",
                    "ç½—ä¹", "æ¢å", "å®‹ä¸€", "å”äºŒ", "è®¸ä¸‰", "éŸ©å››", "é‚“äº”", "æ›¹å…­",
                    "å½­ä¸ƒ", "æ›¾å…«", "è§ä¹", "ç”°å", "è‘£ä¸€", "è¢äºŒ"
                ];
                state.users = demoNames.map(name => ({
                    name,
                    id: Date.now() + Math.random(),
                    prizeId: null
                }));
            }
            
            if (state.prizes.length > 0) {
                state.currentPrizeId = state.prizes[0].id;
            }
        }

        function saveData() {
            localStorage.setItem(STORAGE_KEY, JSON.stringify({
                users: state.users,
                prizes: state.prizes
            }));
        }

        /**
         * UI æ¸²æŸ“é€»è¾‘
         */
        function renderUI() {
            renderPrizeSelector();
            renderSettings();
            updateStats();
        }

        function renderPrizeSelector() {
            el.prizeListDisplay.innerHTML = '';
            state.prizes.forEach(prize => {
                const card = document.createElement('div');
                card.className = `prize-card ${state.currentPrizeId === prize.id ? 'active' : ''}`;
                const percent = Math.min(100, (prize.drawnCount / prize.count) * 100);
                
                card.innerHTML = `
                    <div class="prize-name">${prize.name}</div>
                    <div class="prize-count">${prize.drawnCount} / ${prize.count}</div>
                    <div class="prize-progress" style="width: ${percent}%"></div>
                `;
                
                card.onclick = () => {
                    if (state.isRolling) return;
                    state.currentPrizeId = prize.id;
                    renderPrizeSelector();
                    el.rollingDisplay.textContent = `å‡†å¤‡æŠ½å–: ${prize.name}`;
                    el.rollingDisplay.style.display = 'flex';
                    el.winnersGrid.style.display = 'none';
                };
                el.prizeListDisplay.appendChild(card);
            });

            // æ›´æ–°ä¸»æ˜¾ç¤ºåŒºçš„é»˜è®¤æ–‡æœ¬
            const currentPrize = state.prizes.find(p => p.id === state.currentPrizeId);
            if (!state.isRolling && currentPrize) {
                el.rollingDisplay.textContent = `å‡†å¤‡æŠ½å–: ${currentPrize.name}`;
            }
        }

        function updateStats() {
            const unwon = state.users.filter(u => !u.prizeId).length;
            el.totalCount.textContent = state.users.length;
            el.remainCount.textContent = unwon;
            el.namesInput.value = state.users.map(u => u.name).join('\n');
            renderResultsTable();
        }

        /**
         * æŠ½å¥–æ ¸å¿ƒé€»è¾‘
         */
        function startLottery() {
            const currentPrize = state.prizes.find(p => p.id === state.currentPrizeId);
            if (!currentPrize) return alert('è¯·å…ˆé€‰æ‹©å¥–å“');
            
            const remainingPrizeCount = currentPrize.count - currentPrize.drawnCount;
            if (remainingPrizeCount <= 0) return alert('è¯¥å¥–å“å·²æŠ½å®Œï¼');

            const candidates = state.users.filter(u => !u.prizeId);
            if (candidates.length === 0) return alert('æ²¡æœ‰äººå¯ä»¥æŠ½äº†ï¼');

            state.isRolling = true;
            state.batchSize = parseInt(el.batchSizeSelect.value);
            
            // åˆ‡æ¢æŒ‰é’®çŠ¶æ€
            el.startBtn.style.display = 'none';
            el.stopBtn.style.display = 'block';
            el.rollingDisplay.style.display = 'flex';
            el.winnersGrid.style.display = 'none';
            el.settingsBtn.disabled = true;

            // å¼€å§‹æ»šåŠ¨åŠ¨ç”»
            let frame = 0;
            state.timer = setInterval(() => {
                // éšæœºæ˜¾ç¤ºåå­—
                const randomName = candidates[Math.floor(Math.random() * candidates.length)].name;
                el.rollingDisplay.innerHTML = `<div class="rolling-name">${randomName}</div>`;
                frame++;
            }, 50); // 50ms åˆ·æ–°ä¸€æ¬¡
        }

        function stopLottery() {
            clearInterval(state.timer);
            state.isRolling = false;
            
            // çœŸæ­£çš„æŠ½å¥–é€»è¾‘
            const currentPrize = state.prizes.find(p => p.id === state.currentPrizeId);
            const candidates = state.users.filter(u => !u.prizeId);
            const remainingPrizeCount = currentPrize.count - currentPrize.drawnCount;
            
            // å®é™…æŠ½å–æ•°é‡ï¼šå– (è®¾ç½®çš„æ‰¹é‡, å‰©ä½™å¥–å“æ•°, å‰©ä½™äººæ•°) çš„æœ€å°å€¼
            const drawCount = Math.min(state.batchSize, remainingPrizeCount, candidates.length);
            
            // æ´—ç‰Œç®—æ³•éšæœºæŠ½å–
            const winners = [];
            for (let i = 0; i < drawCount; i++) {
                const randomIndex = Math.floor(Math.random() * candidates.length);
                const winner = candidates[randomIndex];
                // æ ‡è®°ä¸­å¥–
                winner.prizeId = currentPrize.id;
                winner.winTime = new Date().toLocaleString();
                winners.push(winner);
                // ä»å€™é€‰æ± ç§»é™¤ä»¥é˜²é‡å¤æŠ½ (æœ¬æ¬¡å¾ªç¯å†…)
                candidates.splice(randomIndex, 1);
            }

            // æ›´æ–°å¥–å“è®¡æ•°
            currentPrize.drawnCount += winners.length;
            
            // ä¿å­˜æ•°æ®
            saveData();
            updateStats();
            renderPrizeSelector();

            // æ˜¾ç¤ºç»“æœ
            showWinners(winners);

            // æ¢å¤æŒ‰é’®
            el.startBtn.style.display = 'block';
            el.stopBtn.style.display = 'none';
            el.settingsBtn.disabled = false;

            // è§¦å‘ç‰¹æ•ˆ
            fireConfetti();
        }

        function showWinners(winners) {
            el.rollingDisplay.style.display = 'none';
            el.winnersGrid.style.display = 'grid';
            el.winnersGrid.innerHTML = '';
            
            winners.forEach(w => {
                const div = document.createElement('div');
                div.className = 'winner-card';
                div.textContent = w.name;
                el.winnersGrid.appendChild(div);
            });
        }

        /**
         * è®¾ç½®ä¸äº‹ä»¶ç›‘å¬
         */
        function setupEventListeners() {
            el.startBtn.addEventListener('click', startLottery);
            el.stopBtn.addEventListener('click', stopLottery);
            
            el.settingsBtn.addEventListener('click', () => {
                el.settingsModal.style.display = 'flex';
                renderSettings();
            });
            
            el.closeSettings.addEventListener('click', () => el.settingsModal.style.display = 'none');
            
            // Tab åˆ‡æ¢
            el.tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    el.tabs.forEach(t => t.classList.remove('active'));
                    el.tabContents.forEach(c => c.style.display = 'none');
                    tab.classList.add('active');
                    document.getElementById(`tab-${tab.dataset.tab}`).style.display = 'block';
                });
            });

            // ä¿å­˜åå•
            el.saveNamesBtn.addEventListener('click', () => {
                const text = el.namesInput.value.trim();
                const names = text.split('\n').map(n => n.trim()).filter(n => n);
                // ä¿ç•™å·²ä¸­å¥–çŠ¶æ€ï¼Œæ›´æ–°åå•é€»è¾‘æ¯”è¾ƒå¤æ‚ã€‚
                // ç®€å•ç­–ç•¥ï¼šå®Œå…¨é‡ç½®ç”¨æˆ·åˆ—è¡¨ï¼Œæˆ–è€…åˆå¹¶ã€‚
                // è¿™é‡Œé‡‡ç”¨ï¼šå¦‚æœæ˜¯å…¨æ–°åå•ï¼Œåˆ™è¦†ç›–ï¼›å¦‚æœåå­—ç›¸åŒï¼Œå°è¯•ä¿ç•™IDï¼Ÿ
                // ç®€å•åšæ³•ï¼šè¦†ç›–æ¨¡å¼ (ä¼šä¸¢å¤±ä¸­å¥–çŠ¶æ€ï¼Œæ‰€ä»¥æç¤ºé‡ç½®)
                // ä¼˜åŒ–åšæ³•ï¼šæ ¹æ®åå­—å»é‡
                
                if(!confirm("ä¿å­˜å°†æ›´æ–°äººå‘˜åå•ï¼Œæ˜¯å¦ç»§ç»­ï¼Ÿ")) return;

                const newUsers = names.map(name => {
                    // å°è¯•æŸ¥æ‰¾ç°æœ‰ç”¨æˆ·ä»¥ä¿ç•™çŠ¶æ€
                    const exist = state.users.find(u => u.name === name);
                    return exist || { name, id: Date.now() + Math.random(), prizeId: null };
                });
                
                state.users = newUsers;
                saveData();
                updateStats();
                alert('åå•å·²æ›´æ–°');
            });

            // é‡ç½®
            el.resetAllBtn.addEventListener('click', () => {
                if(confirm('ç¡®å®šè¦é‡ç½®æ‰€æœ‰äººçš„ä¸­å¥–çŠ¶æ€å—ï¼Ÿè¿™å°†æ¸…ç©ºæ‰€æœ‰å¥–å“å‘æ”¾è®°å½•ã€‚')) {
                    state.users.forEach(u => {
                        u.prizeId = null;
                        u.winTime = null;
                    });
                    state.prizes.forEach(p => p.drawnCount = 0);
                    saveData();
                    updateStats();
                    renderPrizeSelector();
                    alert('å·²é‡ç½®');
                }
            });

            // æ·»åŠ å¥–å“
            el.addPrizeBtn.addEventListener('click', () => {
                const id = 'p' + Date.now();
                state.prizes.push({ id, name: 'æ–°å¥–å“', count: 1, drawnCount: 0 });
                renderPrizesSetting();
            });

            // ä¿å­˜å¥–å“
            el.savePrizesBtn.addEventListener('click', () => {
                // æ”¶é›†DOMæ•°æ®
                const rows = document.querySelectorAll('.prize-row');
                const newPrizes = [];
                rows.forEach(row => {
                    const id = row.dataset.id;
                    const name = row.querySelector('.p-name').value;
                    const count = parseInt(row.querySelector('.p-count').value);
                    const original = state.prizes.find(p => p.id === id);
                    
                    newPrizes.push({
                        id,
                        name,
                        count,
                        drawnCount: original ? original.drawnCount : 0
                    });
                });
                state.prizes = newPrizes;
                saveData();
                renderPrizeSelector();
                alert('å¥–å“è®¾ç½®å·²ä¿å­˜');
            });
        }

        function renderSettings() {
            renderPrizesSetting();
            renderResultsTable();
        }

        function renderPrizesSetting() {
            el.prizesContainer.innerHTML = '';
            state.prizes.forEach(p => {
                const row = document.createElement('div');
                row.className = 'prize-row';
                row.dataset.id = p.id;
                row.innerHTML = `
                    <input type="text" class="form-control p-name" value="${p.name}" style="flex:2">
                    <input type="number" class="form-control p-count" value="${p.count}" min="1" style="flex:1">
                    <button class="btn-danger" onclick="removePrize('${p.id}')">åˆ é™¤</button>
                `;
                el.prizesContainer.appendChild(row);
            });
        }

        window.removePrize = function(id) {
            state.prizes = state.prizes.filter(p => p.id !== id);
            renderPrizesSetting();
        };
        
        window.resetWinner = function(userId) {
            const user = state.users.find(u => u.id == userId); // loose match for ID
            if (user && user.prizeId) {
                const prize = state.prizes.find(p => p.id === user.prizeId);
                if (prize) prize.drawnCount--;
                user.prizeId = null;
                user.winTime = null;
                saveData();
                renderResultsTable();
                updateStats();
                renderPrizeSelector();
            }
        };

        function renderResultsTable() {
            // Sort: Winners first, then by win time (newest first), then by name
            const allUsers = [...state.users].sort((a, b) => {
                if (a.prizeId && !b.prizeId) return -1;
                if (!a.prizeId && b.prizeId) return 1;
                if (a.prizeId && b.prizeId) {
                     return new Date(b.winTime) - new Date(a.winTime);
                }
                return 0;
            });

            el.resultsTableBody.innerHTML = allUsers.map(u => {
                const prize = state.prizes.find(p => p.id === u.prizeId);
                const statusHtml = prize 
                    ? `<span class="status-badge status-won">${prize.name}</span>`
                    : `<span class="status-badge status-unwon">æœªä¸­å¥–</span>`;
                
                const actionHtml = prize
                    ? `<button class="btn-danger" onclick="resetWinner('${u.id}')">å–æ¶ˆä¸­å¥–</button>`
                    : `-`;

                return `
                    <tr>
                        <td>${u.name}</td>
                        <td>${statusHtml}</td>
                        <td>${u.winTime || '-'}</td>
                        <td>${actionHtml}</td>
                    </tr>
                `;
            }).join('');
        }

        /**
         * ç¤¼èŠ±ç‰¹æ•ˆ (Simple Canvas Confetti)
         */
        const canvas = document.getElementById('confetti-canvas');
        const ctx = canvas.getContext('2d');
        let particles = [];
        let animationId;

        function resizeCanvas() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        }
        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();

        function createParticle() {
            return {
                x: Math.random() * canvas.width,
                y: Math.random() * canvas.height - canvas.height,
                color: ['#FFD700', '#FF0000', '#FFFFFF', '#FFA500'][Math.floor(Math.random() * 4)],
                size: Math.random() * 10 + 5,
                speedY: Math.random() * 5 + 2,
                speedX: Math.random() * 4 - 2,
                rotation: Math.random() * 360,
                rotationSpeed: Math.random() * 10 - 5
            };
        }

        function animateConfetti() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            for (let i = particles.length - 1; i >= 0; i--) {
                const p = particles[i];
                p.y += p.speedY;
                p.x += p.speedX;
                p.rotation += p.rotationSpeed;
                
                ctx.save();
                ctx.translate(p.x, p.y);
                ctx.rotate(p.rotation * Math.PI / 180);
                ctx.fillStyle = p.color;
                ctx.fillRect(-p.size/2, -p.size/2, p.size, p.size);
                ctx.restore();

                if (p.y > canvas.height) {
                    particles.splice(i, 1);
                }
            }

            if (particles.length > 0) {
                requestAnimationFrame(animateConfetti);
            }
        }

        function fireConfetti() {
            for (let i = 0; i < 150; i++) {
                particles.push(createParticle());
            }
            animateConfetti();
        }

        // å¯åŠ¨
        init();

    </script>
</body>
</html>
