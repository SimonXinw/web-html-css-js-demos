<!DOCTYPE html>
<!--
 @license
 Copyright 2019 Google LLC. All Rights Reserved.
 SPDX-License-Identifier: Apache-2.0
-->
<html>
  <head>
    <title>Distance Matrix Service</title>
    <script>
      /**
       * @license
       * Copyright 2019 Google LLC. All Rights Reserved.
       * SPDX-License-Identifier: Apache-2.0
       */
      function initMap() {
        const bounds = new google.maps.LatLngBounds();
        const markersArray = [];
        const map = new google.maps.Map(document.getElementById("map"), {
          center: { lat: 39.8283, lng: -98.5795 }, // 中心点设在美国
          zoom: 5, // 拉远一点，方便看
        });

        const geocoder = new google.maps.Geocoder();
        const service = new google.maps.DistanceMatrixService();

        const origins = [
          { lat: 41.3958794, lng: -72.8567218 },
          // "642 Kakala Street, Kapolei, Hawaii, US",
        ];

        // 目标点 A 诺伍德
        const destination = { lat: 42.1861968, lng: -71.19672059999999 };

        const request = {
          origins,
          destinations: [destination],
          travelMode: google.maps.TravelMode.DRIVING,
          unitSystem: google.maps.UnitSystem.IMPERIAL,
          avoidHighways: false,
          avoidTolls: false,
        };

        document.getElementById("request").innerText = JSON.stringify(
          request,
          null,
          2
        );

        service.getDistanceMatrix(request).then((response) => {
          document.getElementById("response").innerText = JSON.stringify(
            response,
            null,
            2
          );

          const originList = response.originAddresses;
          const destinationList = response.destinationAddresses;

          deleteMarkers(markersArray);

          const showGeocodedAddressOnMap = (asDestination) => {
            return ({ results }) => {
              map.fitBounds(bounds.extend(results[0].geometry.location));
              markersArray.push(
                new google.maps.Marker({
                  map,
                  position: results[0].geometry.location,
                  label: asDestination ? "D" : "O",
                })
              );
            };
          };

          for (let i = 0; i < originList.length; i++) {
            const results = response.rows[i].elements[0];

            if (results.status === "OK") {
              console.log(
                `${originList[i]} 到 ${destinationList[0]}: ${results.distance.text}, ${results.duration.text}`
              );
            } else {
              console.warn(
                `${originList[i]} 到 ${destinationList[0]} 驾车路线不可达，计算直线距离中...`
              );
              // 驾车不可达，计算直线距离
              calculateStraightLineDistance(originList[i], destinationList[0]);
            }

            geocoder
              .geocode({ address: originList[i] })
              .then(showGeocodedAddressOnMap(false));
          }

          geocoder
            .geocode({ address: destinationList[0] })
            .then(showGeocodedAddressOnMap(true));
        });

        // 计算直线距离函数（Haversine公式）
        function calculateStraightLineDistance(
          originAddress,
          destinationAddress
        ) {
          Promise.all([
            geocoder.geocode({ address: originAddress }),
            geocoder.geocode({ address: destinationAddress }),
          ]).then(([originResult, destinationResult]) => {
            if (
              originResult.results.length > 0 &&
              destinationResult.results.length > 0
            ) {
              const originLoc = originResult.results[0].geometry.location;
              const destLoc = destinationResult.results[0].geometry.location;

              const distance = haversineDistance(
                { lat: originLoc.lat(), lng: originLoc.lng() },
                { lat: destLoc.lat(), lng: destLoc.lng() }
              );

              console.log(
                `${originAddress} 到 ${destinationAddress} 的直线距离为约 ${distance.toFixed(
                  2
                )} km`
              );
            } else {
              console.error("无法获取地址的经纬度");
            }
          });
        }

        // Haversine公式，地球半径直线距离计算公式
        function haversineDistance(coord1, coord2) {
          const R = 6371; // 地球半径 (km)
          const lat1 = (coord1.lat * Math.PI) / 180;
          const lat2 = (coord2.lat * Math.PI) / 180;
          const deltaLat = lat2 - lat1;
          const deltaLng = ((coord2.lng - coord1.lng) * Math.PI) / 180;

          const a =
            Math.sin(deltaLat / 2) ** 2 +
            Math.cos(lat1) * Math.cos(lat2) * Math.sin(deltaLng / 2) ** 2;
          const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));

          return R * c;
        }

        function deleteMarkers(markersArray) {
          for (let marker of markersArray) {
            marker.setMap(null);
          }
          markersArray.length = 0;
        }
      }

      window.initMap = initMap;
    </script>
    <style>
      /**
       * @license
       * Copyright 2019 Google LLC. All Rights Reserved.
       * SPDX-License-Identifier: Apache-2.0
       */
      /* Optional: Makes the sample page fill the window. */
      html,
      body {
        height: 100%;
        margin: 0;
        padding: 0;
      }

      #container {
        height: 100%;
        display: flex;
      }

      #sidebar {
        flex-basis: 15rem;
        flex-grow: 1;
        padding: 1rem;
        max-width: 30rem;
        height: 100%;
        box-sizing: border-box;
        overflow: auto;
      }

      #map {
        flex-basis: 0;
        flex-grow: 4;
        height: 100%;
      }

      #sidebar {
        flex-direction: column;
      }
    </style>
  </head>
  <body>
    <div id="container">
      <div id="map"></div>
      <div id="sidebar">
        <h3 style="flex-grow: 0">Request</h3>
        <pre style="flex-grow: 1" id="request"></pre>
        <h3 style="flex-grow: 0">Response</h3>
        <pre style="flex-grow: 1" id="response"></pre>
      </div>
    </div>
    <script
      src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAOavTIWq4qRgppoQYzktYy5j0Yshb3HRI-111&callback=initMap&v=weekly&solution_channel=GMP_CCS_distancematrix_v2"
      defer
    ></script>
  </body>
</html>
