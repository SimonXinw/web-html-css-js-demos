<!DOCTYPE html>
<!--
 @license
 Copyright 2019 Google LLC. All Rights Reserved.
 SPDX-License-Identifier: Apache-2.0
-->
<html>
  <head>
    <title>Distance Matrix Service</title>
    <script>
      /**
       * @license
       * Copyright 2019 Google LLC. All Rights Reserved.
       * SPDX-License-Identifier: Apache-2.0
       */
      function initMap() {
        const bounds = new google.maps.LatLngBounds();
        const markersArray = [];
        const map = new google.maps.Map(document.getElementById("map"), {
          center: { lat: 35.8617, lng: 104.1954 }, // 中心点设在中国
          zoom: 4,
        });
        // initialize services

        const geocoder = new google.maps.Geocoder();
        const service = new google.maps.DistanceMatrixService();

        // build request
        // 多个起点
        const origins = [
          { lat: 31.224361, lng: 121.46917 }, // 上海
          "Guangzhou, China",
          "Shenzhen, China",
          "Xi'an, China",
        ];

        // 目标点 A
        const destination = "Beijing, China";

        const request = {
          origins,
          destinations: [destination], // 只有一个目标点
          travelMode: google.maps.TravelMode.DRIVING,
          unitSystem: google.maps.UnitSystem.METRIC,
          avoidHighways: false,
          avoidTolls: false,
        };

        // put request on page
        document.getElementById("request").innerText = JSON.stringify(
          request,
          null,
          2
        );

        service.getDistanceMatrix(request).then((response) => {
          // put response
          document.getElementById("response").innerText = JSON.stringify(
            response,
            null,
            2
          );

          // show on map
          const originList = response.originAddresses;
          const destinationList = response.destinationAddresses;

          deleteMarkers(markersArray);

          const showGeocodedAddressOnMap = (asDestination) => {
            return ({ results }) => {
              map.fitBounds(bounds.extend(results[0].geometry.location));
              markersArray.push(
                new google.maps.Marker({
                  map,
                  position: results[0].geometry.location,
                  label: asDestination ? "D" : "O",
                })
              );
            };
          };

          // 标记所有起点
          for (let i = 0; i < originList.length; i++) {
            const results = response.rows[i].elements;
            console.log(
              `${originList[i]} 到 ${destinationList[0]}: ${results[0].distance.text}, ${results[0].duration.text}`
            );

            geocoder
              .geocode({ address: originList[i] })
              .then(showGeocodedAddressOnMap(false));
          }

          // 标记目标点
          geocoder
            .geocode({ address: destinationList[0] })
            .then(showGeocodedAddressOnMap(true));
        });
      }

      function deleteMarkers(markersArray) {
        for (let i = 0; i < markersArray.length; i++) {
          markersArray[i].setMap(null);
        }
        markersArray.length = 0;
      }

      window.initMap = initMap;
    </script>
    <style>
      /**
       * @license
       * Copyright 2019 Google LLC. All Rights Reserved.
       * SPDX-License-Identifier: Apache-2.0
       */
      /* Optional: Makes the sample page fill the window. */
      html,
      body {
        height: 100%;
        margin: 0;
        padding: 0;
      }

      #container {
        height: 100%;
        display: flex;
      }

      #sidebar {
        flex-basis: 15rem;
        flex-grow: 1;
        padding: 1rem;
        max-width: 30rem;
        height: 100%;
        box-sizing: border-box;
        overflow: auto;
      }

      #map {
        flex-basis: 0;
        flex-grow: 4;
        height: 100%;
      }

      #sidebar {
        flex-direction: column;
      }
    </style>
  </head>
  <body>
    <div id="container">
      <div id="map"></div>
      <div id="sidebar">
        <h3 style="flex-grow: 0">Request</h3>
        <pre style="flex-grow: 1" id="request"></pre>
        <h3 style="flex-grow: 0">Response</h3>
        <pre style="flex-grow: 1" id="response"></pre>
      </div>
    </div>
    <script
      src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAOavTIWq4qRgppoQYzktYy5j0Yshb3HRI-111&callback=initMap&v=weekly&solution_channel=GMP_CCS_distancematrix_v2"
      defer
    ></script>
  </body>
</html>
